<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>TImp: Case Study: a Typed Imperative Language</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/qc.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://coq-zh.github.io/SF-zh/'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 4: QuickChick: Property-Based Testing in Coq</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>目录</a></li>
   <li class='section_name'><a href='coqindex.html'>索引</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">TImp: Case Study<span class="subtitle">a Typed Imperative Language</span></h1>

<div class="code">
</div>

<div class="code">

<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
Having covered the basics of QuickChick in the previous
    chapter, we are ready to dive into a more realistic case study: a
    typed variant of Imp, the simple imperative language introduced in
    <i>Logical Foundations</i>.

<div class="paragraph"> </div>

    The version of Imp presented there enforces a syntactic separation
    between boolean and arithmetic expressions: <span class="inlinecode"><span class="id" title="var">bexp</span></span> just ranges
    over boolean expressions, while <span class="inlinecode"><span class="id" title="var">aexp</span></span> ranges over arithmetic
    ones.  Moreover, variables are only allowed in <span class="inlinecode"><span class="id" title="var">aexp</span></span> and hence
    only take numeric values.  By contrast, in <i>Typed Imp</i> (TImp) we
    collapse the expression syntax and allow variables to range over
    both numbers and booleans. With the unified syntax, we introduce
    the notion of <i>well-typed</i> Imp expressions and programs (where
    every variable only ranges over values of a single type throughout
    the whole program).  We then give an operational semantics to TImp
    in the form of a (partial) evaluation function -- partial since,
    in the unified syntax, we can write nonsensical expressions such
    as <span class="inlinecode">0</span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" title="var">True</span></span>.

<div class="paragraph"> </div>

    A common mantra in functional programming is "well-typed programs
    cannot go wrong," and TImp is no exception. The <i>soundness</i>
    property for TImp will state that evaluating well-typed
    expressions and programs always succeeds.

<div class="paragraph"> </div>

    From the point of view of testing, soundness is interesting
    because it is a <i>conditional</i> property. As we saw in the previous
    chapter, testing such properties effectively requires custom
    generators.  In this chapter, we show how to scale the techniques
    for writing generators explained in <a href="QC.html"><span class="inlineref">QC</span></a> to more realistic
    generators for well-typed expressions and programs. In addition,
    we dicuss the need for custom shrinkers preserving invariants, a
    problem dual to that of custom generators. 
<div class="paragraph"> </div>

 Acknowledgement: We are grateful to Nicolas Koh for important
    contributions to an early version of this chapter. 
<div class="paragraph"> </div>

<a name="lab76"></a><h1 class="section">Identifiers, Types and Contexts</h1>

<div class="paragraph"> </div>

<a name="lab77"></a><h2 class="section">Identifiers</h2>

<div class="paragraph"> </div>

 For the type of identifiers of TImp we will use a wrapper around 
    plain natural numbers. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="id"><span class="id" title="inductive">id</span></a> :=<br/>
|  <a name="Id"><span class="id" title="constructor">Id</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>.<br/>
</div>

<div class="doc">
We will need one identifier-specific operation, <span class="inlinecode"><span class="id" title="tactic">fresh</span></span>: given any
    finite set of identifiers, we can produce one that is distinct
    from all other identifiers in the set.

<div class="paragraph"> </div>

    To compute a fresh <span class="inlinecode"><span class="id" title="var">id</span></span> given a list of <span class="inlinecode"><span class="id" title="var">id</span></span>s we can just produce
    the number that is 1 larger than the maximum element: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="max_elt"><span class="id" title="definition">max_elt</span></a> (<span class="id" title="var">al</span>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#al"><span class="id" title="variable">al</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ 0 <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#Id"><span class="id" title="constructor">Id</span></a> <span class="id" title="var">n'</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">)::</span></a><span class="id" title="var">al'</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#max"><span class="id" title="abbreviation">max</span></a> <span class="id" title="var">n'</span> (<a class="idref" href="TImp.html#max_elt"><span class="id" title="definition">max_elt</span></a> <span class="id" title="var">al'</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="fresh"><span class="id" title="definition">fresh</span></a> (<span class="id" title="var">al</span>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>) : <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#Id"><span class="id" title="constructor">Id</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> (<a class="idref" href="TImp.html#max_elt"><span class="id" title="definition">max_elt</span></a> <a class="idref" href="TImp.html#al"><span class="id" title="variable">al</span></a>)).<br/>
</div>

<div class="doc">
We will also need a way of testing for equality, which we can 
    derive with the standard <span class="inlinecode"><span class="id" title="var">dec_eq</span></span> tactic. 
</div>
<div class="code">
<span class="id" title="keyword">Instance</span> <a name="eq_id_dec"><span class="id" title="instance">eq_id_dec</span></a> (<span class="id" title="var">x<sub>1</sub></span> <span class="id" title="var">x<sub>2</sub></span> : <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>) : <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#x<sub>1</sub>"><span class="id" title="variable">x<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#x<sub>2</sub>"><span class="id" title="variable">x<sub>2</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="var">dec_eq</span>. <span class="id" title="keyword">Defined</span>.<br/>
</div>

<div class="doc">
One advantage of using natural numbers as identifiers is that 
    we can take advantage of the <span class="inlinecode"><span class="id" title="keyword">Show</span></span> instance of <span class="inlinecode"><span class="id" title="var">nat</span></span> to print 
    them. 
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;BCP:&nbsp;Print&nbsp;them&nbsp;as&nbsp;"A",&nbsp;"B",&nbsp;etc.&nbsp;&nbsp;Or&nbsp;maybe&nbsp;"X<sub>1</sub>",&nbsp;"X<sub>2</sub>",&nbsp;etc.&nbsp;*)</span><br/>
<span class="id" title="keyword">Instance</span> <a name="show_id"><span class="id" title="instance">show_id</span></a> : <span class="id" title="class">Show</span> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> :=<br/>
&nbsp;&nbsp;{ <span class="id" title="method">show</span> <span class="id" title="var">x</span> := <span class="id" title="keyword">let</span> '(<a class="idref" href="TImp.html#Id"><span class="id" title="constructor">Id</span></a> <span class="id" title="var">n</span>) := <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="tactic">in</span> <span class="id" title="method">show</span> <span class="id" title="var">n</span> }.<br/>
</div>

<div class="doc">
To generate identifiers for TImp, we will not just generate
    arbitrary natural numbers. More often than not, we will need to
    generate a set of identifiers, or pick an identifier from such a
    set. If we represent a set as a list, we can do the former with a
    recursive function that generates <span class="inlinecode"><span class="id" title="var">n</span></span> fresh <span class="inlinecode"><span class="id" title="var">nat</span></span>s starting from
    the empty list. For the latter, we have QuickChick's <span class="inlinecode"><span class="id" title="var">elems_</span></span>
    combinator. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="get_fresh_ids"><span class="id" title="definition">get_fresh_ids</span></a> <span class="id" title="var">n</span> <span class="id" title="var">l</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| 0 ⇒ <a class="idref" href="TImp.html#l"><span class="id" title="variable">l</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <span class="id" title="var">n'</span> ⇒ <a class="idref" href="TImp.html#get_fresh_ids"><span class="id" title="definition">get_fresh_ids</span></a> <span class="id" title="var">n'</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#fresh"><span class="id" title="definition">fresh</span></a> <a class="idref" href="TImp.html#l"><span class="id" title="variable">l</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#l"><span class="id" title="variable">l</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a name="lab78"></a><h4 class="section">练习：2 星, standard (genId)</h4>
 Write a <span class="inlinecode"><span class="id" title="var">Gen</span></span> instance for <span class="inlinecode"><span class="id" title="var">id</span></span> using the <span class="inlinecode"><span class="id" title="var">elems_</span></span>
    combinator and <span class="inlinecode"><span class="id" title="var">get_fresh_ids</span></span>.  
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span><br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 There remains the question of how to <span class="inlinecode"><span class="id" title="var">shrink</span></span> <span class="inlinecode"><span class="id" title="var">id</span></span>s. 
    We will answer that question when <span class="inlinecode"><span class="id" title="var">id</span></span>s are used later 
    in the chapter. For now, let's leave the <span class="inlinecode"><span class="id" title="var">Shrink</span></span> instance
    as a no-op.
 
</div>
<div class="code">
<span class="id" title="keyword">Instance</span> <a name="shrinkId"><span class="id" title="instance">shrinkId</span></a> : <span class="id" title="class">Shrink</span> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> :=<br/>
&nbsp;&nbsp;{ <span class="id" title="method">shrink</span> <span class="id" title="var">x</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a> }.<br/>
</div>

<div class="doc">
<a name="lab79"></a><h2 class="section">Types</h2>

<div class="paragraph"> </div>

 Here is the type of TImp types: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="ty"><span class="id" title="inductive">ty</span></a> := <a name="TBool"><span class="id" title="constructor">TBool</span></a> | <a name="TNat"><span class="id" title="constructor">TNat</span></a>.<br/>
</div>

<div class="doc">
That is, TImp has two kinds of values: booleans and natural
    numbers. 
<div class="paragraph"> </div>

 To use <span class="inlinecode"><span class="id" title="var">ty</span></span> in testing, we will need <span class="inlinecode"><span class="id" title="var">Arbitrary</span></span>, <span class="inlinecode"><span class="id" title="keyword">Show</span></span>, and
    <span class="inlinecode"><span class="id" title="var">Dec</span></span> instances. 
<div class="paragraph"> </div>

 In QC.v, we saw how to write such generators by hand.
    We also saw, however, that this process can largely be automated
    for simple inductive types (like <span class="inlinecode"><span class="id" title="var">ty</span></span>, <span class="inlinecode"><span class="id" title="var">nat</span></span>, <span class="inlinecode"><span class="id" title="var">list</span></span>, <span class="inlinecode"><span class="id" title="var">tree</span></span>, etc.).
    QuickChick provides a top-level vernacular command to derive such
    instances. 
</div>
<div class="code">

<br/>
<span class="id" title="var">Derive</span> (<span class="id" title="var">Arbitrary</span>, <span class="id" title="keyword">Show</span>) <span class="id" title="keyword">for</span> <span class="id" title="var">ty</span>.<br/>
<span class="comment">(*&nbsp;==&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;GenSizedty&nbsp;is&nbsp;defined<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Shrinkty&nbsp;is&nbsp;defined<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Showty&nbsp;is&nbsp;defined<br/>
*)</span><br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Check</span> <a class="idref" href="TImp.html#GenSizedty"><span class="id" title="instance">GenSizedty</span></a>.<br/>
<span class="comment">(*&nbsp;==&gt;&nbsp;GenSizedty&nbsp;:&nbsp;GenSized&nbsp;ty&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <a class="idref" href="TImp.html#Shrinkty"><span class="id" title="instance">Shrinkty</span></a>.<br/>
<span class="comment">(*&nbsp;==&gt;&nbsp;Shrinkty&nbsp;&nbsp;:&nbsp;Shrink&nbsp;ty&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <a class="idref" href="TImp.html#Showty"><span class="id" title="instance">Showty</span></a>.<br/>
<span class="comment">(*&nbsp;==&gt;&nbsp;Showty&nbsp;:&nbsp;Show&nbsp;ty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
</div>

<div class="doc">
Decidable equality instances are not yet derived fully
    automatically by QuickChick.  However, the boilerplate we have to
    write is largely straightforward. As we saw in the previous
    chapters, <span class="inlinecode"><span class="id" title="var">Dec</span></span> is a typeclass wrapper around ssreflect's
    <span class="inlinecode"><span class="id" title="var">decidable</span></span> and we can use the <span class="inlinecode"><span class="id" title="var">dec_eq</span></span> tactic to automate 
    the process. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Instance</span> <a name="eq_dec_ty"><span class="id" title="instance">eq_dec_ty</span></a> (<span class="id" title="var">x</span> <span class="id" title="var">y</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) : <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#y"><span class="id" title="variable">y</span></a>).<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="var">dec_eq</span>. <span class="id" title="keyword">Defined</span>.<br/>
</div>

<div class="doc">
<a name="lab80"></a><h2 class="section">List-Based Maps</h2>

<div class="paragraph"> </div>

 To encode typing environments (and, later on, states), we will
    need maps from identifiers to values. However, the function-based
    representation in the <i>Software Foundations</i> version of Imp is not
    well suited for testing: we need to be able to access the domain
    of the map, fold over it, and test for equality; these are all
    awkward to define for Coq functions. Therefore, we introduce a
    simple list-based map representation that uses <span class="inlinecode"><span class="id" title="var">id</span></span>s as the keys.

<div class="paragraph"> </div>

    The operations we need are:
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">empty</span></span> : To create the empty map.

</li>
<li> <span class="inlinecode"><span class="id" title="var">get</span></span> : To look up the binding of an element, if any.

</li>
<li> <span class="inlinecode"><span class="id" title="tactic">set</span></span> : To update the binding of an element.

</li>
<li> <span class="inlinecode"><span class="id" title="var">dom</span></span> : To get the list of keys in the map. 
</li>
</ul>

<div class="paragraph"> </div>

 The implementation of a map is a simple association list.  If a
    list contains multiple tuples with the same key, then the binding
    of the key in the map is the one that appears first in the list;
    that is, later bindings can be shadowed. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="Map"><span class="id" title="definition">Map</span></a> <span class="id" title="var">A</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>).<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" title="var">empty</span></span> map is the empty list. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="map_empty"><span class="id" title="definition">map_empty</span></a> {<span class="id" title="var">A</span>} : <a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> := <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a>.<br/>
</div>

<div class="doc">
To <span class="inlinecode"><span class="id" title="var">get</span></span> the binding of an identifier <span class="inlinecode"><span class="id" title="var">x</span></span>, we just need to walk 
    through the list and find the first <span class="inlinecode"><span class="id" title="var">cons</span></span> cell where the key 
    is equal to <span class="inlinecode"><span class="id" title="var">x</span></span>, if any. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="map_get"><span class="id" title="definition">map_get</span></a> {<span class="id" title="var">A</span>} (<span class="id" title="var">m</span> : <a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) <span class="id" title="var">x</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">k</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">m'</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">k</span> <span class="id" title="notation">?</span> <span class="id" title="keyword">then</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> <span class="id" title="keyword">else</span> <a class="idref" href="TImp.html#map_get"><span class="id" title="definition">map_get</span></a> <span class="id" title="var">m'</span> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
To <span class="inlinecode"><span class="id" title="tactic">set</span></span> the binding of an identifier, we just need to <span class="inlinecode"><span class="id" title="var">cons</span></span> 
    it at the front of the list. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="map_set"><span class="id" title="definition">map_set</span></a> {<span class="id" title="var">A</span>} (<span class="id" title="var">m</span>:<a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) (<span class="id" title="var">x</span>:<a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>) (<span class="id" title="var">v</span>:<a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) : <a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="TImp.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a>.<br/>
</div>

<div class="doc">
Finally, the domain of a map is just the set of its keys. 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <a name="map_dom"><span class="id" title="definition">map_dom</span></a> {<span class="id" title="var">A</span>} (<span class="id" title="var">m</span>:<a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">k'</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">m'</span> ⇒ <span class="id" title="var">k'</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#map_dom"><span class="id" title="definition">map_dom</span></a> <span class="id" title="var">m'</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
We next introduce a simple inductive relation, <span class="inlinecode"><span class="id" title="var">bound_to</span></span> <span class="inlinecode"><span class="id" title="var">m</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span>, that 
    holds precisely when the binding of some identifier <span class="inlinecode"><span class="id" title="var">x</span></span> is equal to <span class="inlinecode"><span class="id" title="var">a</span></span> in 
    <span class="inlinecode"><span class="id" title="var">m</span></span> 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="bound_to"><span class="id" title="inductive">bound_to</span></a> {<span class="id" title="var">A</span>} : <a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <span class="id" title="var">A</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="var">A</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="Bind"><span class="id" title="constructor">Bind</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">x</span> <span class="id" title="var">m</span> <span class="id" title="var">a</span>, <a class="idref" href="TImp.html#map_get"><span class="id" title="definition">map_get</span></a> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="TImp.html#a"><span class="id" title="variable">a</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#a"><span class="id" title="variable">a</span></a>.<br/>
</div>

<div class="doc">
<a name="lab81"></a><h2 class="section">Deciding <span class="inlinecode"><span class="id" title="var">bound_to</span></span> (optional)</h2>

<div class="paragraph"> </div>

 We can now decide whether <span class="inlinecode"><span class="id" title="var">bound_to</span></span> <span class="inlinecode"><span class="id" title="var">m</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span> holds for a given
    arrangement of <span class="inlinecode"><span class="id" title="var">m</span></span>, <span class="inlinecode"><span class="id" title="var">x</span></span> and <span class="inlinecode"><span class="id" title="var">a</span></span>.  On a first reading, you may
    prefer to skip the next few paragraphs (until the start of the
    <span class="inlinecode"><span class="id" title="keyword">Context</span></span> subsection), which deal with partially automating the
    proofs for such instances. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Instance</span> <a name="dec_bound_to"><span class="id" title="instance">dec_bound_to</span></a> {<span class="id" title="var">A</span> : <span class="id" title="keyword">Type</span>} <span class="id" title="var">Gamma</span> <span class="id" title="var">x</span> (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" title="var">D</span> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span> <span class="id" title="var">y</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>), <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#y"><span class="id" title="variable">y</span></a>)} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ssr.ssrbool.html#decidable"><span class="id" title="definition">ssrbool.decidable</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#map_get"><span class="id" title="definition">map_get</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">x</span>) <span class="id" title="var">eqn</span>:<span class="id" title="var">Get</span>.<br/>
</div>

<div class="doc">
After unfolding <span class="inlinecode"><span class="id" title="var">decidable</span></span> and destructing <span class="inlinecode"><span class="id" title="var">map_get</span></span> <span class="inlinecode"><span class="id" title="var">Gamma</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span>, we are
    left with two subgoals. In the first, we know that <span class="inlinecode"><span class="id" title="var">map_get</span></span> <span class="inlinecode"><span class="id" title="var">Gamma</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span>
    <span class="inlinecode"><span class="id" title="var">Some</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span> and effectively want to decide whether <span class="inlinecode"><span class="id" title="var">map_get</span></span> <span class="inlinecode"><span class="id" title="var">Gamma</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">Some</span></span>
    <span class="inlinecode"><span class="id" title="var">T</span></span> or not. Which means we need to decide whether <span class="inlinecode"><span class="id" title="var">a</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">T</span></span>. Thankfully,
    we can decide that using our hypothesis <span class="inlinecode"><span class="id" title="var">D</span></span>. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> (<span class="id" title="var">D</span> <span class="id" title="var">a</span> <span class="id" title="var">T</span>) <span class="id" title="keyword">as</span> [[<span class="id" title="var">Eq</span> | <span class="id" title="var">NEq</span>]]; <span class="id" title="tactic">subst</span>.<br/>
</div>

<div class="doc">
At this point, the first goal can be immediately decided positevely
    using constructor. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">left</span>. <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">auto</span>.<br/>
</div>

<div class="doc">
In the second subgoal, we can show that <span class="inlinecode"><span class="id" title="var">bound_to</span></span> doesn't hold. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">right</span>; <span class="id" title="tactic">intro</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">inversion</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="tactic">clear</span> <span class="id" title="var">Contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">congruence</span>.<br/>
</div>

<div class="doc">
Both of these tactic patterns are very common in non-trival <span class="inlinecode"><span class="id" title="var">Dec</span></span> 
    instances. It is worth we automating them a bit using LTac. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
A lot of the time, we can immediately decide a property positivly 
    using constructor applications. That is captured in <span class="inlinecode"><span class="id" title="var">solve_left</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">solve_left</span>  := <span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span> [<span class="id" title="tactic">left</span>; <span class="id" title="tactic">econstructor</span>; <span class="id" title="tactic">eauto</span>].<br/>
</div>

<div class="doc">
Much of the time, we can also immediately decide that a property
    <i>doesn't</i> hold by assuming it, doing inversion, and using
    <span class="inlinecode"><span class="id" title="tactic">congruence</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">solve_right</span> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">Contra</span> := <span class="id" title="tactic">fresh</span> "Contra" <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span> [<span class="id" title="tactic">right</span>; <span class="id" title="tactic">intro</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">inversion</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">subst</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">eauto</span>; <span class="id" title="tactic">congruence</span>].<br/>
</div>

<div class="doc">
We group both in a single tactic, which does nothing at all if 
    it fails to solve a goal, thanks to <span class="inlinecode"><span class="id" title="tactic">try</span></span> <span class="inlinecode"><span class="id" title="tactic">solve</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">solve_sum</span> := <span class="id" title="var">solve_left</span>; <span class="id" title="var">solve_right</span>.<br/>
</div>

<div class="doc">
We can now prove the <span class="inlinecode"><span class="id" title="var">Dec</span></span> instance quite concisely. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Instance</span> <a name="dec_bound_to"><span class="id" title="instance">dec_bound_to</span></a> {<span class="id" title="var">A</span> : <span class="id" title="keyword">Type</span>} <span class="id" title="var">Gamma</span> <span class="id" title="var">x</span> (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" title="var">D</span> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span> <span class="id" title="var">y</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>), <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#y"><span class="id" title="variable">y</span></a>)}<br/>
&nbsp;&nbsp;: <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>).<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ssr.ssrbool.html#decidable"><span class="id" title="definition">ssrbool.decidable</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#map_get"><span class="id" title="definition">map_get</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">x</span>) <span class="id" title="var">eqn</span>:<span class="id" title="var">Get</span>; <span class="id" title="var">solve_sum</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">D</span> <span class="id" title="var">a</span> <span class="id" title="var">T</span>) <span class="id" title="keyword">as</span> [[<span class="id" title="var">Eq</span> | <span class="id" title="var">NEq</span>]]; <span class="id" title="tactic">subst</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="keyword">Defined</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab82"></a><h2 class="section">Contexts</h2>

<div class="paragraph"> </div>

 Typing contexts in TImp are just maps from identifiers to types. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="context"><span class="id" title="definition">context</span></a> := <a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>.<br/>
</div>

<div class="doc">
Given a context <span class="inlinecode"><span class="id" title="var">Gamma</span></span> and a type <span class="inlinecode"><span class="id" title="var">T</span></span>, we can try to generate a
    random <span class="inlinecode"><span class="id" title="var">identifier</span></span> whose binding in <span class="inlinecode"><span class="id" title="var">Gamma</span></span> is <span class="inlinecode"><span class="id" title="var">T</span></span>.

<div class="paragraph"> </div>

    We use <span class="inlinecode"><span class="id" title="var">List.filter</span></span> to extract all of the elements in <span class="inlinecode"><span class="id" title="var">Gamma</span></span>
    whose type is equal to <span class="inlinecode"><span class="id" title="var">T</span></span> and then, for each <span class="inlinecode">(<span class="id" title="var">a</span>,<span class="id" title="var">T'</span>)</span> that
    remains, return the name <span class="inlinecode"><span class="id" title="var">a</span></span>. We use the <span class="inlinecode"><span class="id" title="var">oneOf_</span></span> combinator to
    pick an generator from this list at random.

<div class="paragraph"> </div>

    Since the filtered list might be empty we return an <span class="inlinecode"><span class="id" title="var">option</span></span>,
    we use <span class="inlinecode"><span class="id" title="var">ret</span></span> <span class="inlinecode"><span class="id" title="var">None</span></span> as the default element for <span class="inlinecode"><span class="id" title="var">oneOf_</span></span>.
 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="gen_typed_id_from_context"><span class="id" title="definition">gen_typed_id_from_context</span></a> (<span class="id" title="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a>) (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="axiom">oneOf_</span> (<span class="id" title="method">ret</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> '<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">T'</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> ⇒ <span class="id" title="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#filter"><span class="id" title="definition">List.filter</span></a> (<span class="id" title="keyword">fun</span> '<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">T'</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> ⇒ <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#T'"><span class="id" title="variable">T'</span></a><span class="id" title="notation">?</span>) <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>)).<br/>
</div>

<div class="doc">
We also need to generate typing contexts. 
<div class="paragraph"> </div>

 Given some natural number <span class="inlinecode"><span class="id" title="var">n</span></span> to serve as the size of the context,
    we first create its domain, <span class="inlinecode"><span class="id" title="var">n</span></span> fresh identifiers.  We then create <span class="inlinecode"><span class="id" title="var">n</span></span>
    arbitrary types with <span class="inlinecode"><span class="id" title="var">vectorOf</span></span>, using the <span class="inlinecode"><span class="id" title="var">Gen</span></span> instance for <span class="inlinecode"><span class="id" title="var">ty</span></span>
    we derived earlier.  Finally, we zip (<span class="inlinecode"><span class="id" title="var">List.combine</span></span>) the domain
    with the ranges which creates the (list-based) map.

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="gen_context"><span class="id" title="definition">gen_context</span></a> (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) : <span class="id" title="axiom">G</span> <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">domain</span> := <a class="idref" href="TImp.html#get_fresh_ids"><span class="id" title="definition">get_fresh_ids</span></a> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">range</span> <span class="id" title="notation">&lt;-</span> <span class="id" title="axiom">vectorOf</span> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a> <span class="id" title="method">arbitrary</span> <span class="id" title="notation">;;</span><br/>
&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#combine"><span class="id" title="definition">List.combine</span></a> <a class="idref" href="TImp.html#domain"><span class="id" title="variable">domain</span></a> <a class="idref" href="TImp.html#range"><span class="id" title="variable">range</span></a>).<br/>
</div>

<div class="doc">
<a name="lab83"></a><h1 class="section">Expressions</h1>

<div class="paragraph"> </div>

 We are now ready to introduce the syntax of expressions in TImp.
    The original Imp had two distinct types of expressions,
    arithmetic and boolean expressions; variables were only
    allowed to range over natural numbers. In TImp, we extend
    variables to range over boolean values as well, and we collapse
    expressions into a single type <span class="inlinecode"><span class="id" title="var">exp</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="exp"><span class="id" title="inductive">exp</span></a> : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="EVar"><span class="id" title="constructor">EVar</span></a> : <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ENum"><span class="id" title="constructor">ENum</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EPlus"><span class="id" title="constructor">EPlus</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EMinus"><span class="id" title="constructor">EMinus</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EMult"><span class="id" title="constructor">EMult</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ETrue"><span class="id" title="constructor">ETrue</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EFalse"><span class="id" title="constructor">EFalse</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EEq"><span class="id" title="constructor">EEq</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ELe"><span class="id" title="constructor">ELe</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ENot"><span class="id" title="constructor">ENot</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EAnd"><span class="id" title="constructor">EAnd</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>.<br/>
</div>

<div class="doc">
To print expressions we derive a <span class="inlinecode"><span class="id" title="keyword">Show</span></span> Instance. 
</div>
<div class="code">

<br/>
<span class="id" title="var">Derive</span> <span class="id" title="keyword">Show</span> <span class="id" title="keyword">for</span> <span class="id" title="var">exp</span>.<br/>
</div>

<div class="doc">
<a name="lab84"></a><h2 class="section">Typed Expressions</h2>

<div class="paragraph"> </div>

 The following inductive relation characterizes well-typed
    expressions of a particular type. It is straightforward, using
    <span class="inlinecode"><span class="id" title="var">bound_to</span></span> to access the typing context in the variable case 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Reserved Notation</span> &quot;Gamma '|&#x22A2;' e '\IN' T" (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 40).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a name="has_type"><span class="id" title="inductive">has_type</span></a> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> := <br/>
| <a name="Ty_Var"><span class="id" title="constructor">Ty_Var</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">x</span> <span class="id" title="var">T</span> <span class="id" title="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><br/>
| <a name="Ty_Num"><span class="id" title="constructor">Ty_Num</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">n</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a><br/>
| <a name="Ty_Plus"><span class="id" title="constructor">Ty_Plus</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>                                    <br/>
| <a name="Ty_Minus"><span class="id" title="constructor">Ty_Minus</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EMinus"><span class="id" title="constructor">EMinus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>                                    <br/>
| <a name="Ty_Mult"><span class="id" title="constructor">Ty_Mult</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EMult"><span class="id" title="constructor">EMult</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>                                    <br/>
| <a name="Ty_True"><span class="id" title="constructor">Ty_True</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span>, <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
| <a name="Ty_False"><span class="id" title="constructor">Ty_False</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span>, <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
| <a name="Ty_Eq"><span class="id" title="constructor">Ty_Eq</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
| <a name="Ty_Le"><span class="id" title="constructor">Ty_Le</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#ELe"><span class="id" title="constructor">ELe</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
| <a name="Ty_Not"><span class="id" title="constructor">Ty_Not</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a>  <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#ENot"><span class="id" title="constructor">ENot</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
| <a name="Ty_And"><span class="id" title="constructor">Ty_And</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#EAnd"><span class="id" title="constructor">EAnd</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
<br/>
<span class="id" title="keyword">where</span> <a name="dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">&quot;</span></a>Gamma '|&#x22A2;' e '\IN' T" := (<a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">e</span> <span class="id" title="var">T</span>).<br/>
</div>

<div class="doc">
While the typing relation is almost entirely standard, there is a 
    choice to make about the <span class="inlinecode"><span class="id" title="var">Ty_Eq</span></span> rule. The <span class="inlinecode"><span class="id" title="var">Ty_Eq</span></span> constructor
    above requires that the arguments to an equality check are both 
    arithmetic expressions (just like it was in Imp), which simplifies
    some of the discussion in the remainder of the chapter. We could
    have allowed for equality checks between booleans as well - that will
    become an exercise at the end of this chapter. 
<div class="paragraph"> </div>

 Once again, we need a decidable instance for the typing relation of
    TImp. You can skip to the next exercise if you are not interested in
    specific proof details. 
<div class="paragraph"> </div>

 We will need a bit more automation for this proof. We will
    have a lot of hypotheses of the form: 
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;<span class="id" title="var">IH</span> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">T</span> : <span class="id" title="var">ty</span>) (<span class="id" title="var">Gamma</span> : <span class="id" title="keyword">context</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ssrbool.decidable</span> (<span class="id" title="var">Gamma</span> |&#x22A2; <span class="id" title="var">e<sub>1</sub></span> \<span class="id" title="var">IN</span> <span class="id" title="var">T</span>)
<div class="paragraph"> </div>

</span>
<div class="paragraph"> </div>

    Using a brute-force approach, we instantiate such <span class="inlinecode"><span class="id" title="var">IH</span></span>
    with both <span class="inlinecode"><span class="id" title="var">TNat</span></span> and <span class="inlinecode"><span class="id" title="var">TBool</span></span>, destruct them and then 
    call <span class="inlinecode"><span class="id" title="var">solve_sum</span></span>. 

<div class="paragraph"> </div>

    The <span class="inlinecode"><span class="id" title="tactic">pose</span></span> <span class="inlinecode"><span class="id" title="var">proof</span></span> tactic introduces a new hypothesis 
    in our context, while <span class="inlinecode"><span class="id" title="tactic">clear</span></span> <span class="inlinecode"><span class="id" title="var">IH</span></span> removes it so that 
    we don't try the same instantiations again and 
    again.

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">solve_inductives</span> <span class="id" title="var">Gamma</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">repeat</span> (<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="id" title="var">IH</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>, <span class="id" title="var">_</span> &#x22A2; <span class="id" title="var">_</span> ] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">H<sub>1</sub></span> := <span class="id" title="tactic">fresh</span> "H<sub>1</sub>" <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">pose</span> <span class="id" title="var">proof</span> (<span class="id" title="var">IH</span> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">Gamma</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">H<sub>1</sub></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">H<sub>2</sub></span> := <span class="id" title="tactic">fresh</span> "H<sub>2</sub>" <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">pose</span> <span class="id" title="var">proof</span> (<span class="id" title="var">IH</span> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <span class="id" title="var">Gamma</span>) <span class="id" title="keyword">as</span> <span class="id" title="var">H<sub>2</sub></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">IH</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>1</sub></span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>2</sub></span>; <span class="id" title="var">solve_sum</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).<br/>
</div>

<div class="doc">
Typing in TImp is decidable: given an expression <span class="inlinecode"><span class="id" title="var">e</span></span>, a context <span class="inlinecode"><span class="id" title="var">Gamma</span></span> 
    and a type <span class="inlinecode"><span class="id" title="var">T</span></span>, we can decide whether <span class="inlinecode"><span class="id" title="var">has_type</span></span> <span class="inlinecode"><span class="id" title="var">Gamma</span></span> <span class="inlinecode"><span class="id" title="var">e</span></span> <span class="inlinecode"><span class="id" title="var">T</span></span> holds. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Instance</span> <a name="dec_has_type"><span class="id" title="instance">dec_has_type</span></a> (<span class="id" title="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) (<span class="id" title="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a>) (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) <br/>
&nbsp;&nbsp;: <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">with</span> <span class="id" title="var">solve_sum</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">generalize</span> <span class="id" title="tactic">dependent</span> <span class="id" title="var">Gamma</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">generalize</span> <span class="id" title="tactic">dependent</span> <span class="id" title="var">T</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">e</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">T</span> <span class="id" title="var">Gamma</span>; <span class="id" title="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ssr.ssrbool.html#decidable"><span class="id" title="definition">ssrbool.decidable</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span> [<span class="id" title="tactic">destruct</span> <span class="id" title="var">T</span>; <span class="id" title="var">solve_sum</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="tactic">solve</span> [<span class="id" title="tactic">destruct</span> <span class="id" title="var">T</span>; <span class="id" title="var">solve_inductives</span> <span class="id" title="var">Gamma</span>].<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;bound_to&nbsp;case:&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_bound_to"><span class="id" title="instance">dec_bound_to</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">i</span> <span class="id" title="var">T</span>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="keyword">Defined</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab85"></a><h4 class="section">练习：3 星, standard (arbitraryExp)</h4>
 Derive <span class="inlinecode"><span class="id" title="var">Arbitrary</span></span> for expressions.  To see how good it is at
    generating <i>well-typed</i> expressions, write a conditional property 
    <span class="inlinecode"><span class="id" title="var">cond_prop</span></span> that is (trivially) always true, with the precondition 
    that some expression is well-typed. Try to check that property like 
    this:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">QuickChickWith</span> (<span class="id" title="var">updMaxSize</span> <span class="id" title="var">stdArgs</span> 3) <span class="id" title="var">cond_prop</span>.
<div class="paragraph"> </div>

</span>    This idiom sets the maximum-size parameter for all generators to
    <span class="inlinecode">3</span>, rather the default, which is something larger like 10.  When
    generating examples, QuickChick will start with size 0, gradually
    increase the size until the maximum size is reached, and then
    start over.  What happens when you vary the size bound? 
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span><br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab86"></a><h2 class="section">Generating Typed Expressions</h2>

<div class="paragraph"> </div>

 Instead of generating expressions and filtering them using
    <span class="inlinecode"><span class="id" title="var">has_type</span></span>, we can be smarter and generate <i>well-typed</i>
    expressions for a given context directly.

<div class="paragraph"> </div>

    It is common for conditional generators to return <span class="inlinecode"><span class="id" title="var">option</span></span>s,
    allowing the possibility of failure if a wrong choice is made
    internally. For example, if we wanted to generate an expression of
    type <span class="inlinecode"><span class="id" title="var">TNat</span></span> and chose to try to do so by generating a variable,
    then we might not be able to finish (if the context is empty or
    only binds booleans). 
<div class="paragraph"> </div>

 To chain together two generators with types of the form 
    <span class="inlinecode"><span class="id" title="var">G</span></span> <span class="inlinecode">(<span class="id" title="var">option</span></span> <span class="inlinecode">...)</span>, we need to execute the first generator, match 
    on its result, and, when it is a <span class="inlinecode"><span class="id" title="var">Some</span></span>, apply the second generator. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="bindGenOpt"><span class="id" title="definition">bindGenOpt</span></a> {<span class="id" title="var">A</span> <span class="id" title="var">B</span> : <span class="id" title="keyword">Type</span>} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">gma</span> : <span class="id" title="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>)) (<span class="id" title="var">k</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#B"><span class="id" title="variable">B</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#B"><span class="id" title="variable">B</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">ma</span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gma"><span class="id" title="variable">gma</span></a> <span class="id" title="notation">;;</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#ma"><span class="id" title="variable">ma</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">a</span> ⇒ <a class="idref" href="TImp.html#k"><span class="id" title="variable">k</span></a> <span class="id" title="var">a</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <span class="id" title="method">ret</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
This pattern is common enough that QuickChick introduces explicit monadic 
    notations. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Print</span> <span class="id" title="definition">GOpt</span>.<br/>
</div>

<div class="doc">
<pre>
    GOpt = fun A : Type =&gt; G (option A)
         : Type <span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span> Type
</pre>

</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;Check&nbsp;Monad_GOpt.&nbsp;*)</span><br/>
</div>

<div class="doc">
<pre>
    Monad_GOpt
         : Monad GOpt
</pre>

<div class="paragraph"> </div>

 This brings us to our first interesting generator -- one for typed
    expressions.  We assume that <span class="inlinecode"><span class="id" title="var">Gamma</span></span> and <span class="inlinecode"><span class="id" title="var">T</span></span> are inputs to the
    generation process.  We also use a <span class="inlinecode"><span class="id" title="var">size</span></span> parameter to control the
    depth of generated expressions (i.e., we'll define a sized
    generator). 
<div class="paragraph"> </div>

 Let's start with a much smaller relation: <span class="inlinecode"><span class="id" title="var">has_type_1</span></span> (which
    consists of just the first constructor of <span class="inlinecode"><span class="id" title="var">has_type</span></span>), to
    demonstrate how to build up complex generators for typed
    expressions from smaller parts. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="has_type_1"><span class="id" title="inductive">has_type_1</span></a> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> := <br/>
&nbsp;&nbsp;| <a name="Ty_Var1"><span class="id" title="constructor">Ty_Var1</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">x</span> <span class="id" title="var">T</span> <span class="id" title="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#has_type_1"><span class="id" title="inductive">has_type_1</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a>) <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>.<br/>
</div>

<div class="doc">
To generate <span class="inlinecode"><span class="id" title="var">e</span></span> such that <span class="inlinecode"><span class="id" title="var">has_type_1</span></span> <span class="inlinecode"><span class="id" title="var">Gamma</span></span> <span class="inlinecode"><span class="id" title="var">e</span></span> <span class="inlinecode"><span class="id" title="var">T</span></span> holds, we need to
    pick one of its constructors (there is only one choice, here) and
    then try to satisfy its preconditions by generating more things.
    To satisfy <span class="inlinecode"><span class="id" title="var">Ty_Var1</span></span> (given <span class="inlinecode"><span class="id" title="var">Gamma</span></span> and <span class="inlinecode"><span class="id" title="var">T</span></span>), we need to generate
    <span class="inlinecode"><span class="id" title="var">x</span></span> such that <span class="inlinecode"><span class="id" title="var">bound_to</span></span> <span class="inlinecode"><span class="id" title="var">Gamma</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">T</span></span>. But we already have such a
    generator!  We just need to wrap it in an <span class="inlinecode"><span class="id" title="var">EVar</span></span>.  
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="gen_typed_evar"><span class="id" title="definition">gen_typed_evar</span></a> (<span class="id" title="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a>) (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) : <span class="id" title="definition">GOpt</span> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">x</span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_typed_id_from_context"><span class="id" title="definition">gen_typed_id_from_context</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><span class="id" title="notation">;;</span><br/>
&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a>).<br/>
</div>

<div class="doc">
(Note that this is the <span class="inlinecode"><span class="id" title="var">ret</span></span> of the <span class="inlinecode"><span class="id" title="var">GOpt</span></span> monad.) 
<div class="paragraph"> </div>

 Now let's consider a typing relation <span class="inlinecode"><span class="id" title="var">has_type_2</span></span>, extending
    <span class="inlinecode"><span class="id" title="var">has_type_1</span></span> with all of the constructors of <span class="inlinecode"><span class="id" title="var">has_type</span></span> that do
    not recursively require <span class="inlinecode"><span class="id" title="var">has_type</span></span> as a side-condition. These will
    be the <i>base cases</i> for our final generator. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="has_type_2"><span class="id" title="inductive">has_type_2</span></a> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a name="Ty_Var2"><span class="id" title="constructor">Ty_Var2</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">x</span> <span class="id" title="var">T</span> <span class="id" title="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#has_type_2"><span class="id" title="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a>) <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><br/>
| <a name="Ty_Num2"><span class="id" title="constructor">Ty_Num2</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">n</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_2"><span class="id" title="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>  (<a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a>) <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a><br/>
| <a name="Ty_True2"><span class="id" title="constructor">Ty_True2</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span>, <a class="idref" href="TImp.html#has_type_2"><span class="id" title="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a><br/>
| <a name="Ty_False2"><span class="id" title="constructor">Ty_False2</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span>, <a class="idref" href="TImp.html#has_type_2"><span class="id" title="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a>.<br/>
</div>

<div class="doc">
We can already generate values satisfying <span class="inlinecode"><span class="id" title="var">Ty_Var2</span></span> using
    <span class="inlinecode"><span class="id" title="var">gen_typed_evar</span></span>.  For the rest of the rules, we will need to
    pattern match on the input <span class="inlinecode"><span class="id" title="var">T</span></span>, since <span class="inlinecode"><span class="id" title="var">Ty_Num</span></span> can only be used if
    <span class="inlinecode"><span class="id" title="var">T</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">TNat</span></span>, while <span class="inlinecode"><span class="id" title="var">Ty_True</span></span> and <span class="inlinecode"><span class="id" title="var">Ty_False</span></span> can only be used if <span class="inlinecode"><span class="id" title="var">T</span></span>
    <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">TBool</span></span>.  
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="base'"><span class="id" title="definition">base'</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">T</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<span class="id" title="definition">GOpt</span> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#gen_typed_evar"><span class="id" title="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>  ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a> <span class="id" title="var">n</span> <span class="id" title="notation">&lt;-</span> <span class="id" title="method">arbitrary</span><span class="id" title="notation">;;</span> <span class="id" title="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a>))<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">[</span></a> <span class="id" title="method">ret</span> <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <span class="id" title="method">ret</span> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
We now need to go from a list of (optional) generators to a 
    single generator. We could do that using the <span class="inlinecode"><span class="id" title="var">oneOf</span></span> combinator (which
    chooses uniformly), or the <span class="inlinecode"><span class="id" title="var">freq</span></span> combinator (by adding weights).

<div class="paragraph"> </div>

    Instead, we introduce a new one, called <span class="inlinecode"><span class="id" title="var">backtrack</span></span>:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">backtrack</span> : <span class="id" title="var">list</span> (<span class="id" title="var">nat</span> × <span class="id" title="var">GOpt</span> ?<span class="id" title="var">A</span>) → <span class="id" title="var">GOpt</span> ?<span class="id" title="var">A</span>
<div class="paragraph"> </div>

</span>
<div class="paragraph"> </div>

 Just like <span class="inlinecode"><span class="id" title="var">freq</span></span>, <span class="inlinecode"><span class="id" title="var">backtrack</span></span> selects one of the generators
    according to the input weights. Unlike <span class="inlinecode"><span class="id" title="var">freq</span></span>, if the chosen
    generator fails (i.e. produces <span class="inlinecode"><span class="id" title="var">None</span></span>), <span class="inlinecode"><span class="id" title="var">backtrack</span></span> will discard
    it, choose another, and keep going until one succeeds or all
    possibilities are exhausted. Our base-case generator could then be
    like this: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="base"><span class="id" title="definition">base</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">T</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a>2<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="TImp.html#gen_typed_evar"><span class="id" title="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>  ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a>2<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">n</span> <span class="id" title="notation">&lt;-</span> <span class="id" title="method">arbitrary</span><span class="id" title="notation">;;</span> <span class="id" title="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a>))<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">[</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a>1<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="method">ret</span> <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a>1<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="method">ret</span> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="gen_has_type_2"><span class="id" title="definition">gen_has_type_2</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">T</span> := <span class="id" title="axiom">backtrack</span> (<a class="idref" href="TImp.html#base"><span class="id" title="definition">base</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>).<br/>
</div>

<div class="doc">
To see how we handle recursive rules, let's consider a third
    sub-relation, <span class="inlinecode"><span class="id" title="var">has_type_3</span></span>, with just variables and addition: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="has_type_3"><span class="id" title="inductive">has_type_3</span></a> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;| <a name="Ty_Var3"><span class="id" title="constructor">Ty_Var3</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">x</span> <span class="id" title="var">T</span> <span class="id" title="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#has_type_3"><span class="id" title="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a>) <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><br/>
&nbsp;| <a name="Ty_Plus3"><span class="id" title="constructor">Ty_Plus3</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_3"><span class="id" title="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#has_type_3"><span class="id" title="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_3"><span class="id" title="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>) <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>.<br/>
</div>

<div class="doc">
Typing derivations involving <span class="inlinecode"><span class="id" title="var">EPlus</span></span> nodes are binary trees, so we
    need to add a <span class="inlinecode"><span class="id" title="var">size</span></span> parameter to enforce termination. The base
    case (<span class="inlinecode"><span class="id" title="var">Ty_Var3</span></span>) is handled using <span class="inlinecode"><span class="id" title="var">gen_typed_evar</span></span> just like
    before.  The non-base case can choose between trying to generate
    <span class="inlinecode"><span class="id" title="var">Ty_Var3</span></span> and trying to generate <span class="inlinecode"><span class="id" title="var">Ty_Plus3</span></span>. For the latter, the
    input type <span class="inlinecode"><span class="id" title="var">T</span></span> must be <span class="inlinecode"><span class="id" title="var">TNat</span></span>, otherwise it is not
    applicable. Once again, this leads to a match on <span class="inlinecode"><span class="id" title="var">T</span></span>: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="gen_has_type_3"><span class="id" title="definition">gen_has_type_3</span></a> <span class="id" title="var">size</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">T</span> : <span class="id" title="definition">GOpt</span> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#O"><span class="id" title="constructor">O</span></a> ⇒ <a class="idref" href="TImp.html#gen_typed_evar"><span class="id" title="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <span class="id" title="var">size'</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="axiom">backtrack</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a>1<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="TImp.html#gen_typed_evar"><span class="id" title="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_has_type_3"><span class="id" title="definition">gen_has_type_3</span></a> <span class="id" title="var">size'</span> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a><span class="id" title="notation">;;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_has_type_3"><span class="id" title="definition">gen_has_type_3</span></a> <span class="id" title="var">size'</span> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a><span class="id" title="notation">;;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Putting all this together, we get the full generator for
    well-typed expressions. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">size</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) (<span class="id" title="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a>) (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="definition">GOpt</span> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">base</span> := <a class="idref" href="TImp.html#base"><span class="id" title="definition">base</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">recs</span> <span class="id" title="var">size'</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">[</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EMinus"><span class="id" title="constructor">EMinus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EMult"><span class="id" title="constructor">EMult</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">[</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#ELe"><span class="id" title="constructor">ELe</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#ENot"><span class="id" title="constructor">ENot</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>2</sub></span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" title="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <span class="id" title="notation">;;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#EAnd"><span class="id" title="constructor">EAnd</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" title="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" title="variable">e<sub>2</sub></span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#size"><span class="id" title="variable">size</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#O"><span class="id" title="constructor">O</span></a> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="axiom">backtrack</span> <a class="idref" href="TImp.html#base"><span class="id" title="variable">base</span></a> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <span class="id" title="var">size'</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="axiom">backtrack</span> (<a class="idref" href="TImp.html#base"><span class="id" title="variable">base</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="TImp.html#recs"><span class="id" title="variable">recs</span></a> <span class="id" title="var">size'</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
When writing such complex generators, it's good to have some tests
    to verify that we are generating what we expect. For example, here
    we would expect <span class="inlinecode"><span class="id" title="var">gen_exp_typed_sized</span></span> to always return expressions
    that are well typed.

<div class="paragraph"> </div>

    We can use <span class="inlinecode"><span class="id" title="var">forAll</span></span> to encode such a property. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="gen_typed_has_type"><span class="id" title="definition">gen_typed_has_type</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">num_vars</span> := 4 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">top_level_size</span> := 3 <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" title="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" title="variable">num_vars</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <span class="id" title="method">arbitrary</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">T</span> ⇒                                   <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#top_level_size"><span class="id" title="variable">top_level_size</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">me</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" title="variable">me</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">e</span> ⇒ <span class="id" title="notation">(</span><a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <span class="id" title="var">e</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><span class="id" title="notation">)?</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a> <br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;gen_typed_has_type.&nbsp;*)</span><br/>
</div>

<div class="doc">
<a name="lab87"></a><h1 class="section">Values and States</h1>

<div class="paragraph"> </div>

<a name="lab88"></a><h2 class="section">Values</h2>

<div class="paragraph"> </div>

 In the original Imp language from <i>Logical Foundations</i>, variables
    ranged over natural numbers, so states were just maps from
    identifiers to <span class="inlinecode"><span class="id" title="var">nat</span></span>.  Since we now want to extend this to also
    include booleans, we need a type of <span class="inlinecode"><span class="id" title="var">value</span></span>s that includes
    both. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="value"><span class="id" title="inductive">value</span></a> := <a name="VNat"><span class="id" title="constructor">VNat</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#value"><span class="id" title="inductive">value</span></a> | <a name="VBool"><span class="id" title="constructor">VBool</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#value"><span class="id" title="inductive">value</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="var">Derive</span> <span class="id" title="keyword">Show</span> <span class="id" title="keyword">for</span> <span class="id" title="var">value</span>.<br/>
</div>

<div class="doc">
We can also quickly define a typing relation for values, a Dec instance
    for it, and a generator for values of a given type. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="has_type_value"><span class="id" title="inductive">has_type_value</span></a> : <a class="idref" href="TImp.html#value"><span class="id" title="inductive">value</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="TyVNat"><span class="id" title="constructor">TyVNat</span></a>  : <span class="id" title="keyword">∀</span> <span class="id" title="var">n</span>, <a class="idref" href="TImp.html#has_type_value"><span class="id" title="inductive">has_type_value</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a>  <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a>) <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a><br/>
&nbsp;&nbsp;| <a name="TyVBool"><span class="id" title="constructor">TyVBool</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">b</span>, <a class="idref" href="TImp.html#has_type_value"><span class="id" title="inductive">has_type_value</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <a class="idref" href="TImp.html#b"><span class="id" title="variable">b</span></a>) <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Instance</span> <a name="dec_has_type_value"><span class="id" title="instance">dec_has_type_value</span></a> <span class="id" title="var">v</span> <span class="id" title="var">T</span> : <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#has_type_value"><span class="id" title="inductive">has_type_value</span></a> <a class="idref" href="TImp.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>).<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ssr.ssrbool.html#decidable"><span class="id" title="definition">ssrbool.decidable</span></a>.<br/>
<span class="id" title="tactic">destruct</span> <span class="id" title="var">v</span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">T</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="keyword">Defined</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Definition</span> <a name="gen_typed_value"><span class="id" title="definition">gen_typed_value</span></a> (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) : <span class="id" title="axiom">G</span> <a class="idref" href="TImp.html#value"><span class="id" title="inductive">value</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>  ⇒ <span class="id" title="var">n</span> <span class="id" title="notation">&lt;-</span> <span class="id" title="method">arbitrary</span><span class="id" title="notation">;;</span> <span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <a class="idref" href="TImp.html#n"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> ⇒ <span class="id" title="var">b</span> <span class="id" title="notation">&lt;-</span> <span class="id" title="method">arbitrary</span><span class="id" title="notation">;;</span> <span class="id" title="method">ret</span> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <a class="idref" href="TImp.html#b"><span class="id" title="variable">b</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a name="lab89"></a><h2 class="section">States</h2>

<div class="paragraph"> </div>

 <i>States</i> in TImp are just maps from identifiers to values 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="state"><span class="id" title="definition">state</span></a> := <a class="idref" href="TImp.html#Map"><span class="id" title="definition">Map</span></a> <a class="idref" href="TImp.html#value"><span class="id" title="inductive">value</span></a>.<br/>
</div>

<div class="doc">
We introduce an inductive relation that specifies when a state is
    well typed in a context (that is, when all of its variables are
    mapped to values of appropriate types).

<div class="paragraph"> </div>

    We encode this in an element-by-element style inductive relation:
    empty states are only well typed with respect to an empty context,
    while non-empty states need to map their head identifier to a value of
    the appropriate type (and their tail must similarly be well
    typed). 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#state"><span class="id" title="definition">state</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a name="TS_Empty"><span class="id" title="constructor">TS_Empty</span></a> : <a class="idref" href="TImp.html#well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#map_empty"><span class="id" title="definition">map_empty</span></a> <a class="idref" href="TImp.html#map_empty"><span class="id" title="definition">map_empty</span></a><br/>
| <a name="TS_Elem"><span class="id" title="constructor">TS_Elem</span></a>  : <span class="id" title="keyword">∀</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">T</span> <span class="id" title="var">st</span> <span class="id" title="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_value"><span class="id" title="inductive">has_type_value</span></a> <a class="idref" href="TImp.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>) (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="TImp.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Instance</span> <a name="dec_well_typed_state"><span class="id" title="instance">dec_well_typed_state</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">st</span> : <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a>).<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ssr.ssrbool.html#decidable"><span class="id" title="definition">ssrbool.decidable</span></a>.<br/>
<span class="id" title="tactic">generalize</span> <span class="id" title="tactic">dependent</span> <span class="id" title="var">Gamma</span>.<br/>
<span class="id" title="tactic">induction</span> <span class="id" title="var">st</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">Gamma</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="tactic">destruct</span> <span class="id" title="var">a</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">a</span> <span class="id" title="var">v</span>]; <span class="id" title="tactic">destruct</span> <span class="id" title="var">p</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">a'</span> <span class="id" title="var">T</span>].<br/>
<span class="id" title="tactic">destruct</span> (@<span class="id" title="method">dec</span> (<span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">a'</span>) <span class="id" title="var">_</span> ); <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="tactic">subst</span>; <span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHst</span> <span class="id" title="var">Gamma</span>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">IHst</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type_value"><span class="id" title="instance">dec_has_type_value</span></a> <span class="id" title="var">v</span> <span class="id" title="var">T</span>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="keyword">Defined</span>.<br/>
</div>

<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="gen_well_typed_state"><span class="id" title="definition">gen_well_typed_state</span></a> (<span class="id" title="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a>) : <span class="id" title="axiom">G</span> <a class="idref" href="TImp.html#state"><span class="id" title="definition">state</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="axiom">sequenceGen</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> '<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <span class="id" title="var">T</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">v</span> <span class="id" title="notation">&lt;-</span> <a class="idref" href="TImp.html#gen_typed_value"><span class="id" title="definition">gen_typed_value</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><span class="id" title="notation">;;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">ret</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="TImp.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a>) <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>).<br/>
</div>

<div class="doc">
<a name="lab90"></a><h1 class="section">Evaluation</h1>

<div class="paragraph"> </div>

 The evaluation function takes a state and an expression and
    returns an optional value, which can be <span class="inlinecode"><span class="id" title="var">None</span></span> if the expression
    encounters a dynamic type error like trying to perform addition on
    a boolean. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="eval"><span class="id" title="definition">eval</span></a> (<span class="id" title="var">st</span> : <a class="idref" href="TImp.html#state"><span class="id" title="definition">state</span></a>) (<span class="id" title="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#value"><span class="id" title="inductive">value</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="TImp.html#map_get"><span class="id" title="definition">map_get</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <span class="id" title="var">n</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>2</sub></span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> (<span class="id" title="var">n<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#b3eea360671e1b32b18a26e15b3aace3"><span class="id" title="notation">+</span></a> <span class="id" title="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMinus"><span class="id" title="constructor">EMinus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>2</sub></span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> (<span class="id" title="var">n<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#9482aae3d3b06e249765c1225dbb8cbb"><span class="id" title="notation">-</span></a> <span class="id" title="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMult"><span class="id" title="constructor">EMult</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>2</sub></span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> (<span class="id" title="var">n<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#697e4695610f677ae98a52af81f779d<sub>2</sub>"><span class="id" title="notation">×</span></a> <span class="id" title="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a>       ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a>  )<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a>      ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a> )<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>2</sub></span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> (<span class="id" title="var">n<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a> <span class="id" title="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ELe"><span class="id" title="constructor">ELe</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>2</sub></span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> (<span class="id" title="var">n<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> <span class="id" title="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENot"><span class="id" title="constructor">ENot</span></a> <span class="id" title="var">e</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <span class="id" title="var">b</span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <span class="id" title="var">b</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EAnd"><span class="id" title="constructor">EAnd</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e<sub>2</sub></span> <span class="id" title="keyword">with</span> <br/>
<span class="comment">(*&nbsp;Let's&nbsp;include&nbsp;a&nbsp;silly&nbsp;bug&nbsp;here!&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <span class="id" title="var">b</span>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" title="constructor">VNat</span></a> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <span class="id" title="var">b</span>))<br/>
<span class="comment">(*&nbsp;&nbsp;|&nbsp;Some&nbsp;(VBool&nbsp;b<sub>1</sub>),&nbsp;Some&nbsp;(VBool&nbsp;b<sub>2</sub>)&nbsp;=&gt;&nbsp;Some&nbsp;(VBool&nbsp;(andb&nbsp;b<sub>1</sub>&nbsp;b<sub>2</sub>))&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
We will see in a later chapter (<a href="QuickChickTool.html"><span class="inlineref">QuickChickTool</span></a>) how we can
    use QuickChick to introduce such <i>mutations</i> and have them
    automatically checked. 
<div class="paragraph"> </div>

 <i>Type soundness</i> states that, if we have an expression <span class="inlinecode"><span class="id" title="var">e</span></span> of a
    given type <span class="inlinecode"><span class="id" title="var">T</span></span> as well as a well-typed state <span class="inlinecode"><span class="id" title="var">st</span></span>, then evaluating
    <span class="inlinecode"><span class="id" title="var">e</span></span> in <span class="inlinecode"><span class="id" title="var">st</span></span> will never fail.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="isNone"><span class="id" title="definition">isNone</span></a> {<span class="id" title="var">A</span> : <span class="id" title="keyword">Type</span>} (<span class="id" title="var">m</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Conjecture</span> <a name="expression_soundness"><span class="id" title="axiom">expression_soundness</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">st</span> <span class="id" title="var">e</span> <span class="id" title="var">T</span>,  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a>  <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#isNone"><span class="id" title="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a>.<br/>
</div>

<div class="doc">
To test this property, we construct an appropriate checker: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="expression_soundness_exec"><span class="id" title="definition">expression_soundness_exec</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">num_vars</span> := 4 <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">top_level_size</span> := 3 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" title="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" title="variable">num_vars</span></a>)  (<span class="id" title="keyword">fun</span> <span class="id" title="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_well_typed_state"><span class="id" title="definition">gen_well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <span class="id" title="method">arbitrary</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">T</span> ⇒                                    <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> 3 <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">me</span> ⇒ <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" title="variable">me</span></a> <span class="id" title="keyword">with</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">e</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="TImp.html#isNone"><span class="id" title="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e</span>))<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>)))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;expression_soundness_exec.&nbsp;*)</span><br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<pre>     ===&gt;
       QuickChecking expression_soundness_exec
       [(1,TNat), (2,TNat), (3,TBool), (4,TNat)]
       [(1,VNat 0), (2,VNat 0), (3,VBool true), (4,VNat 0)]
       TBool
       Some EAnd (EAnd (EEq (EVar 4) (EVar 1)) (EEq (ENum 0) (EVar 4))) EFalse
       *** Failed after 8 tests and 0 shrinks. (0 discards)
</pre>
 Where is the bug??  Looks like we need some shrinking! 
<div class="paragraph"> </div>

<a name="lab91"></a><h2 class="section">Shrinking for Expressions</h2>

<div class="paragraph"> </div>

 Let's see what happens if we use the default shrinker for
    expressions carelessly. 
</div>
<div class="code">

<br/>
<span class="id" title="var">Derive</span> <span class="id" title="var">Shrink</span> <span class="id" title="keyword">for</span> <span class="id" title="var">exp</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="expression_soundness_exec_firstshrink"><span class="id" title="definition">expression_soundness_exec_firstshrink</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">num_vars</span> := 4 <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">top_level_size</span> := 3 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" title="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" title="variable">num_vars</span></a>)  (<span class="id" title="keyword">fun</span> <span class="id" title="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_well_typed_state"><span class="id" title="definition">gen_well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <span class="id" title="method">arbitrary</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">T</span> ⇒                                    <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAllShrink</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> 3 <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>) <span class="id" title="method">shrink</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">me</span> ⇒ <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" title="variable">me</span></a> <span class="id" title="keyword">with</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">e</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="TImp.html#isNone"><span class="id" title="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e</span>))<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>)))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;expression_soundness_exec_firstshrink.&nbsp;*)</span><br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<pre>     ===&gt; 
       QuickChecking expression_soundness_exec_firsttry
       [(1,TBool), (2,TNat), (3,TBool), (4,TBool)]
       [(1,VBool false), (2,VNat 0), (3,VBool true), (4,VBool false)]
       TBool
       Some EAnd (ENum 0) ETrue
       *** Failed after 28 tests and 7 shrinks. (0 discards)
</pre>

<div class="paragraph"> </div>

 The expression shrank to something ill-typed! Since it causes the
    checker to fail, QuickChick views this as a succesfull shrink, even 
    though this could not actually be produced by our generator and 
    doesn't satisfy our preconditions!  One solution would be to check 
    the preconditions in the Checker, filtering out shrinks.  But that 
    would be inefficient. 
<div class="paragraph"> </div>

 We not only need to shrink expressions, we need to shrink them so
    that their type is preserved! To accomplish this, we need to
    intuitively follow the opposite of the procedure we did for
    generators: look at a typing derivation and see what parts of it
    we can shrink to while maintaining their types so that the type of
    the entire thing is preserved.

<div class="paragraph"> </div>

    As in the case of <span class="inlinecode"><span class="id" title="var">gen_exp_typed</span></span>, we are going to build up the
    full shrinker in steps. Let's begin with shrinking constants.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" title="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">ENum</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> for some <span class="inlinecode"><span class="id" title="var">x</span></span>, all we can do is try to shrink
      <span class="inlinecode"><span class="id" title="var">x</span></span>.

</li>
<li> If <span class="inlinecode"><span class="id" title="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">ETrue</span></span> or <span class="inlinecode"><span class="id" title="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">EFalse</span></span>, we could shrink it to the other.
      But remember, we don't want to do both, as this would lead to an
      infinite loop in shrinking!  We choose to shrink <span class="inlinecode"><span class="id" title="var">EFalse</span></span> to
      <span class="inlinecode"><span class="id" title="var">ETrue</span></span>. 
</li>
</ul>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="shrink_base"><span class="id" title="definition">shrink_base</span></a> (<span class="id" title="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <span class="id" title="var">n</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">map</span></a> <a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> (<span class="id" title="method">shrink</span> <span class="id" title="var">n</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a><a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a> <br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The next case, <span class="inlinecode"><span class="id" title="var">EVar</span></span>, must take the type <span class="inlinecode"><span class="id" title="var">T</span></span> to be preserved into
    account. To shrink an <span class="inlinecode"><span class="id" title="var">EVar</span></span> we could try shrinking the inner
    identifier, but shrinking an identifier by shrinking its natural
    number representation makes little sense. Better, we can try to 
    shrink the <span class="inlinecode"><span class="id" title="var">EVar</span></span> to a constant of the appropriate type. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="shrink_evar"><span class="id" title="definition">shrink_evar</span></a> (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) (<span class="id" title="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <span class="id" title="var">x</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a><a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> 0<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">[</span></a><a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Finally, we need to be able to shrink the recursive cases. Consider 
    <span class="inlinecode"><span class="id" title="var">EPlus</span></span> <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span>: 
<ul class="doclist">
<li> We could try (recursively) shrinking <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span> preserving their 
        <span class="inlinecode"><span class="id" title="var">TNat</span></span> type.

</li>
<li> We could try to shrink directly to <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span> since their type 
        is the same as <span class="inlinecode"><span class="id" title="var">EPlus</span></span> <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span>. 
</li>
</ul>

<div class="paragraph"> </div>

 On the other hand, consider <span class="inlinecode"><span class="id" title="var">EEq</span></span> <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span>:
<ul class="doclist">
<li> Again, we could recursively shrink <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span>.

</li>
<li> But we can't shrink <i>to</i> <span class="inlinecode"><span class="id" title="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" title="var">e<sub>2</sub></span></span> since they are of a
        different type.

</li>
<li> For faster shrinking, we can also try to shrink such expressions
        to boolean constants directly. 
</li>
</ul>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="shrink_rec"><span class="id" title="definition">shrink_rec</span></a> (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) (<span class="id" title="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">e<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" title="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" title="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" title="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" title="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Putting it all together yields the following smart shrinker: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> (<span class="id" title="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) (<span class="id" title="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EVar"><span class="id" title="constructor">EVar</span></a> <span class="id" title="var">_</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a><a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> 0<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">[</span></a><a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">;</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#f83abbde7679bdbfec6afddd39d41e<sub>15</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENum"><span class="id" title="constructor">ENum</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a><a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">e<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMinus"><span class="id" title="constructor">EMinus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">e<sub>2</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMinus"><span class="id" title="constructor">EMinus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMinus"><span class="id" title="constructor">EMinus</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMult"><span class="id" title="constructor">EMult</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">e<sub>2</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#EPlus"><span class="id" title="constructor">EPlus</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMult"><span class="id" title="constructor">EMult</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMult"><span class="id" title="constructor">EMult</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ELe"><span class="id" title="constructor">ELe</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="TImp.html#EEq"><span class="id" title="constructor">EEq</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#ELe"><span class="id" title="constructor">ELe</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#ELe"><span class="id" title="constructor">ELe</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENot"><span class="id" title="constructor">ENot</span></a> <span class="id" title="var">e</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> <a class="idref" href="TImp.html#ENot"><span class="id" title="constructor">ENot</span></a> (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EAnd"><span class="id" title="constructor">EAnd</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" title="constructor">ETrue</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" title="constructor">EFalse</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <span class="id" title="var">e<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EAnd"><span class="id" title="constructor">EAnd</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" title="variable">e<sub>1</sub>'</span></a> <span class="id" title="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <span class="id" title="var">e<sub>1</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EAnd"><span class="id" title="constructor">EAnd</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" title="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <span class="id" title="var">e<sub>2</sub></span>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
As we saw for generators, we can also perform sanity checks on our
    shrinkers.  Here, when the shrinker is applied to an expression of
    a given type, all of its results should have the same type. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="shrink_typed_has_type"><span class="id" title="definition">shrink_typed_has_type</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">num_vars</span> := 4 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">top_level_size</span> := 3 <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" title="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" title="variable">num_vars</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <span class="id" title="method">arbitrary</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">T</span> ⇒                                   <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#top_level_size"><span class="id" title="variable">top_level_size</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">me</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" title="variable">me</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">e</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#forallb"><span class="id" title="definition">List.forallb</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">e'</span> ⇒ <span class="id" title="notation">(</span><a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#e'"><span class="id" title="variable">e'</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a><span class="id" title="notation">)?</span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <span class="id" title="var">e</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a> <br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;shrink_typed_has_type.&nbsp;*)</span><br/>
</div>

<div class="doc">
<a name="lab92"></a><h2 class="section">Back to Soundness</h2>
 To lift the shrinker to optional expressions, QuickChick provides
    the following function. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="lift_shrink"><span class="id" title="definition">lift_shrink</span></a> {<span class="id" title="var">A</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">shr</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) (<span class="id" title="var">m</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" title="variable">m</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#map"><span class="id" title="definition">List.map</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#shr"><span class="id" title="variable">shr</span></a> <span class="id" title="var">x</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#145bedf8a5d4a541831f3f70db03085c"><span class="id" title="notation">[]</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Armed with shrinking, we can pinpoint the bug in the <span class="inlinecode"><span class="id" title="var">EAnd</span></span> branch
    of the evaluator. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="expression_soundness_exec'"><span class="id" title="definition">expression_soundness_exec'</span></a> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">num_vars</span> := 4 <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">top_level_size</span> := 3 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" title="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" title="variable">num_vars</span></a>)  (<span class="id" title="keyword">fun</span> <span class="id" title="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> (<a class="idref" href="TImp.html#gen_well_typed_state"><span class="id" title="definition">gen_well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">st</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="definition">forAll</span> <span class="id" title="method">arbitrary</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">T</span> ⇒                                    <br/>
&nbsp;&nbsp;<span class="id" title="definition">forAllShrink</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" title="definition">gen_exp_typed_sized</span></a> 3 <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="TImp.html#lift_shrink"><span class="id" title="definition">lift_shrink</span></a> (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" title="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">me</span> ⇒  <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" title="variable">me</span></a> <span class="id" title="keyword">with</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">e</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> (<a class="idref" href="TImp.html#isNone"><span class="id" title="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e</span>))<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>)))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;expression_soundness_exec'.&nbsp;*)</span><br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<pre>     ===&gt;
        QuickChecking expression_soundness_exec'
        [(1,TNat), (2,TNat), (3,TNat), (4,TBool)]
        [(1,VNat 0), (2,VNat 0), (3,VNat 0), (4,VBool false)]
        TBool
        Some EAnd ETrue ETrue
        *** Failed after 8 tests and 1 shrinks. (0 discards)
</pre>

<div class="paragraph"> </div>

<a name="lab93"></a><h1 class="section">Well-Typed Programs</h1>

<div class="paragraph"> </div>

 Now we're ready to introduce TImp commands; they are just like the
    ones in Imp. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="com"><span class="id" title="inductive">com</span></a> : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="CSkip"><span class="id" title="constructor">CSkip</span></a>  : <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CAss"><span class="id" title="constructor">CAss</span></a>   : <a class="idref" href="TImp.html#id"><span class="id" title="inductive">id</span></a>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CSeq"><span class="id" title="constructor">CSeq</span></a>   : <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CIf"><span class="id" title="constructor">CIf</span></a>    : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CWhile"><span class="id" title="constructor">CWhile</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" title="inductive">exp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a name="a0c711115537068b54b88d30c8f28d4f"><span class="id" title="notation">&quot;</span></a>'SKIP'" :=<br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#CSkip"><span class="id" title="constructor">CSkip</span></a>.<br/>
<span class="id" title="keyword">Notation</span> <a name="e5f90bd3e877d9e98ec926ce1508c97d"><span class="id" title="notation">&quot;</span></a>x '<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>' a" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CAss"><span class="id" title="constructor">CAss</span></a> <span class="id" title="var">x</span> <span class="id" title="var">a</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 60).<br/>
<span class="id" title="keyword">Notation</span> <a name="f5c59c7213f28c578797f53393fa01f<sub>9</sub>"><span class="id" title="notation">&quot;</span></a>c<sub>1</sub> ;;; c<sub>2</sub>" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CSeq"><span class="id" title="constructor">CSeq</span></a> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 80, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>).<br/>
<span class="id" title="keyword">Notation</span> <a name="026553ab2a284931075228151d7b828d"><span class="id" title="notation">&quot;</span></a>'WHILE' b 'DO' c 'END'" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CWhile"><span class="id" title="constructor">CWhile</span></a> <span class="id" title="var">b</span> <span class="id" title="var">c</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 80, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>).<br/>
<span class="id" title="keyword">Notation</span> <a name="20f40a9533f4fed54e57ae8f207d44f<sub>1</sub>"><span class="id" title="notation">&quot;</span></a>'TEST' c<sub>1</sub> 'THEN' c<sub>2</sub> 'ELSE' c<sub>3</sub> 'FI'" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CIf"><span class="id" title="constructor">CIf</span></a> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span> <span class="id" title="var">c<sub>3</sub></span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 80, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="var">Derive</span> <span class="id" title="keyword">Show</span> <span class="id" title="keyword">for</span> <span class="id" title="var">com</span>.<br/>
</div>

<div class="doc">
(Of course, the derived <span class="inlinecode"><span class="id" title="keyword">Show</span></span> instance is not going to use these
    notations!) 
<div class="paragraph"> </div>

 We can now define what it means for a command to be well typed
    for a given context. The interesting cases are <span class="inlinecode"><span class="id" title="var">TAss</span></span> and <span class="inlinecode"><span class="id" title="var">TIf</span></span>/<span class="inlinecode"><span class="id" title="var">TWhile</span></span>. 
    The first one, ensures that the type of the variable we are 
    assigning to is the same as that of the expression. The latter,
    requires that the conditional is indeed a boolean expression.
 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="TSkip"><span class="id" title="constructor">TSkip</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span>, <a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#CSkip"><span class="id" title="constructor">CSkip</span></a><br/>
&nbsp;&nbsp;| <a name="TAss"><span class="id" title="constructor">TAss</span></a>  : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">x</span> <span class="id" title="var">e</span> <span class="id" title="var">T</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#T"><span class="id" title="variable">T</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CAss"><span class="id" title="constructor">CAss</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a>)<br/>
&nbsp;&nbsp;| <a name="TSeq"><span class="id" title="constructor">TSeq</span></a>  : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" title="variable">c<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" title="variable">c<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CSeq"><span class="id" title="constructor">CSeq</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" title="variable">c<sub>1</sub></span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" title="variable">c<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;| <a name="TIf"><span class="id" title="constructor">TIf</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">b</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="var">c<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#b"><span class="id" title="variable">b</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" title="variable">c<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" title="variable">c<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CIf"><span class="id" title="constructor">CIf</span></a> <a class="idref" href="TImp.html#b"><span class="id" title="variable">b</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" title="variable">c<sub>1</sub></span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" title="variable">c<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;| <a name="TWhile"><span class="id" title="constructor">TWhile</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">b</span> <span class="id" title="var">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">|&#x22A2;</span></a> <a class="idref" href="TImp.html#b"><span class="id" title="variable">b</span></a> <a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">\</span></a><a class="idref" href="TImp.html#dc88b70a058259554e751847ac5d303f"><span class="id" title="notation">IN</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CWhile"><span class="id" title="constructor">CWhile</span></a> <a class="idref" href="TImp.html#b"><span class="id" title="variable">b</span></a> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a>).<br/>
</div>

<div class="doc">
<a name="lab94"></a><h2 class="section">Decidable instance for well-typed.</h2>

<div class="paragraph"> </div>

 A couple of lemmas and a custom tactic will help the decidability
    proof... 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Lemma</span> <a name="bind_deterministic"><span class="id" title="lemma">bind_deterministic</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">x</span> (<span class="id" title="var">T<sub>1</sub></span> <span class="id" title="var">T<sub>2</sub></span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) :<br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" title="variable">T<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" title="variable">T<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" title="variable">T<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" title="variable">T<sub>2</sub></span></a>.<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">T<sub>1</sub></span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">T<sub>2</sub></span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">H<sub>1</sub></span> <span class="id" title="var">H<sub>2</sub></span>; <span class="id" title="tactic">eauto</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion</span> <span class="id" title="var">H<sub>1</sub></span>; <span class="id" title="tactic">inversion</span> <span class="id" title="var">H<sub>2</sub></span>; <span class="id" title="tactic">congruence</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Lemma</span> <a name="has_type_deterministic"><span class="id" title="lemma">has_type_deterministic</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">e</span> (<span class="id" title="var">T<sub>1</sub></span> <span class="id" title="var">T<sub>2</sub></span> : <a class="idref" href="TImp.html#ty"><span class="id" title="inductive">ty</span></a>) : <br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" title="variable">T<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <a class="idref" href="TImp.html#e"><span class="id" title="variable">e</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" title="variable">T<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" title="variable">T<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" title="variable">T<sub>2</sub></span></a>.<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">T<sub>1</sub></span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">T<sub>2</sub></span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">H<sub>1</sub></span> <span class="id" title="var">H<sub>2</sub></span>; <span class="id" title="tactic">eauto</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">inversion</span> <span class="id" title="var">H<sub>1</sub></span>; <span class="id" title="tactic">inversion</span> <span class="id" title="var">H<sub>2</sub></span>; <span class="id" title="tactic">subst</span>; <span class="id" title="tactic">eauto</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>;<br/>
&nbsp;&nbsp;<span class="id" title="tactic">inversion</span> <span class="id" title="var">H<sub>7</sub></span>; <span class="id" title="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> <a class="idref" href="TImp.html#bind_deterministic"><span class="id" title="lemma">bind_deterministic</span></a>; <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">solve_det</span> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| [ <span class="id" title="var">H<sub>1</sub></span> : <a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ?<span class="id" title="var">T<sub>1</sub></span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H<sub>2</sub></span> : <a class="idref" href="TImp.html#bound_to"><span class="id" title="inductive">bound_to</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ?<span class="id" title="var">T<sub>2</sub></span> &#x22A2; <span class="id" title="var">_</span> ] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">T<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">T<sub>2</sub></span>) <span class="id" title="tactic">by</span> (<span class="id" title="tactic">eapply</span> <a class="idref" href="TImp.html#bind_deterministic"><span class="id" title="lemma">bind_deterministic</span></a>; <span class="id" title="tactic">eauto</span>)<br/>
&nbsp;&nbsp;| [ <span class="id" title="var">H<sub>1</sub></span> : <a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ?<span class="id" title="var">T<sub>1</sub></span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H<sub>2</sub></span> : <a class="idref" href="TImp.html#has_type"><span class="id" title="inductive">has_type</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ?<span class="id" title="var">T<sub>2</sub></span> &#x22A2; <span class="id" title="var">_</span> ] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">T<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">T<sub>2</sub></span>) <span class="id" title="tactic">by</span> (<span class="id" title="tactic">eapply</span> <a class="idref" href="TImp.html#bind_deterministic"><span class="id" title="lemma">bind_deterministic</span></a>; <span class="id" title="tactic">eauto</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Now, here is a brute-force decision procedure for the typing
    relation (which amounts to a simple typechecker). 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Instance</span> <a name="dec_well_typed_com"><span class="id" title="instance">dec_well_typed_com</span></a> (<span class="id" title="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" title="definition">context</span></a>) (<span class="id" title="var">c</span> : <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a>) <br/>
&nbsp;&nbsp;: <span class="id" title="class">Dec</span> (<a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a>).<br/>
<div class="togglescript" id="proofcontrol7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')"><span class="show"></span></div>
<div class="proofscript" id="proof7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')">
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">with</span> <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ssr.ssrbool.html#decidable"><span class="id" title="definition">ssrbool.decidable</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">c</span>; <span class="id" title="var">solve_sum</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_bound_to"><span class="id" title="instance">dec_bound_to</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">i</span> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" title="instance">dec_has_type</span></a> <span class="id" title="var">e</span> <span class="id" title="var">Gamma</span> <a class="idref" href="TImp.html#TNat"><span class="id" title="constructor">TNat</span></a>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_bound_to"><span class="id" title="instance">dec_bound_to</span></a> <span class="id" title="var">Gamma</span> <span class="id" title="var">i</span> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" title="instance">dec_has_type</span></a> <span class="id" title="var">e</span> <span class="id" title="var">Gamma</span> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>; <span class="id" title="var">solve_sum</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="var">solve_det</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">right</span>; <span class="id" title="tactic">intro</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">inversion</span> <span class="id" title="var">Contra</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="tactic">clear</span> <span class="id" title="var">Contra</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="var">solve_det</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">congruence</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">T</span>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">IHc1</span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">IHc2</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="tactic">eauto</span>; <span class="id" title="var">solve_sum</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">IHc1</span>; <span class="id" title="tactic">destruct</span> <span class="id" title="var">IHc2</span>; <span class="id" title="tactic">subst</span>; <span class="id" title="tactic">eauto</span>; <span class="id" title="var">solve_sum</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" title="instance">dec_has_type</span></a> <span class="id" title="var">e</span> <span class="id" title="var">Gamma</span> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>; <span class="id" title="var">solve_sum</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">IHc</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" title="instance">dec_has_type</span></a> <span class="id" title="var">e</span> <span class="id" title="var">Gamma</span> <a class="idref" href="TImp.html#TBool"><span class="id" title="constructor">TBool</span></a>); <span class="id" title="tactic">destruct</span> <span class="id" title="var">dec</span>; <span class="id" title="var">solve_sum</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab95"></a><h4 class="section">练习：4 星, standard (arbitrary_well_typed_com)</h4>
 Write a generator and a shrinker for well_typed programs given
    some context <span class="inlinecode"><span class="id" title="var">Gamma</span></span>.  Write some appropriate sanity checks and
    make sure they give expected results. 
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span><br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 To complete the tour of testing for TImp, here is a (buggy??)
    evaluation function for commands given a state. To ensure
    termination, we've included a "fuel" parameter: if it gets to zero
    we return <span class="inlinecode"><span class="id" title="var">OutOfGas</span></span>, signifying that we're not sure if evaluation
    would have succeeded, failed, or diverged if we'd gone on
    evaluating. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="result"><span class="id" title="inductive">result</span></a> := <br/>
| <a name="Success"><span class="id" title="constructor">Success</span></a> : <a class="idref" href="TImp.html#state"><span class="id" title="definition">state</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#result"><span class="id" title="inductive">result</span></a><br/>
| <a name="Fail"><span class="id" title="constructor">Fail</span></a> : <a class="idref" href="TImp.html#result"><span class="id" title="inductive">result</span></a> <br/>
| <a name="OutOfGas"><span class="id" title="constructor">OutOfGas</span></a> : <a class="idref" href="TImp.html#result"><span class="id" title="inductive">result</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a name="ceval"><span class="id" title="definition">ceval</span></a> (<span class="id" title="var">fuel</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) (<span class="id" title="var">st</span> : <a class="idref" href="TImp.html#state"><span class="id" title="definition">state</span></a>) (<span class="id" title="var">c</span> : <a class="idref" href="TImp.html#com"><span class="id" title="inductive">com</span></a>) : <a class="idref" href="TImp.html#result"><span class="id" title="inductive">result</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#fuel"><span class="id" title="variable">fuel</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#O"><span class="id" title="constructor">O</span></a> ⇒ <a class="idref" href="TImp.html#OutOfGas"><span class="id" title="constructor">OutOfGas</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <span class="id" title="var">fuel'</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#a0c711115537068b54b88d30c8f28d4f"><span class="id" title="notation">SKIP</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Success"><span class="id" title="constructor">Success</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">x</span> <a class="idref" href="TImp.html#e5f90bd3e877d9e98ec926ce1508c97d"><span class="id" title="notation"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span></span></a> <span class="id" title="var">e</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="TImp.html#Success"><span class="id" title="constructor">Success</span></a> (<a class="idref" href="TImp.html#map_set"><span class="id" title="definition">map_set</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">x</span> <span class="id" title="var">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" title="constructor">Fail</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">c<sub>1</sub></span> <a class="idref" href="TImp.html#f5c59c7213f28c578797f53393fa01f<sub>9</sub>"><span class="id" title="notation">;;;</span></a> <span class="id" title="var">c<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#ceval"><span class="id" title="definition">ceval</span></a> <span class="id" title="var">fuel'</span> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#Success"><span class="id" title="constructor">Success</span></a> <span class="id" title="var">st'</span> ⇒  <a class="idref" href="TImp.html#ceval"><span class="id" title="definition">ceval</span></a> <span class="id" title="var">fuel'</span> <span class="id" title="var">st'</span> <span class="id" title="var">c<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" title="constructor">Fail</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#20f40a9533f4fed54e57ae8f207d44f<sub>1</sub>"><span class="id" title="notation">TEST</span></a> <span class="id" title="var">b</span> <a class="idref" href="TImp.html#20f40a9533f4fed54e57ae8f207d44f<sub>1</sub>"><span class="id" title="notation">THEN</span></a> <span class="id" title="var">c<sub>1</sub></span> <a class="idref" href="TImp.html#20f40a9533f4fed54e57ae8f207d44f<sub>1</sub>"><span class="id" title="notation">ELSE</span></a> <span class="id" title="var">c<sub>2</sub></span> <a class="idref" href="TImp.html#20f40a9533f4fed54e57ae8f207d44f<sub>1</sub>"><span class="id" title="notation">FI</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">b</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <span class="id" title="var">b</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ceval"><span class="id" title="definition">ceval</span></a> <span class="id" title="var">fuel'</span> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> (<span class="id" title="keyword">if</span> <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> <span class="id" title="var">c<sub>1</sub></span> <span class="id" title="keyword">else</span> <span class="id" title="var">c<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" title="constructor">Fail</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#026553ab2a284931075228151d7b828d"><span class="id" title="notation">WHILE</span></a> <span class="id" title="var">b</span> <a class="idref" href="TImp.html#026553ab2a284931075228151d7b828d"><span class="id" title="notation">DO</span></a> <span class="id" title="var">c</span> <a class="idref" href="TImp.html#026553ab2a284931075228151d7b828d"><span class="id" title="notation">END</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <span class="id" title="var">b</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" title="constructor">VBool</span></a> <span class="id" title="var">b'</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">b'</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="TImp.html#ceval"><span class="id" title="definition">ceval</span></a> <span class="id" title="var">fuel'</span> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> (<a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="TImp.html#f5c59c7213f28c578797f53393fa01f<sub>9</sub>"><span class="id" title="notation">;;;</span></a> <a class="idref" href="TImp.html#026553ab2a284931075228151d7b828d"><span class="id" title="notation">WHILE</span></a> <span class="id" title="var">b</span> <a class="idref" href="TImp.html#026553ab2a284931075228151d7b828d"><span class="id" title="notation">DO</span></a> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="TImp.html#026553ab2a284931075228151d7b828d"><span class="id" title="notation">END</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="TImp.html#Success"><span class="id" title="constructor">Success</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" title="constructor">Fail</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="isFail"><span class="id" title="definition">isFail</span></a> <span class="id" title="var">r</span> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="TImp.html#r"><span class="id" title="variable">r</span></a> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#Fail"><span class="id" title="constructor">Fail</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<i>Type soundness</i>: well-typed commands never fail. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Conjecture</span> <a name="well_typed_state_never_stuck"><span class="id" title="axiom">well_typed_state_never_stuck</span></a> : <br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">st</span>, <a class="idref" href="TImp.html#well_typed_state"><span class="id" title="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">c</span>, <a class="idref" href="TImp.html#well_typed_com"><span class="id" title="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" title="variable">Gamma</span></a> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">fuel</span>, <a class="idref" href="TImp.html#isFail"><span class="id" title="definition">isFail</span></a> (<a class="idref" href="TImp.html#ceval"><span class="id" title="definition">ceval</span></a> <a class="idref" href="TImp.html#fuel"><span class="id" title="variable">fuel</span></a> <a class="idref" href="TImp.html#st"><span class="id" title="variable">st</span></a> <a class="idref" href="TImp.html#c"><span class="id" title="variable">c</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a>.<br/>
</div>

<div class="doc">
<a name="lab96"></a><h4 class="section">练习：4 星, standard (well_typed_state_never_stuck)</h4>
 Write a checker for the above property, find any bugs, and fix them. 
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span><br/>
</div>

<div class="doc">
<a name="lab97"></a><h4 class="section">练习：4 星, standard (ty_eq_polymorphic)</h4>
 In the <span class="inlinecode"><span class="id" title="var">has_type</span></span> relation we allowed equality checks between 
    only arithmetic expressions. Introduce an additional typing 
    rule that allows for equality checks between booleans.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Ty_Eq</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">Gamma</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Gamma</span> |&#x22A2; <span class="id" title="var">e<sub>1</sub></span> \<span class="id" title="var">IN</span> <span class="id" title="var">TBool</span> → <span class="id" title="var">Gamma</span> |&#x22A2; <span class="id" title="var">e<sub>2</sub></span> \<span class="id" title="var">IN</span> <span class="id" title="var">TBool</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Gamma</span> |&#x22A2; <span class="id" title="var">EEq</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> \<span class="id" title="var">IN</span> <span class="id" title="var">TBool</span>
<div class="paragraph"> </div>

</span>   Make sure you also update the evaluation relation to 
   compare boolean values. Update the generators and shrinkers
   accordingly to find counterexamples to the buggy properties
   above. 

<div class="paragraph"> </div>

   HINT: When updating the shrinker, you will need to 
   come up with the type of the equated expressions. The 
   <span class="inlinecode"><span class="id" title="var">Dec</span></span> instance of <span class="inlinecode"><span class="id" title="var">has_type</span></span> will come in handy.

<div class="paragraph"> </div>

<a name="lab98"></a><h1 class="section">Automation (Revisited)</h1>

<div class="paragraph"> </div>

 QuickChick is under very active development.  Our vision is that
    it should automate most of the tedious parts of testing, while
    retaining full customizability.

<div class="paragraph"> </div>

    We close this case study with a brief demo of some things it can
    do now. 
<div class="paragraph"> </div>

 Recall the <span class="inlinecode"><span class="id" title="var">has_type_value</span></span> property and its corresponding generator:
<br/>
<span class="inlinecode">&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">has_type_value</span> : <span class="id" title="var">value</span> → <span class="id" title="var">ty</span> → <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">TyVNat</span>  : <span class="id" title="keyword">∀</span> <span class="id" title="var">n</span>, <span class="id" title="var">has_type_value</span> (<span class="id" title="var">VNat</span>  <span class="id" title="var">n</span>) <span class="id" title="var">TNat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">TyVBool</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">b</span>, <span class="id" title="var">has_type_value</span> (<span class="id" title="var">VBool</span> <span class="id" title="var">b</span>) <span class="id" title="var">TBool</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">gen_typed_value</span> (<span class="id" title="var">T</span> : <span class="id" title="var">ty</span>) : <span class="id" title="var">G</span> <span class="id" title="var">value</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">T</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">TNat</span>  ⇒ <span class="id" title="var">n</span> &lt;- <span class="id" title="var">arbitrary</span>;; <span class="id" title="var">ret</span> (<span class="id" title="var">VNat</span> <span class="id" title="var">n</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">TBool</span> ⇒ <span class="id" title="var">b</span> &lt;- <span class="id" title="var">arbitrary</span>;; <span class="id" title="var">ret</span> (<span class="id" title="var">VBool</span> <span class="id" title="var">b</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
<div class="paragraph"> </div>

</span>    QuickChick includes a derivation mechanism that can <i>automatically</i>
    produce such generators -- i.e., generators for data structures 
    satisfying inductively defined properties! 
</div>
<div class="code">

<br/>
<span class="id" title="var">Derive</span> <span class="id" title="var">ArbitrarySizedSuchThat</span> <span class="id" title="keyword">for</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">has_type_value</span> <span class="id" title="var">v</span> <span class="id" title="var">T</span>).<br/>
</div>

<div class="doc">
===&gt; 
  GenSizedSuchThathas_type_value is defined. 
<div class="paragraph"> </div>

 Let's take a closer look at what is being generated (after 
    doing some renaming and reformatting). 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Print</span> <a class="idref" href="TImp.html#GenSizedSuchThathas_type_value"><span class="id" title="instance">GenSizedSuchThathas_type_value</span></a>.<br/>
</div>

<div class="doc">
<pre>     ===&gt;
       GenSizedSuchThathas_type_value = fun T : ty =&gt;
       {| arbitrarySizeST := 
          let fix aux_arb (size0 : nat) (T : ty) {struct size0} 
                : G (option value) :=
            match size0 with
            | 0 =&gt; backtrack [(1, match T with
                                  | TBool =&gt; ret None
                                  | TNat =&gt; n &lt;- arbitrary;;
                                            ret (Some (VNat n))
                                  end)
                             ;(1, match T with
                                  | TBool =&gt; b &lt;- arbitrary;;
                                             ret (Some (VBool b)))
                                  | TNat =&gt; ret None
                                  end)]
            | S _ =&gt; backtrack [(1, match T with
                                    | TBool =&gt; ret None
                                    | TNat =&gt; n &lt;- arbitrary;;
                                              ret (Some (VNat n))
                                    end)
                               ;(1, match T with
                                    | TBool =&gt; b &lt;- arbitrary;;
                                               ret (Some (VBool b)))
                                    | TNat =&gt; ret None
                                    end)]
            end in
            fun size0 : nat =&gt; aux_arb size0 T |}

       : forall T : ty,
           GenSizedSuchThat value 
               (fun v =&gt; has_type_value v T)
</pre>

<div class="paragraph"> </div>

 This is a rather more verbose version of the <span class="inlinecode"><span class="id" title="var">gen_typed_value</span></span>
    generator, but the end result is actually exactly the same 
    distribution! 
<div class="paragraph"> </div>

<a name="lab99"></a><h2 class="section">(More) Typeclasses for Generation</h2>

<div class="paragraph"> </div>

 QuickChick provides typeclasses for automating the generation 
    for data satisfying predicates. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Module</span> <a name="GenSTPlayground"><span class="id" title="module">GenSTPlayground</span></a>.<br/>
</div>

<div class="doc">
A variant that takes a size,... 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Class</span> <a name="GenSTPlayground.GenSizedSuchThat"><span class="id" title="record">GenSizedSuchThat</span></a> (<span class="id" title="var">A</span> : <span class="id" title="keyword">Type</span>) (<span class="id" title="var">P</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) := <br/>
&nbsp;&nbsp;{ <a name="GenSTPlayground.arbitrarySizeST"><span class="id" title="projection">arbitrarySizeST</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) }.<br/>
</div>

<div class="doc">
...an unsized variant,... 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Class</span> <a name="GenSTPlayground.GenSuchThat"><span class="id" title="record">GenSuchThat</span></a> (<span class="id" title="var">A</span> : <span class="id" title="keyword">Type</span>) (<span class="id" title="var">P</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) := <br/>
&nbsp;&nbsp;{ <a name="GenSTPlayground.arbitraryST"><span class="id" title="projection">arbitraryST</span></a> : <span class="id" title="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a>) }.<br/>
</div>

<div class="doc">
...convenient notation,... 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Notation</span> <a name="3735c6680cb067540abf741f360c9692"><span class="id" title="notation">&quot;</span></a>'genST' x" := (@<a class="idref" href="TImp.html#GenSTPlayground.arbitraryST"><span class="id" title="method">arbitraryST</span></a> <span class="id" title="var">_</span> <span class="id" title="var">x</span> <span class="id" title="var">_</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 70).<br/>
</div>

<div class="doc">
...and a coercion between the two: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Instance</span> <a name="GenSTPlayground.GenSuchThatOfBounded"><span class="id" title="instance">GenSuchThatOfBounded</span></a> (<span class="id" title="var">A</span> : <span class="id" title="keyword">Type</span>) (<span class="id" title="var">P</span> : <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">H</span> : <a class="idref" href="TImp.html#GenSTPlayground.GenSizedSuchThat"><span class="id" title="class">GenSizedSuchThat</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="TImp.html#P"><span class="id" title="variable">P</span></a>)<br/>
&nbsp;&nbsp;: <a class="idref" href="TImp.html#GenSTPlayground.GenSuchThat"><span class="id" title="class">GenSuchThat</span></a> <a class="idref" href="TImp.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="TImp.html#P"><span class="id" title="variable">P</span></a> := <br/>
&nbsp;&nbsp;{ <a class="idref" href="TImp.html#GenSTPlayground.arbitraryST"><span class="id" title="method">arbitraryST</span></a> := <span class="id" title="axiom">sized</span> <a class="idref" href="TImp.html#GenSTPlayground.arbitrarySizeST"><span class="id" title="method">arbitrarySizeST</span></a> }.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="TImp.html#GenSTPlayground"><span class="id" title="module">GenSTPlayground</span></a>.<br/>
</div>

<div class="doc">
<a name="lab100"></a><h2 class="section">Using "SuchThat" Typeclasses</h2>

<div class="paragraph"> </div>

 QuickChick can now (ab)use the typeclass resolution mechanism to 
    perform a bit of black magic: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Conjecture</span> <a name="conditional_prop_example"><span class="id" title="axiom">conditional_prop_example</span></a> : <br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span> <span class="id" title="var">y</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>), <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#y"><span class="id" title="variable">y</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="TImp.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="TImp.html#y"><span class="id" title="variable">y</span></a>.<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;conditional_prop_example.&nbsp;*)</span><br/>
</div>

<div class="doc">
<pre>
  ==&gt;
    QuickChecking conditional_prop_example
    +++ Passed 10000 tests (0 discards)
</pre>

<div class="paragraph"> </div>

 Notice the "0 discards": that means that quickchick is using
    generators that produce <span class="inlinecode"><span class="id" title="var">x</span></span> and <span class="inlinecode"><span class="id" title="var">y</span></span> such that <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">y</span></span>! 
<div class="paragraph"> </div>

<a name="lab101"></a><h1 class="section">Acknowledgements</h1>

<div class="paragraph"> </div>

 The first version of this material was developed in collaboration
    with Nicolas Koh. 
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;2021-08-22&nbsp;05:59:47&nbsp;(UTC+00)&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>
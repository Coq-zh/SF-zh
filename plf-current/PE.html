<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="common/css/sf.css" rel="stylesheet" type="text/css"/>
<title>PE: Partial Evaluation</title>
</head>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/plf.css" rel="stylesheet" type="text/css"/>

<body>

<div id="page">

<div id="header">
<a href='https://www.cis.upenn.edu/~bcpierce/sf/current/index.html'>
<img src='common/media/image/sf_logo_sm.png'></a>
</br><a href='index.html'>  <span class='booktitleinheader'>Volume 2: Programming Language Foundations</span><br></br>
<ul id='menu'>
   <a href='toc.html'><li class='section_name'>目录</li></a>
   <a href='coqindex.html'><li class='section_name'>索引</li></a>
   <a href='deps.html'><li class='section_name'>路线</li></a>
</ul>
</a></div>

<div id="main">

<h1 class="libtitle">PE<span class="subtitle">Partial Evaluation</span></h1>


<div class="code code-tight">

<span class="comment">(*&nbsp;Chapter&nbsp;written&nbsp;and&nbsp;maintained&nbsp;by&nbsp;Chung-chieh&nbsp;Shan&nbsp;*)</span><br/>
</div>

<div class="doc">
The <a href="Equiv.html"><span class="inlineref">Equiv</span></a> chapter introduced constant folding as an example of a
    program transformation and proved that it preserves the meaning of
    programs.  Constant folding operates on manifest constants such as
    <span class="inlinecode"><span class="id" type="var">ANum</span></span> expressions.  For example, it simplifies the command <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span></span>
    <span class="inlinecode">3</span> <span class="inlinecode">+</span> <span class="inlinecode">1</span> to the command <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span></span> <span class="inlinecode">4</span>.  However,
    it does not propagate known constants along data flow.  For
    example, it does not simplify the sequence

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1
<div class="paragraph"> </div>

</div>
    to

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4
<div class="paragraph"> </div>

</div>
    because it forgets that <span class="inlinecode"><span class="id" type="var">X</span></span> is <span class="inlinecode">3</span> by the time it gets to <span class="inlinecode"><span class="id" type="var">Y</span></span>.

<div class="paragraph"> </div>

    We might naturally want to enhance constant folding so that it
    propagates known constants and uses them to simplify programs.
    Doing so constitutes a rudimentary form of _partial evaluation_.
    As we will see, partial evaluation is so called because it is like
    running a program, except only part of the program can be
    evaluated because only part of the input to the program is known.
    For example, we can only simplify the program

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;(<span class="id" type="var">X</span>&nbsp;+&nbsp;1)&nbsp;-&nbsp;<span class="id" type="var">Y</span>
<div class="paragraph"> </div>

</div>
    to

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4&nbsp;-&nbsp;<span class="id" type="var">Y</span>
<div class="paragraph"> </div>

</div>
    without knowing the initial value of <span class="inlinecode"><span class="id" type="var">Y</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Coq.Bool.Bool</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Coq.Arith.Arith</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Coq.Arith.EqNat</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Coq.omega.Omega</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Coq.Logic.FunctionalExtensionality</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Coq.Lists.List</span>.<br/>
<span class="id" type="keyword">Import</span> <span class="id" type="var">ListNotations</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Maps</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Imp</span>.<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Import</span> <span class="id" type="var">Smallstep</span>.<br/>
</div>

<div class="doc">
<a name="lab569"></a><h1 class="section">Generalizing Constant Folding</h1>

<div class="paragraph"> </div>

 The starting point of partial evaluation is to represent our
    partial knowledge about the state.  For example, between the two
    assignments above, the partial evaluator may know only that <span class="inlinecode"><span class="id" type="var">X</span></span> is
    <span class="inlinecode">3</span> and nothing about any other variable. 
<div class="paragraph"> </div>

<a name="lab570"></a><h2 class="section">Partial States</h2>

<div class="paragraph"> </div>

 Conceptually speaking, we can think of such partial states as the
    type <span class="inlinecode"><span class="id" type="var">string</span></span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" type="var">option</span></span> <span class="inlinecode"><span class="id" type="var">nat</span></span> (as opposed to the type <span class="inlinecode"><span class="id" type="var">string</span></span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" type="var">nat</span></span> of
    concrete, full states).  However, in addition to looking up and
    updating the values of individual variables in a partial state, we
    may also want to compare two partial states to see if and where
    they differ, to handle conditional control flow.  It is not possible
    to compare two arbitrary functions in this way, so we represent
    partial states in a more concrete format: as a list of <span class="inlinecode"><span class="id" type="var">string</span></span> <span class="inlinecode">*</span> <span class="inlinecode"><span class="id" type="var">nat</span></span>
    pairs. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">pe_state</span> := <span class="id" type="var">list</span> (<span class="id" type="var">string</span> * <span class="id" type="var">nat</span>).<br/>
</div>

<div class="doc">
The idea is that a variable (of type <span class="inlinecode"><span class="id" type="var">string</span></span>) appears in the list if and only
    if we know its current <span class="inlinecode"><span class="id" type="var">nat</span></span> value.  The <span class="inlinecode"><span class="id" type="var">pe_lookup</span></span> function thus
    interprets this concrete representation.  (If the same variable
    appears multiple times in the list, the first occurrence
    wins, but we will define our partial evaluator to never construct
    such a <span class="inlinecode"><span class="id" type="var">pe_state</span></span>.) 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_lookup</span> (<span class="id" type="var">pe_st</span> : <span class="id" type="var">pe_state</span>) (<span class="id" type="var">V</span>:<span class="id" type="var">string</span>) : <span class="id" type="var">option</span> <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_st</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ <span class="id" type="var">None</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">V'</span>,<span class="id" type="var">n'</span>)::<span class="id" type="var">pe_st</span> ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">Some</span> <span class="id" type="var">n'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
For example, <span class="inlinecode"><span class="id" type="var">empty_pe_state</span></span> represents complete ignorance about
    every variable &mdash; the function that maps every identifier to <span class="inlinecode"><span class="id" type="var">None</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">empty_pe_state</span> : <span class="id" type="var">pe_state</span> := [].<br/>
</div>

<div class="doc">
More generally, if the <span class="inlinecode"><span class="id" type="var">list</span></span> representing a <span class="inlinecode"><span class="id" type="var">pe_state</span></span> does not
    contain some identifier, then that <span class="inlinecode"><span class="id" type="var">pe_state</span></span> must map that identifier to
    <span class="inlinecode"><span class="id" type="var">None</span></span>.  Before we prove this fact, we first define a useful
    tactic for reasoning with <span class="inlinecode"><span class="id" type="var">string</span></span> equality.  The tactic

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">compare</span>&nbsp;<span class="id" type="var">V</span>&nbsp;<span class="id" type="var">V'</span>
<div class="paragraph"> </div>

</div>
    means to reason by cases over <span class="inlinecode"><span class="id" type="var">beq_string</span></span> <span class="inlinecode"><span class="id" type="var">V</span></span> <span class="inlinecode"><span class="id" type="var">V'</span></span>.
    In the case where <span class="inlinecode"><span class="id" type="var">V</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">V'</span></span>, the tactic
    substitutes <span class="inlinecode"><span class="id" type="var">V</span></span> for <span class="inlinecode"><span class="id" type="var">V'</span></span> throughout. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Tactic Notation</span> "compare" <span class="id" type="var">ident</span>(<span class="id" type="var">i</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">j</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">H</span> := <span class="id" type="tactic">fresh</span> "Heq" <span class="id" type="var">i</span> <span class="id" type="var">j</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_stringP</span> <span class="id" type="var">i</span> <span class="id" type="var">j</span>);<br/>
&nbsp;&nbsp;[ <span class="id" type="tactic">subst</span> <span class="id" type="var">j</span> | ].<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_domain</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> = <span class="id" type="var">Some</span> <span class="id" type="var">n</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">V</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">pe_st</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">pe_st</span> <span class="id" type="keyword">as</span> [| [<span class="id" type="var">V'</span> <span class="id" type="var">n'</span>] <span class="id" type="var">pe_st</span>].<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;<span class="inlinecode"></span>&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;::&nbsp;*)</span> <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="var">compare</span> <span class="id" type="var">V</span> <span class="id" type="var">V'</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
In what follows, we will make heavy use of the <span class="inlinecode"><span class="id" type="var">In</span></span> property from
    the standard library, also defined in <span class="inlinecode"><span class="id" type="var">Logic.v</span></span>: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Print</span> <span class="id" type="var">In</span>.<br/>
<span class="comment">(*&nbsp;===&gt;&nbsp;Fixpoint&nbsp;In&nbsp;{A:Type}&nbsp;(a:&nbsp;A)&nbsp;(l:list&nbsp;A)&nbsp;:&nbsp;Prop&nbsp;:=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;l&nbsp;with<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="inlinecode"></span>&nbsp;=&gt;&nbsp;False<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;b&nbsp;::&nbsp;m&nbsp;=&gt;&nbsp;b&nbsp;=&nbsp;a&nbsp;\/&nbsp;In&nbsp;a&nbsp;m<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;forall&nbsp;A&nbsp;:&nbsp;Type,&nbsp;A&nbsp;-&gt;&nbsp;list&nbsp;A&nbsp;-&gt;&nbsp;Prop&nbsp;*)</span><br/>
</div>

<div class="doc">
Besides the various lemmas about <span class="inlinecode"><span class="id" type="var">In</span></span> that we've already come
    across, the following one (taken from the standard library) will
    also be useful: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Check</span> <span class="id" type="var">filter_In</span>.<br/>
<span class="comment">(*&nbsp;===&gt;&nbsp;filter_In&nbsp;:&nbsp;forall&nbsp;(A&nbsp;:&nbsp;Type)&nbsp;(f&nbsp;:&nbsp;A&nbsp;-&gt;&nbsp;bool)&nbsp;(x&nbsp;:&nbsp;A)&nbsp;(l&nbsp;:&nbsp;list&nbsp;A),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;x&nbsp;(filter&nbsp;f&nbsp;l)&nbsp;&lt;-&gt;&nbsp;In&nbsp;x&nbsp;l&nbsp;/\&nbsp;f&nbsp;x&nbsp;=&nbsp;true&nbsp;&nbsp;*)</span><br/>
</div>

<div class="doc">
If a type <span class="inlinecode"><span class="id" type="var">A</span></span> has an operator <span class="inlinecode"><span class="id" type="var">beq</span></span> for testing equality of its
    elements, we can compute a boolean <span class="inlinecode"><span class="id" type="var">inb</span></span> <span class="inlinecode"><span class="id" type="var">beq</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> <span class="inlinecode"><span class="id" type="var">l</span></span> for testing
    whether <span class="inlinecode"><span class="id" type="var">In</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> <span class="inlinecode"><span class="id" type="var">l</span></span> holds or not. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">inb</span> {<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>} (<span class="id" type="var">beq</span> : <span class="id" type="var">A</span> → <span class="id" type="var">A</span> → <span class="id" type="var">bool</span>) (<span class="id" type="var">a</span> : <span class="id" type="var">A</span>) (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">A</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">a'</span>::<span class="id" type="var">l'</span> ⇒ <span class="id" type="var">beq</span> <span class="id" type="var">a</span> <span class="id" type="var">a'</span> || <span class="id" type="var">inb</span> <span class="id" type="var">beq</span> <span class="id" type="var">a</span> <span class="id" type="var">l'</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
It is easy to relate <span class="inlinecode"><span class="id" type="var">inb</span></span> to <span class="inlinecode"><span class="id" type="var">In</span></span> with the <span class="inlinecode"><span class="id" type="var">reflect</span></span> property: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Lemma</span> <span class="id" type="var">inbP</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>, <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">beq</span> : <span class="id" type="var">A</span>→<span class="id" type="var">A</span>→<span class="id" type="var">bool</span>,<br/>
&nbsp;&nbsp;(<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span>, <span class="id" type="var">reflect</span> (<span class="id" type="var">a<sub>1</sub></span> = <span class="id" type="var">a<sub>2</sub></span>) (<span class="id" type="var">beq</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span>)) →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>, <span class="id" type="var">reflect</span> (<span class="id" type="var">In</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>) (<span class="id" type="var">inb</span> <span class="id" type="var">beq</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">A</span> <span class="id" type="var">beq</span> <span class="id" type="var">beqP</span> <span class="id" type="var">a</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [|<span class="id" type="var">a'</span> <span class="id" type="var">l'</span> <span class="id" type="var">IH</span>].<br/>
&nbsp;&nbsp;- <span class="id" type="var">constructor</span>. <span class="id" type="tactic">intros</span> [].<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">beqP</span> <span class="id" type="var">a</span> <span class="id" type="var">a'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">subst</span>. <span class="id" type="var">constructor</span>. <span class="id" type="var">left</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">IH</span>; <span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id" type="var">right</span>. <span class="id" type="tactic">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id" type="tactic">intros</span> [<span class="id" type="var">H<sub>1</sub></span> | <span class="id" type="var">H<sub>2</sub></span>]; <span class="id" type="tactic">congruence</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab571"></a><h2 class="section">Arithmetic Expressions</h2>

<div class="paragraph"> </div>

 Partial evaluation of <span class="inlinecode"><span class="id" type="var">aexp</span></span> is straightforward &mdash; it is basically
    the same as constant folding, <span class="inlinecode"><span class="id" type="var">fold_constants_aexp</span></span>, except that
    sometimes the partial state tells us the current value of a
    variable and we can replace it by a constant expression. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_aexp</span> (<span class="id" type="var">pe_st</span> : <span class="id" type="var">pe_state</span>) (<span class="id" type="var">a</span> : <span class="id" type="var">aexp</span>) : <span class="id" type="var">aexp</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">a</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">ANum</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AId</span> <span class="id" type="var">i</span> ⇒ <span class="id" type="keyword">match</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">i</span> <span class="id" type="keyword">with</span> <span class="comment">(*&nbsp;&lt;-----&nbsp;NEW&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">ANum</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">AId</span> <span class="id" type="var">i</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>, <span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <span class="id" type="var">ANum</span> (<span class="id" type="var">n<sub>1</sub></span> + <span class="id" type="var">n<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a<sub>1</sub>'</span>, <span class="id" type="var">a<sub>2</sub>'</span>) ⇒ <span class="id" type="var">APlus</span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">a<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>, <span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <span class="id" type="var">ANum</span> (<span class="id" type="var">n<sub>1</sub></span> - <span class="id" type="var">n<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a<sub>1</sub>'</span>, <span class="id" type="var">a<sub>2</sub>'</span>) ⇒ <span class="id" type="var">AMinus</span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">a<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>, <span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <span class="id" type="var">ANum</span> (<span class="id" type="var">n<sub>1</sub></span> * <span class="id" type="var">n<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a<sub>1</sub>'</span>, <span class="id" type="var">a<sub>2</sub>'</span>) ⇒ <span class="id" type="var">AMult</span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">a<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
This partial evaluator folds constants but does not apply the
    associativity of addition. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Open</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">aexp_scope</span>.<br/>
<span class="id" type="keyword">Open</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">bexp_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">test_pe_aexp1</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span> [(<span class="id" type="var">X</span>,3)] (<span class="id" type="var">X</span> + 1 + <span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;= (4 + <span class="id" type="var">Y</span>).<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">text_pe_aexp2</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span> [(<span class="id" type="var">Y</span>,3)] (<span class="id" type="var">X</span> + 1 + <span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;= (<span class="id" type="var">X</span> + 1 + 3).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
Now, in what sense is <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span> correct?  It is reasonable to
    define the correctness of <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span> as follows: whenever a full
    state <span class="inlinecode"><span class="id" type="var">st</span>:<span class="id" type="var">state</span></span> is _consistent_ with a partial state
    <span class="inlinecode"><span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span></span> (in other words, every variable to which <span class="inlinecode"><span class="id" type="var">pe_st</span></span>
    assigns a value is assigned the same value by <span class="inlinecode"><span class="id" type="var">st</span></span>), evaluating
    <span class="inlinecode"><span class="id" type="var">a</span></span> and evaluating <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span> <span class="inlinecode"><span class="id" type="var">pe_st</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> in <span class="inlinecode"><span class="id" type="var">st</span></span> yields the same
    result.  This statement is indeed true. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">pe_consistent</span> (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) :=<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>, <span class="id" type="var">Some</span> <span class="id" type="var">n</span> = <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> → <span class="id" type="var">st</span> <span class="id" type="var">V</span> = <span class="id" type="var">n</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_aexp_correct_weak</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>, <span class="id" type="var">pe_consistent</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">a</span>, <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">pe_consistent</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">H</span> <span class="id" type="var">a</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Compared&nbsp;to&nbsp;fold_constants_aexp_sound,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;only&nbsp;interesting&nbsp;case&nbsp;is&nbsp;AId&nbsp;*)</span><br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;AId&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">s</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">l</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;Some&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">n</span>:=<span class="id" type="var">n</span>) <span class="id" type="tactic">by</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">Heql</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;None&nbsp;*)</span> <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
However, we will soon want our partial evaluator to remove
    assignments.  For example, it will simplify

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;<span class="id" type="var">Y</span>;;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4
<div class="paragraph"> </div>

</div>
    to just

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3&nbsp;-&nbsp;<span class="id" type="var">Y</span>;;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4
<div class="paragraph"> </div>

</div>
    by delaying the assignment to <span class="inlinecode"><span class="id" type="var">X</span></span> until the end.  To accomplish
    this simplification, we need the result of partial evaluating

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span>&nbsp;[(<span class="id" type="var">X</span>,3)]&nbsp;(<span class="id" type="var">X</span>&nbsp;-&nbsp;<span class="id" type="var">Y</span>)
<div class="paragraph"> </div>

</div>
    to be equal to <span class="inlinecode">3</span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> and _not_ the original
    expression <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" type="var">Y</span></span>.  After all, it would be
    incorrect, not just inefficient, to transform

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;<span class="id" type="var">Y</span>;;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4
<div class="paragraph"> </div>

</div>
    to

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;<span class="id" type="var">Y</span>;;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4
<div class="paragraph"> </div>

</div>
    even though the output expressions <span class="inlinecode">3</span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> and
    <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> both satisfy the correctness criterion
    that we just proved.  Indeed, if we were to just define <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span>
    <span class="inlinecode"><span class="id" type="var">pe_st</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">a</span></span> then the theorem <span class="inlinecode"><span class="id" type="var">pe_aexp_correct'</span></span> would already
    trivially hold.

<div class="paragraph"> </div>

    Instead, we want to prove that the <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span> is correct in a
    stronger sense: evaluating the expression produced by partial
    evaluation (<span class="inlinecode"><span class="id" type="var">aeval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode">(<span class="id" type="var">pe_aexp</span></span> <span class="inlinecode"><span class="id" type="var">pe_st</span></span> <span class="inlinecode"><span class="id" type="var">a</span>)</span>) must not depend on those
    parts of the full state <span class="inlinecode"><span class="id" type="var">st</span></span> that are already specified in the
    partial state <span class="inlinecode"><span class="id" type="var">pe_st</span></span>.  To be more precise, let us define a
    function <span class="inlinecode"><span class="id" type="var">pe_override</span></span>, which updates <span class="inlinecode"><span class="id" type="var">st</span></span> with the contents of
    <span class="inlinecode"><span class="id" type="var">pe_st</span></span>.  In other words, <span class="inlinecode"><span class="id" type="var">pe_override</span></span> carries out the
    assignments listed in <span class="inlinecode"><span class="id" type="var">pe_st</span></span> on top of <span class="inlinecode"><span class="id" type="var">st</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_update</span> (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) : <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_st</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| (<span class="id" type="var">V</span>,<span class="id" type="var">n</span>)::<span class="id" type="var">pe_st</span> ⇒ <span class="id" type="var">t_update</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">V</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">test_pe_update</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> { <span class="id" type="var">Y</span> <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 1 } [(<span class="id" type="var">X</span>,3);(<span class="id" type="var">Z</span>,2)]<br/>
&nbsp;&nbsp;= { <span class="id" type="var">Y</span> <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 1 ; <span class="id" type="var">Z</span> <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 2 ; <span class="id" type="var">X</span> <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 3 }.<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
Although <span class="inlinecode"><span class="id" type="var">pe_update</span></span> operates on a concrete <span class="inlinecode"><span class="id" type="var">list</span></span> representing
    a <span class="inlinecode"><span class="id" type="var">pe_state</span></span>, its behavior is defined entirely by the <span class="inlinecode"><span class="id" type="var">pe_lookup</span></span>
    interpretation of the <span class="inlinecode"><span class="id" type="var">pe_state</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_update_correct</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V<sub>0</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V<sub>0</sub></span> =<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V<sub>0</sub></span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">st</span> <span class="id" type="var">V<sub>0</sub></span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">pe_st</span> <span class="id" type="keyword">as</span> [| [<span class="id" type="var">V</span> <span class="id" type="var">n</span>] <span class="id" type="var">pe_st</span>]. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">unfold</span> <span class="id" type="var">t_update</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">compare</span> <span class="id" type="var">V<sub>0</sub></span> <span class="id" type="var">V</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_string_refl</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
We can relate <span class="inlinecode"><span class="id" type="var">pe_consistent</span></span> to <span class="inlinecode"><span class="id" type="var">pe_update</span></span> in two ways.
    First, overriding a state with a partial state always gives a
    state that is consistent with the partial state.  Second, if a
    state is already consistent with a partial state, then overriding
    the state with the partial state gives the same state. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_update_consistent</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_consistent</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">pe_st</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_update_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>); <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_consistent_update</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_consistent</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> → <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">V</span>, <span class="id" type="var">st</span> <span class="id" type="var">V</span> = <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">H</span> <span class="id" type="var">V</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_update_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">l</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">l</span>; <span class="id" type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Now we can state and prove that <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span> is correct in the
    stronger sense that will help us define the rest of the partial
    evaluator.

<div class="paragraph"> </div>

    Intuitively, running a program using partial evaluation is a
    two-stage process.  In the first, _static_ stage, we partially
    evaluate the given program with respect to some partial state to
    get a _residual_ program.  In the second, _dynamic_ stage, we
    evaluate the residual program with respect to the rest of the
    state.  This dynamic state provides values for those variables
    that are unknown in the static (partial) state.  Thus, the
    residual program should be equivalent to _prepending_ the
    assignments listed in the partial state to the original program. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_aexp_correct</span>: <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">a</span>:<span class="id" type="var">aexp</span>) (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">a</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Compared&nbsp;to&nbsp;fold_constants_aexp_sound,&nbsp;the&nbsp;only<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interesting&nbsp;case&nbsp;is&nbsp;AId.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_update_correct</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">s</span>); <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab572"></a><h2 class="section">Boolean Expressions</h2>

<div class="paragraph"> </div>

 The partial evaluation of boolean expressions is similar.  In
    fact, it is entirely analogous to the constant folding of boolean
    expressions, because our language has no boolean variables. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_bexp</span> (<span class="id" type="var">pe_st</span> : <span class="id" type="var">pe_state</span>) (<span class="id" type="var">b</span> : <span class="id" type="var">bexp</span>) : <span class="id" type="var">bexp</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BTrue</span>        ⇒ <span class="id" type="var">BTrue</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BFalse</span>       ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BEq</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>, <span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">beq_nat</span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">n<sub>2</sub></span> <span class="id" type="keyword">then</span> <span class="id" type="var">BTrue</span> <span class="id" type="keyword">else</span> <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a<sub>1</sub>'</span>, <span class="id" type="var">a<sub>2</sub>'</span>) ⇒ <span class="id" type="var">BEq</span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">a<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BLe</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span>, <span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>2</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">leb</span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">n<sub>2</sub></span> <span class="id" type="keyword">then</span> <span class="id" type="var">BTrue</span> <span class="id" type="keyword">else</span> <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a<sub>1</sub>'</span>, <span class="id" type="var">a<sub>2</sub>'</span>) ⇒ <span class="id" type="var">BLe</span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">a<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BNot</span> <span class="id" type="var">b<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BTrue</span> ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> ⇒ <span class="id" type="var">BTrue</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">b<sub>1</sub>'</span> ⇒ <span class="id" type="var">BNot</span> <span class="id" type="var">b<sub>1</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BAnd</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">b<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span>, <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>2</sub></span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BTrue</span>, <span class="id" type="var">BTrue</span>) ⇒ <span class="id" type="var">BTrue</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BTrue</span>, <span class="id" type="var">BFalse</span>) ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BFalse</span>, <span class="id" type="var">BTrue</span>) ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BFalse</span>, <span class="id" type="var">BFalse</span>) ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">b<sub>1</sub>'</span>, <span class="id" type="var">b<sub>2</sub>'</span>) ⇒ <span class="id" type="var">BAnd</span> <span class="id" type="var">b<sub>1</sub>'</span> <span class="id" type="var">b<sub>2</sub>'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">test_pe_bexp1</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> [(<span class="id" type="var">X</span>,3)] (!(<span class="id" type="var">X</span> ≤ 3))<br/>
&nbsp;&nbsp;= <span class="id" type="var">false</span>.<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">test_pe_bexp2</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">b</span>:<span class="id" type="var">bexp</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">b</span> = !(<span class="id" type="var">X</span> ≤ (<span class="id" type="var">X</span> + 1)) →<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> [] <span class="id" type="var">b</span> = <span class="id" type="var">b</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The correctness of <span class="inlinecode"><span class="id" type="var">pe_bexp</span></span> is analogous to the correctness of
    <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span> above. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_bexp_correct</span>: <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">b</span>:<span class="id" type="var">bexp</span>) (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">beval</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">b</span> = <span class="id" type="var">beval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">b</span>; <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="var">remember</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">a'</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>0</sub></span>) <span class="id" type="keyword">as</span> <span class="id" type="var">a<sub>0</sub>'</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Ha</span>: <span class="id" type="var">aeval</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">a</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a'</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Ha<sub>0</sub></span>: <span class="id" type="var">aeval</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">a<sub>0</sub></span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a<sub>0</sub>'</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_aexp_correct</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">a'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">a<sub>0</sub>'</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ha</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Ha<sub>0</sub></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_nat</span> <span class="id" type="var">n</span> <span class="id" type="var">n<sub>0</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">destruct</span> (<span class="id" type="var">leb</span> <span class="id" type="var">n</span> <span class="id" type="var">n<sub>0</sub></span>); <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHb</span>; <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>2</sub></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHb1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHb2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab573"></a><h1 class="section">Partial Evaluation of Commands, Without Loops</h1>

<div class="paragraph"> </div>

 What about the partial evaluation of commands?  The analogy
    between partial evaluation and full evaluation continues: Just as
    full evaluation of a command turns an initial state into a final
    state, partial evaluation of a command turns an initial partial
    state into a final partial state.  The difference is that, because
    the state is partial, some parts of the command may not be
    executable at the static stage.  Therefore, just as <span class="inlinecode"><span class="id" type="var">pe_aexp</span></span>
    returns a residual <span class="inlinecode"><span class="id" type="var">aexp</span></span> and <span class="inlinecode"><span class="id" type="var">pe_bexp</span></span> returns a residual <span class="inlinecode"><span class="id" type="var">bexp</span></span>
    above, partially evaluating a command yields a residual command.

<div class="paragraph"> </div>

    Another way in which our partial evaluator is similar to a full
    evaluator is that it does not terminate on all commands.  It is
    not hard to build a partial evaluator that terminates on all
    commands; what is hard is building a partial evaluator that
    terminates on all commands yet automatically performs desired
    optimizations such as unrolling loops.  Often a partial evaluator
    can be coaxed into terminating more often and performing more
    optimizations by writing the source program differently so that
    the separation between static and dynamic information becomes more
    apparent.  Such coaxing is the art of _binding-time improvement_.
    The binding time of a variable tells when its value is known &mdash;
    either "static", or "dynamic."

<div class="paragraph"> </div>

    Anyway, for now we will just live with the fact that our partial
    evaluator is not a total function from the source command and the
    initial partial state to the residual command and the final
    partial state.  To model this non-termination, just as with the
    full evaluation of commands, we use an inductively defined
    relation.  We write

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span>&nbsp;/&nbsp;<span class="id" type="var">st</span>&nbsp;\\&nbsp;<span class="id" type="var">c<sub>1</sub>'</span>&nbsp;/&nbsp;<span class="id" type="var">st'</span>
<div class="paragraph"> </div>

</div>
    to mean that partially evaluating the source command <span class="inlinecode"><span class="id" type="var">c<sub>1</sub></span></span> in the
    initial partial state <span class="inlinecode"><span class="id" type="var">st</span></span> yields the residual command <span class="inlinecode"><span class="id" type="var">c<sub>1</sub>'</span></span> and
    the final partial state <span class="inlinecode"><span class="id" type="var">st'</span></span>.  For example, we want something like

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3&nbsp;;;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;*&nbsp;(<span class="id" type="var">X</span>&nbsp;+&nbsp;<span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;[]&nbsp;\\&nbsp;(<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Z</span>&nbsp;*&nbsp;6)&nbsp;/&nbsp;[(<span class="id" type="var">X</span>,3)]
<div class="paragraph"> </div>

</div>
    to hold.  The assignment to <span class="inlinecode"><span class="id" type="var">X</span></span> appears in the final partial state,
    not the residual command. 
<div class="paragraph"> </div>

<a name="lab574"></a><h2 class="section">Assignment</h2>

<div class="paragraph"> </div>

 Let's start by considering how to partially evaluate an
    assignment.  The two assignments in the source program above needs
    to be treated differently.  The first assignment <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span></span> <span class="inlinecode">3</span>,
    is _static_: its right-hand-side is a constant (more generally,
    simplifies to a constant), so we should update our partial state
    at <span class="inlinecode"><span class="id" type="var">X</span></span> to <span class="inlinecode">3</span> and produce no residual code.  (Actually, we produce
    a residual <span class="inlinecode"><span class="id" type="var">SKIP</span></span>.)  The second assignment <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span></span> <span class="inlinecode"><span class="id" type="var">Z</span></span> <span class="inlinecode">*</span> <span class="inlinecode">(<span class="id" type="var">X</span></span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">X</span>)</span> 
    is _dynamic_: its right-hand-side does
    not simplify to a constant, so we should leave it in the residual
    code and remove <span class="inlinecode"><span class="id" type="var">Y</span></span>, if present, from our partial state.  To
    implement these two cases, we define the functions <span class="inlinecode"><span class="id" type="var">pe_add</span></span> and
    <span class="inlinecode"><span class="id" type="var">pe_remove</span></span>.  Like <span class="inlinecode"><span class="id" type="var">pe_update</span></span> above, these functions operate on
    a concrete <span class="inlinecode"><span class="id" type="var">list</span></span> representing a <span class="inlinecode"><span class="id" type="var">pe_state</span></span>, but the theorems
    <span class="inlinecode"><span class="id" type="var">pe_add_correct</span></span> and <span class="inlinecode"><span class="id" type="var">pe_remove_correct</span></span> specify their behavior by
    the <span class="inlinecode"><span class="id" type="var">pe_lookup</span></span> interpretation of the <span class="inlinecode"><span class="id" type="var">pe_state</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_remove</span> (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">V</span>:<span class="id" type="var">string</span>) : <span class="id" type="var">pe_state</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_st</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ []<br/>
&nbsp;&nbsp;| (<span class="id" type="var">V'</span>,<span class="id" type="var">n'</span>)::<span class="id" type="var">pe_st</span> ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> (<span class="id" type="var">V'</span>,<span class="id" type="var">n'</span>) :: <span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_remove_correct</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> (<span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>) <span class="id" type="var">V<sub>0</sub></span><br/>
&nbsp;&nbsp;= <span class="id" type="keyword">if</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span> <span class="id" type="keyword">then</span> <span class="id" type="var">None</span> <span class="id" type="keyword">else</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V<sub>0</sub></span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">pe_st</span> <span class="id" type="keyword">as</span> [| [<span class="id" type="var">V'</span> <span class="id" type="var">n'</span>] <span class="id" type="var">pe_st</span>].<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;<span class="inlinecode"></span>&nbsp;*)</span> <span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>); <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;::&nbsp;*)</span> <span class="id" type="tactic">simpl</span>. <span class="id" type="var">compare</span> <span class="id" type="var">V</span> <span class="id" type="var">V'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHpe_st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_stringP</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>). <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;not&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">simpl</span>. <span class="id" type="var">compare</span> <span class="id" type="var">V<sub>0</sub></span> <span class="id" type="var">V'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;not&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHpe_st</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pe_add</span> (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">V</span>:<span class="id" type="var">string</span>) (<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>) : <span class="id" type="var">pe_state</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">V</span>,<span class="id" type="var">n</span>) :: <span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_add_correct</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span> <span class="id" type="var">V<sub>0</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> (<span class="id" type="var">pe_add</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>) <span class="id" type="var">V<sub>0</sub></span><br/>
&nbsp;&nbsp;= <span class="id" type="keyword">if</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span> <span class="id" type="keyword">then</span> <span class="id" type="var">Some</span> <span class="id" type="var">n</span> <span class="id" type="keyword">else</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V<sub>0</sub></span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span> <span class="id" type="var">V<sub>0</sub></span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">pe_add</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">compare</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_string_refl</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;not&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_remove_correct</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
We will use the two theorems below to show that our partial
    evaluator correctly deals with dynamic assignments and static
    assignments, respectively. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_update_update_remove</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">t_update</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">V</span> <span class="id" type="var">n</span> =<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> (<span class="id" type="var">t_update</span> <span class="id" type="var">st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>) (<span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">V<sub>0</sub></span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">t_update</span>. <span class="id" type="tactic">rewrite</span> !<span class="id" type="var">pe_update_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_remove_correct</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>); <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_update_update_add</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">t_update</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">V</span> <span class="id" type="var">n</span> =<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_add</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="var">n</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">V<sub>0</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">t_update</span>. <span class="id" type="tactic">rewrite</span> !<span class="id" type="var">pe_update_correct</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_add_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>); <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab575"></a><h2 class="section">Conditional</h2>

<div class="paragraph"> </div>

 Trickier than assignments to partially evaluate is the
    conditional, <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b<sub>1</sub></span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c<sub>1</sub></span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c<sub>2</sub></span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span>.  If <span class="inlinecode"><span class="id" type="var">b<sub>1</sub></span></span> simplifies to
    <span class="inlinecode"><span class="id" type="var">BTrue</span></span> or <span class="inlinecode"><span class="id" type="var">BFalse</span></span> then it's easy: we know which branch will be
    taken, so just take that branch.  If <span class="inlinecode"><span class="id" type="var">b<sub>1</sub></span></span> does not simplify to a
    constant, then we need to take both branches, and the final
    partial state may differ between the two branches!

<div class="paragraph"> </div>

    The following program illustrates the difficulty:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;3;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;≤&nbsp;4&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">X</span>&nbsp;≤&nbsp;<span class="id" type="var">Y</span>&nbsp;<span class="id" type="var">THEN</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;999&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">SKIP</span>&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">SKIP</span>&nbsp;<span class="id" type="var">FI</span>
<div class="paragraph"> </div>

</div>
    Suppose the initial partial state is empty.  We don't know
    statically how <span class="inlinecode"><span class="id" type="var">Y</span></span> compares to <span class="inlinecode">4</span>, so we must partially evaluate
    both branches of the (outer) conditional.  On the <span class="inlinecode"><span class="id" type="var">THEN</span></span> branch,
    we know that <span class="inlinecode"><span class="id" type="var">Y</span></span> is set to <span class="inlinecode">4</span> and can even use that knowledge to
    simplify the code somewhat.  On the <span class="inlinecode"><span class="id" type="var">ELSE</span></span> branch, we still don't
    know the exact value of <span class="inlinecode"><span class="id" type="var">Y</span></span> at the end.  What should the final
    partial state and residual program be?

<div class="paragraph"> </div>

    One way to handle such a dynamic conditional is to take the
    intersection of the final partial states of the two branches.  In
    this example, we take the intersection of <span class="inlinecode">(<span class="id" type="var">Y</span>,4),(<span class="id" type="var">X</span>,3)</span> and
    <span class="inlinecode">(<span class="id" type="var">X</span>,3)</span>, so the overall final partial state is <span class="inlinecode">(<span class="id" type="var">X</span>,3)</span>.  To
    compensate for forgetting that <span class="inlinecode"><span class="id" type="var">Y</span></span> is <span class="inlinecode">4</span>, we need to add an
    assignment <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span></span> <span class="inlinecode">4</span> to the end of the <span class="inlinecode"><span class="id" type="var">THEN</span></span> branch.  So,
    the residual program will be something like

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;≤&nbsp;4&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;4<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span>&nbsp;<span class="id" type="var">SKIP</span>&nbsp;<span class="id" type="var">FI</span>
<div class="paragraph"> </div>

</div>
    Programming this case in Coq calls for several auxiliary
    functions: we need to compute the intersection of two <span class="inlinecode"><span class="id" type="var">pe_state</span></span>s
    and turn their difference into sequences of assignments.

<div class="paragraph"> </div>

    First, we show how to compute whether two <span class="inlinecode"><span class="id" type="var">pe_state</span></span>s to disagree
    at a given variable.  In the theorem <span class="inlinecode"><span class="id" type="var">pe_disagree_domain</span></span>, we
    prove that two <span class="inlinecode"><span class="id" type="var">pe_state</span></span>s can only disagree at variables that
    appear in at least one of them. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">pe_disagree_at</span> (<span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> : <span class="id" type="var">pe_state</span>) (<span class="id" type="var">V</span>:<span class="id" type="var">string</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">V</span>, <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">x</span>, <span class="id" type="var">Some</span> <span class="id" type="var">y</span> ⇒ <span class="id" type="var">negb</span> (<span class="id" type="var">beq_nat</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">None</span>, <span class="id" type="var">None</span> ⇒ <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_disagree_domain</span>: <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> : <span class="id" type="var">pe_state</span>) (<span class="id" type="var">V</span>:<span class="id" type="var">string</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">true</span> = <span class="id" type="var">pe_disagree_at</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">V</span> (<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">pe_st<sub>1</sub></span> ++ <span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">pe_st<sub>2</sub></span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">pe_disagree_at</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">in_app_iff</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">lookup1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">lookup1</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">n<sub>1</sub></span>|]. <span class="id" type="var">left</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_domain</span> <span class="id" type="keyword">with</span> <span class="id" type="var">n<sub>1</sub></span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">lookup2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">lookup2</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">n<sub>2</sub></span>|]. <span class="id" type="var">right</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_domain</span> <span class="id" type="keyword">with</span> <span class="id" type="var">n<sub>2</sub></span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
We define the <span class="inlinecode"><span class="id" type="var">pe_compare</span></span> function to list the variables where
    two given <span class="inlinecode"><span class="id" type="var">pe_state</span></span>s disagree.  This list is exact, according to
    the theorem <span class="inlinecode"><span class="id" type="var">pe_compare_correct</span></span>: a variable appears on the list
    if and only if the two given <span class="inlinecode"><span class="id" type="var">pe_state</span></span>s disagree at that
    variable.  Furthermore, we use the <span class="inlinecode"><span class="id" type="var">pe_unique</span></span> function to
    eliminate duplicates from the list. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_unique</span> (<span class="id" type="var">l</span> : <span class="id" type="var">list</span> <span class="id" type="var">string</span>) : <span class="id" type="var">list</span> <span class="id" type="var">string</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ []<br/>
&nbsp;&nbsp;| <span class="id" type="var">x</span>::<span class="id" type="var">l</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">x</span> :: <span class="id" type="var">filter</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">y</span> ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">x</span> <span class="id" type="var">y</span> <span class="id" type="keyword">then</span> <span class="id" type="var">false</span> <span class="id" type="keyword">else</span> <span class="id" type="var">true</span>) (<span class="id" type="var">pe_unique</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_unique_correct</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">l</span> <span class="id" type="var">x</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">In</span> <span class="id" type="var">x</span> <span class="id" type="var">l</span> ↔ <span class="id" type="var">In</span> <span class="id" type="var">x</span> (<span class="id" type="var">pe_unique</span> <span class="id" type="var">l</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">x</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">l</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">h</span> <span class="id" type="var">t</span>]. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_stringP</span> <span class="id" type="var">h</span> <span class="id" type="var">x</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">filter_In</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHt</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">left</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">filter_In</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="var">right</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHt</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pe_compare</span> (<span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> : <span class="id" type="var">pe_state</span>) : <span class="id" type="var">list</span> <span class="id" type="var">string</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_unique</span> (<span class="id" type="var">filter</span> (<span class="id" type="var">pe_disagree_at</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">pe_st<sub>1</sub></span> ++ <span class="id" type="var">map</span> (@<span class="id" type="var">fst</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>) <span class="id" type="var">pe_st<sub>2</sub></span>)).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_compare_correct</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">V</span> = <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span> ↔<br/>
&nbsp;&nbsp;¬ <span class="id" type="var">In</span> <span class="id" type="var">V</span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">pe_compare</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_unique_correct</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">filter_In</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">Heq</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intro</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">pe_disagree_at</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heq</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_nat_refl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hagree</span>: <span class="id" type="var">pe_disagree_at</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span> = <span class="id" type="var">false</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="comment">(*&nbsp;Proof&nbsp;of&nbsp;assertion&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_disagree_at</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">disagree</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">disagree</span>; [| <span class="id" type="tactic">reflexivity</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span>  <span class="id" type="var">pe_disagree_domain</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqdisagree</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">exfalso</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">split</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">pe_disagree_at</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hagree</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">n<sub>1</sub></span>|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">n<sub>2</sub></span>|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">solve_by_invert</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">negb_false_iff</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hagree</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">beq_nat_true</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hagree</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The intersection of two partial states is the result of removing
    from one of them all the variables where the two disagree.  We
    define the function <span class="inlinecode"><span class="id" type="var">pe_removes</span></span>, in terms of <span class="inlinecode"><span class="id" type="var">pe_remove</span></span> above,
    to perform such a removal of a whole list of variables at once.

<div class="paragraph"> </div>

    The theorem <span class="inlinecode"><span class="id" type="var">pe_compare_removes</span></span> testifies that the <span class="inlinecode"><span class="id" type="var">pe_lookup</span></span>
    interpretation of the result of this intersection operation is the
    same no matter which of the two partial states we remove the
    variables from.  Because <span class="inlinecode"><span class="id" type="var">pe_update</span></span> only depends on the
    <span class="inlinecode"><span class="id" type="var">pe_lookup</span></span> interpretation of partial states, <span class="inlinecode"><span class="id" type="var">pe_update</span></span> also
    does not care which of the two partial states we remove the
    variables from; that theorem <span class="inlinecode"><span class="id" type="var">pe_compare_update</span></span> is used in the
    correctness proof shortly. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_removes</span> (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">ids</span> : <span class="id" type="var">list</span> <span class="id" type="var">string</span>) : <span class="id" type="var">pe_state</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">ids</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">V</span>::<span class="id" type="var">ids</span> ⇒ <span class="id" type="var">pe_remove</span> (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span>) <span class="id" type="var">V</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_removes_correct</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">V</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span>) <span class="id" type="var">V</span> =<br/>
&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">inb</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">ids</span> <span class="id" type="keyword">then</span> <span class="id" type="var">None</span> <span class="id" type="keyword">else</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">V</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">ids</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">V'</span> <span class="id" type="var">ids</span>]. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_remove_correct</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHids</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">compare</span> <span class="id" type="var">V'</span> <span class="id" type="var">V</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_string_refl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">congruence</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_compare_removes</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st<sub>1</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)) <span class="id" type="var">V</span> =<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_lookup</span> (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st<sub>2</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)) <span class="id" type="var">V</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>. <span class="id" type="tactic">rewrite</span> !<span class="id" type="var">pe_removes_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">inbP</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">beq_stringP</span> <span class="id" type="var">V</span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)).<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_compare_correct</span>. <span class="id" type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_compare_update</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st<sub>1</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)) =<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st<sub>2</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">V</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> !<span class="id" type="var">pe_update_correct</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_compare_removes</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Finally, we define an <span class="inlinecode"><span class="id" type="var">assign</span></span> function to turn the difference
    between two partial states into a sequence of assignment commands.
    More precisely, <span class="inlinecode"><span class="id" type="var">assign</span></span> <span class="inlinecode"><span class="id" type="var">pe_st</span></span> <span class="inlinecode"><span class="id" type="var">ids</span></span> generates an assignment command
    for each variable listed in <span class="inlinecode"><span class="id" type="var">ids</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">assign</span> (<span class="id" type="var">pe_st</span> : <span class="id" type="var">pe_state</span>) (<span class="id" type="var">ids</span> : <span class="id" type="var">list</span> <span class="id" type="var">string</span>) : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">ids</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| [] ⇒ <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">V</span>::<span class="id" type="var">ids</span> ⇒ <span class="id" type="keyword">match</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">n</span> ⇒ (<span class="id" type="var">assign</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span>;; <span class="id" type="var">V</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">ANum</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">assign</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
The command generated by <span class="inlinecode"><span class="id" type="var">assign</span></span> always terminates, because it is
    just a sequence of assignments.  The (total) function <span class="inlinecode"><span class="id" type="var">assigned</span></span>
    below computes the effect of the command on the (dynamic state).
    The theorem <span class="inlinecode"><span class="id" type="var">assign_removes</span></span> then confirms that the generated
    assignments perfectly compensate for removing the variables from
    the partial state. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">assigned</span> (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">ids</span> : <span class="id" type="var">list</span> <span class="id" type="var">string</span>) (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) : <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">V</span> ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">inb</span> <span class="id" type="var">beq_string</span> <span class="id" type="var">V</span> <span class="id" type="var">ids</span> <span class="id" type="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">Some</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">None</span> ⇒ <span class="id" type="var">st</span> <span class="id" type="var">V</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">st</span> <span class="id" type="var">V</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">assign_removes</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> =<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_update</span> (<span class="id" type="var">assigned</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">st</span>) (<span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">V</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> !<span class="id" type="var">pe_update_correct</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_removes_correct</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">assigned</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">inbP</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">beq_stringP</span> <span class="id" type="var">V</span> <span class="id" type="var">ids</span>); <span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>); <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">ceval_extensionality</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st<sub>1</sub></span> <span class="id" type="var">st<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st<sub>1</sub></span> → (<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">V</span>, <span class="id" type="var">st<sub>1</sub></span> <span class="id" type="var">V</span> = <span class="id" type="var">st<sub>2</sub></span> <span class="id" type="var">V</span>) → <span class="id" type="var">c</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st<sub>2</sub></span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st<sub>1</sub></span> <span class="id" type="var">st<sub>2</sub></span> <span class="id" type="var">H</span> <span class="id" type="var">Heq</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heq</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Heq</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">eval_assign</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">assign</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">assigned</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">ids</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">ids</span> <span class="id" type="keyword">as</span> [| <span class="id" type="var">V</span> <span class="id" type="var">ids</span>]; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;<span class="inlinecode"></span>&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_extensionality</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Skip</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;V::ids&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">V</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">lookup</span>. <span class="id" type="tactic">destruct</span> <span class="id" type="var">lookup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;Some&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHids</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">assigned</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_extensionality</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">V<sub>0</sub></span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">t_update</span>. <span class="id" type="var">compare</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Heqlookup</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_string_refl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;not&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;None&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_extensionality</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHids</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">assigned</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">V<sub>0</sub></span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="var">compare</span> <span class="id" type="var">V</span> <span class="id" type="var">V<sub>0</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">Heqlookup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">beq_string_refl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">inbP</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">beq_stringP</span> <span class="id" type="var">V</span> <span class="id" type="var">ids</span>); <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;not&nbsp;equal&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">false_beq_string</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">congruence</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab576"></a><h2 class="section">The Partial Evaluation Relation</h2>

<div class="paragraph"> </div>

 At long last, we can define a partial evaluator for commands
    without loops, as an inductive relation!  The inequality
    conditions in <span class="inlinecode"><span class="id" type="var">PE_AssDynamic</span></span> and <span class="inlinecode"><span class="id" type="var">PE_If</span></span> are just to keep the
    partial evaluator deterministic; they are not required for
    correctness. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Reserved Notation</span> "c<sub>1</sub> '/' st '\\' c<sub>1</sub>' '/' st'"<br/>
&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">pe_com</span> : <span class="id" type="var">com</span> → <span class="id" type="var">pe_state</span> → <span class="id" type="var">com</span> → <span class="id" type="var">pe_state</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_Skip</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_AssStatic</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> = <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub></span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_add</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span> <span class="id" type="var">n<sub>1</sub></span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_AssDynamic</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> = <span class="id" type="var">a<sub>1</sub>'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">n</span>, <span class="id" type="var">a<sub>1</sub>'</span> ≠ <span class="id" type="var">ANum</span> <span class="id" type="var">n</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub></span>) / <span class="id" type="var">pe_st</span> \\ (<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub>'</span>) / <span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_Seq</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">pe_st''</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span>  \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">pe_st'</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c<sub>1</sub></span> ;; <span class="id" type="var">c<sub>2</sub></span>) / <span class="id" type="var">pe_st</span> \\ (<span class="id" type="var">c<sub>1</sub>'</span> ;; <span class="id" type="var">c<sub>2</sub>'</span>) / <span class="id" type="var">pe_st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_IfTrue</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_IfFalse</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_If</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st<sub>1</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st<sub>2</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ (<span class="id" type="var">IFB</span> <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub>'</span> ;; <span class="id" type="var">assign</span> <span class="id" type="var">pe_st<sub>1</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub>'</span> ;; <span class="id" type="var">assign</span> <span class="id" type="var">pe_st<sub>2</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>) <span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st<sub>1</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)<br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c<sub>1</sub> '/' st '\\' c<sub>1</sub>' '/' st'" := (<span class="id" type="var">pe_com</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">st</span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">st'</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">pe_com</span>.<br/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">ceval</span>.<br/>
</div>

<div class="doc">
<a name="lab577"></a><h2 class="section">Examples</h2>

<div class="paragraph"> </div>

 Below are some examples of using the partial evaluator.  To make
    the <span class="inlinecode"><span class="id" type="var">pe_com</span></span> relation actually usable for automatic partial
    evaluation, we would need to define more automation tactics in
    Coq.  That is not hard to do, but it is not needed here. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_example1</span>:<br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 3 ;; <span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Z</span> * (<span class="id" type="var">X</span> + <span class="id" type="var">X</span>))<br/>
&nbsp;&nbsp;/ [] \\ (<span class="id" type="var">SKIP</span>;; <span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Z</span> * 6) / [(<span class="id" type="var">X</span>,3)].<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssDynamic</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">n</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_example2</span>:<br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 3 ;; <span class="id" type="var">IFB</span> <span class="id" type="var">X</span> ≤ 4 <span class="id" type="var">THEN</span> <span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 4 <span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;/ [] \\ (<span class="id" type="var">SKIP</span>;; <span class="id" type="var">SKIP</span>) / [(<span class="id" type="var">X</span>,4)].<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_IfTrue</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_example3</span>:<br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 3;;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">Y</span> ≤ 4 <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 4;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">X</span> = <span class="id" type="var">Y</span> <span class="id" type="var">THEN</span> <span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 999 <span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">FI</span>) / []<br/>
&nbsp;&nbsp;\\ (<span class="id" type="var">SKIP</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">Y</span> ≤ 4 <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">SKIP</span>);; (<span class="id" type="var">SKIP</span>;; <span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 4)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span>;; <span class="id" type="var">SKIP</span> <span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ [(<span class="id" type="var">X</span>,3)].<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">erewrite</span> <span class="id" type="var">f_equal2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒ <span class="id" type="var">_</span> / <span class="id" type="var">_</span> \\ <span class="id" type="var">c</span> / <span class="id" type="var">st</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_If</span>; <span class="id" type="tactic">intuition</span> <span class="id" type="tactic">eauto</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">solve_by_invert</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_IfFalse</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="var">econstructor</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab578"></a><h2 class="section">Correctness of Partial Evaluation</h2>

<div class="paragraph"> </div>

 Finally let's prove that this partial evaluator is correct! 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Reserved Notation</span> "c' '/' pe_st' '/' st '\\' st''"<br/>
&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">pe_st'</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">pe_ceval</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">c'</span>:<span class="id" type="var">com</span>) (<span class="id" type="var">pe_st'</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">st''</span>:<span class="id" type="var">state</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">pe_ceval_intro</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span> = <span class="id" type="var">st''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c' '/' pe_st' '/' st '\\' st''" := (<span class="id" type="var">pe_ceval</span> <span class="id" type="var">c'</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">pe_ceval</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_com_complete</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span>, <span class="id" type="var">c</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">st''</span>) →<br/>
&nbsp;&nbsp;(<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">Hpe</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hpe</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">Heval</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>, → <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> *; <span class="id" type="var">solve_by_invert</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]);<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssStatic&nbsp;*)</span> <span class="id" type="var">econstructor</span>. <span class="id" type="var">econstructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_add</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssDynamic&nbsp;*)</span> <span class="id" type="var">econstructor</span>. <span class="id" type="var">econstructor</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_remove</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_Seq&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_If&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E'IfTrue&nbsp;*)</span> <span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfFalse&nbsp;*)</span> <span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_compare_update</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="var">eassumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_com_sound</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span>, <span class="id" type="var">c</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span>) →<br/>
&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">st''</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">Hpe</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hpe</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> [<span class="id" type="var">st'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">Heq</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; []; <span class="id" type="tactic">subst</span>); <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssStatic&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_add</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssDynamic&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_remove</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_Seq&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_IfTrue&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_IfFalse&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_If&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>7</sub></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_deterministic</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>8</sub></span>; [| <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>]); <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfFalse&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_compare_update</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The main theorem. Thanks to David Menendez for this formulation! 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Corollary</span> <span class="id" type="var">pe_com_correct</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span>, <span class="id" type="var">c</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">st''</span>) ↔<br/>
&nbsp;&nbsp;(<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">H</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_com_complete</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_com_sound</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab579"></a><h1 class="section">Partial Evaluation of Loops</h1>

<div class="paragraph"> </div>

 It may seem straightforward at first glance to extend the partial
    evaluation relation <span class="inlinecode"><span class="id" type="var">pe_com</span></span> above to loops.  Indeed, many loops
    are easy to deal with.  Considered this repeated-squaring loop,
    for example:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;1&nbsp;≤&nbsp;<span class="id" type="var">X</span>&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">X</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>
    If we know neither <span class="inlinecode"><span class="id" type="var">X</span></span> nor <span class="inlinecode"><span class="id" type="var">Y</span></span> statically, then the entire loop is
    dynamic and the residual command should be the same.  If we know
    <span class="inlinecode"><span class="id" type="var">X</span></span> but not <span class="inlinecode"><span class="id" type="var">Y</span></span>, then the loop can be unrolled all the way and the
    residual command should be, for example,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Y</span>
<div class="paragraph"> </div>

</div>
    if <span class="inlinecode"><span class="id" type="var">X</span></span> is initially <span class="inlinecode">3</span> (and finally <span class="inlinecode">0</span>).  In general, a loop is
    easy to partially evaluate if the final partial state of the loop
    body is equal to the initial state, or if its guard condition is
    static.

<div class="paragraph"> </div>

    But there are other loops for which it is hard to express the
    residual program we want in Imp.  For example, take this program
    for checking whether <span class="inlinecode"><span class="id" type="var">Y</span></span> is even or odd:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;0;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;1&nbsp;≤&nbsp;<span class="id" type="var">Y</span>&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;-&nbsp;1&nbsp;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;1&nbsp;-&nbsp;<span class="id" type="var">X</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>
    The value of <span class="inlinecode"><span class="id" type="var">X</span></span> alternates between <span class="inlinecode">0</span> and <span class="inlinecode">1</span> during the loop.
    Ideally, we would like to unroll this loop, not all the way but
    _two-fold_, into something like

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;1&nbsp;≤&nbsp;<span class="id" type="var">Y</span>&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;-&nbsp;1;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IF</span>&nbsp;1&nbsp;≤&nbsp;<span class="id" type="var">Y</span>&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;<span class="id" type="var">Y</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;1;;&nbsp;<span class="id" type="var">EXIT</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>&nbsp;0
<div class="paragraph"> </div>

</div>
    Unfortunately, there is no <span class="inlinecode"><span class="id" type="var">EXIT</span></span> command in Imp.  Without
    extending the range of control structures available in our
    language, the best we can do is to repeat loop-guard tests or add
    flag variables.  Neither option is terribly attractive.

<div class="paragraph"> </div>

    Still, as a digression, below is an attempt at performing partial
    evaluation on Imp commands.  We add one more command argument
    <span class="inlinecode"><span class="id" type="var">c''</span></span> to the <span class="inlinecode"><span class="id" type="var">pe_com</span></span> relation, which keeps track of a loop to
    roll up. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Module</span> <span class="id" type="var">Loop</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Reserved Notation</span> "c<sub>1</sub> '/' st '\\' c<sub>1</sub>' '/' st' '/' c''"<br/>
&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">st'</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">pe_com</span> : <span class="id" type="var">com</span> → <span class="id" type="var">pe_state</span> → <span class="id" type="var">com</span> → <span class="id" type="var">pe_state</span> → <span class="id" type="var">com</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_Skip</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_st</span> / <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_AssStatic</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> = <span class="id" type="var">ANum</span> <span class="id" type="var">n<sub>1</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub></span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_add</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span> <span class="id" type="var">n<sub>1</sub></span> / <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_AssDynamic</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">a<sub>1</sub>'</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a<sub>1</sub></span> = <span class="id" type="var">a<sub>1</sub>'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">n</span>, <span class="id" type="var">a<sub>1</sub>'</span> ≠ <span class="id" type="var">ANum</span> <span class="id" type="var">n</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub></span>) / <span class="id" type="var">pe_st</span> \\ (<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub>'</span>) / <span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span> / <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_Seq</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">pe_st''</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">c''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span>  \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">SKIP</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">pe_st'</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st''</span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c<sub>1</sub></span> ;; <span class="id" type="var">c<sub>2</sub></span>) / <span class="id" type="var">pe_st</span> \\ (<span class="id" type="var">c<sub>1</sub>'</span> ;; <span class="id" type="var">c<sub>2</sub>'</span>) / <span class="id" type="var">pe_st''</span> / <span class="id" type="var">c''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_IfTrue</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_IfFalse</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">c''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_If</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">c''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st<sub>1</sub></span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st<sub>2</sub></span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ (<span class="id" type="var">IFB</span> <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub>'</span> ;; <span class="id" type="var">assign</span> <span class="id" type="var">pe_st<sub>1</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub>'</span> ;; <span class="id" type="var">assign</span> <span class="id" type="var">pe_st<sub>2</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>) <span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st<sub>1</sub></span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" type="var">c''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_WhileFalse</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_st</span> / <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_WhileTrue</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">pe_st''</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">c<sub>2</sub>''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">SKIP</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st'</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st''</span> / <span class="id" type="var">c<sub>2</sub>''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span> ≠ [] →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span> \\ (<span class="id" type="var">c<sub>1</sub>'</span>;;<span class="id" type="var">c<sub>2</sub>'</span>) / <span class="id" type="var">pe_st''</span> / <span class="id" type="var">c<sub>2</sub>''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_While</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">pe_st''</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">c<sub>2</sub>''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">SKIP</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st'</span> \\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st''</span> / <span class="id" type="var">c<sub>2</sub>''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span> ≠ [] →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c<sub>2</sub>''</span> = <span class="id" type="var">SKIP</span> ∨ <span class="id" type="var">c<sub>2</sub>''</span> = <span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ (<span class="id" type="var">IFB</span> <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub>'</span>;; <span class="id" type="var">c<sub>2</sub>'</span>;; <span class="id" type="var">assign</span> <span class="id" type="var">pe_st''</span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">assign</span> <span class="id" type="var">pe_st</span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span>) <span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" type="var">pe_removes</span> <span class="id" type="var">pe_st</span> (<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" type="var">c<sub>2</sub>''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_WhileFixedEnd</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">SKIP</span> / <span class="id" type="var">pe_st</span> / (<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_WhileFixedLoop</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">pe_st''</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">SKIP</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st''</span> / (<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span> = [] →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ (<span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span> / <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Because&nbsp;we&nbsp;have&nbsp;an&nbsp;infinite&nbsp;loop,&nbsp;we&nbsp;should&nbsp;actually<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;to&nbsp;throw&nbsp;away&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;program:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(WHILE&nbsp;b<sub>1</sub>&nbsp;DO&nbsp;c<sub>1</sub>&nbsp;END)&nbsp;/&nbsp;pe_st<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\&nbsp;SKIP&nbsp;/&nbsp;pe_st&nbsp;/&nbsp;(WHILE&nbsp;BTrue&nbsp;DO&nbsp;SKIP&nbsp;END)&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">PE_WhileFixed</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">pe_st''</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">c<sub>2</sub>'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BFalse</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> ≠ <span class="id" type="var">BTrue</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c<sub>1</sub>'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">SKIP</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ <span class="id" type="var">c<sub>2</sub>'</span> / <span class="id" type="var">pe_st''</span> / (<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st''</span> = [] →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\ (<span class="id" type="var">WHILE</span> <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub>'</span>;; <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">END</span>) / <span class="id" type="var">pe_st</span> / <span class="id" type="var">SKIP</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c<sub>1</sub> '/' st '\\' c<sub>1</sub>' '/' st' '/' c''" := (<span class="id" type="var">pe_com</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">st</span> <span class="id" type="var">c<sub>1</sub>'</span> <span class="id" type="var">st'</span> <span class="id" type="var">c''</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">pe_com</span>.<br/>
</div>

<div class="doc">
<a name="lab580"></a><h2 class="section">Examples</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Ltac</span> <span class="id" type="var">step</span> <span class="id" type="var">i</span> :=<br/>
&nbsp;&nbsp;(<span class="id" type="tactic">eapply</span> <span class="id" type="var">i</span>; <span class="id" type="tactic">intuition</span> <span class="id" type="tactic">eauto</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">solve_by_invert</span>);<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> (<span class="id" type="tactic">try</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>; <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssDynamic</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">reflexivity</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="tactic">intuition</span> <span class="id" type="tactic">eauto</span>; <span class="id" type="var">solve_by_invert</span>])).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">square_loop</span>: <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> 1 ≤ <span class="id" type="var">X</span> <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Y</span> * <span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">X</span> - 1<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_loop_example1</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">square_loop</span> / []<br/>
&nbsp;&nbsp;\\ (<span class="id" type="var">WHILE</span> 1 ≤ <span class="id" type="var">X</span> <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Y</span> * <span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">X</span> - 1);; <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>) / [] / <span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">erewrite</span> <span class="id" type="var">f_equal2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒ <span class="id" type="var">_</span> / <span class="id" type="var">_</span> \\ <span class="id" type="var">c</span> / <span class="id" type="var">st</span> / <span class="id" type="var">SKIP</span>).<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFixed</span>. <span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFixedEnd</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_loop_example2</span>:<br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 3;; <span class="id" type="var">square_loop</span>) / []<br/>
&nbsp;&nbsp;\\ (<span class="id" type="var">SKIP</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Y</span> * <span class="id" type="var">Y</span>;; <span class="id" type="var">SKIP</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Y</span> * <span class="id" type="var">Y</span>;; <span class="id" type="var">SKIP</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Y</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">Y</span> * <span class="id" type="var">Y</span>;; <span class="id" type="var">SKIP</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>) / [(<span class="id" type="var">X</span>,0)] / <span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">erewrite</span> <span class="id" type="var">f_equal2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒ <span class="id" type="var">_</span> / <span class="id" type="var">_</span> \\ <span class="id" type="var">c</span> / <span class="id" type="var">st</span> / <span class="id" type="var">SKIP</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileTrue</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileTrue</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileTrue</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFalse</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_loop_example3</span>:<br/>
&nbsp;&nbsp;(<span class="id" type="var">Z</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 3;; <span class="id" type="var">subtract_slowly</span>) / []<br/>
&nbsp;&nbsp;\\ (<span class="id" type="var">SKIP</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> !(<span class="id" type="var">X</span> = 0) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">X</span> - 1);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> !(<span class="id" type="var">X</span> = 0) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">X</span> - 1);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> !(<span class="id" type="var">X</span> = 0) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">X</span> - 1);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span> !(<span class="id" type="var">X</span> = 0) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">X</span> - 1);; <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>;; <span class="id" type="var">Z</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span>;; <span class="id" type="var">Z</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 1 <span class="id" type="var">FI</span>;; <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span>;; <span class="id" type="var">Z</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 2 <span class="id" type="var">FI</span>;; <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span>;; <span class="id" type="var">Z</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 3 <span class="id" type="var">FI</span>) / [] / <span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">erewrite</span> <span class="id" type="var">f_equal2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒ <span class="id" type="var">_</span> / <span class="id" type="var">_</span> \\ <span class="id" type="var">c</span> / <span class="id" type="var">st</span> / <span class="id" type="var">SKIP</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_While</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_While</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_While</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFixed</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFixedEnd</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_loop_example4</span>:<br/>
&nbsp;&nbsp;(<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 0;;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">X</span> ≤ 2 <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> 1 - <span class="id" type="var">X</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>) / [] \\ (<span class="id" type="var">SKIP</span>;; <span class="id" type="var">WHILE</span> <span class="id" type="var">true</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span>) / [(<span class="id" type="var">X</span>,0)] / <span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">erewrite</span> <span class="id" type="var">f_equal2</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒ <span class="id" type="var">_</span> / <span class="id" type="var">_</span> \\ <span class="id" type="var">c</span> / <span class="id" type="var">st</span> / <span class="id" type="var">SKIP</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_Seq</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">PE_AssStatic</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFixedLoop</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileTrue</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">step</span> <span class="id" type="var">PE_WhileFixedEnd</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab581"></a><h2 class="section">Correctness</h2>

<div class="paragraph"> </div>

 Because this partial evaluator can unroll a loop n-fold where n is
    a (finite) integer greater than one, in order to show it correct
    we need to perform induction not structurally on dynamic
    evaluation but on the number of times dynamic evaluation enters a
    loop body. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Reserved Notation</span> "c<sub>1</sub> '/' st '\\' st' '#' n"<br/>
&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">st'</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval_count</span> : <span class="id" type="var">com</span> → <span class="id" type="var">state</span> → <span class="id" type="var">state</span> → <span class="id" type="var">nat</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E'Skip</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st</span> # 0<br/>
&nbsp;&nbsp;| <span class="id" type="var">E'Ass</span>  : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">a<sub>1</sub></span> <span class="id" type="var">n</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a<sub>1</sub></span> = <span class="id" type="var">n</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">a<sub>1</sub></span>) / <span class="id" type="var">st</span> \\ (<span class="id" type="var">t_update</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span> <span class="id" type="var">n</span>) # 0<br/>
&nbsp;&nbsp;| <span class="id" type="var">E'Seq</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">n<sub>2</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">st</span>  \\ <span class="id" type="var">st'</span>  # <span class="id" type="var">n<sub>1</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">st'</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n<sub>2</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c<sub>1</sub></span> ;; <span class="id" type="var">c<sub>2</sub></span>) / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # (<span class="id" type="var">n<sub>1</sub></span> + <span class="id" type="var">n<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">E'IfTrue</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">true</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E'IfFalse</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">false</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>2</sub></span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E'WhileFalse</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">st</span> <span class="id" type="var">c<sub>1</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">false</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> \\ <span class="id" type="var">st</span> # 0<br/>
&nbsp;&nbsp;| <span class="id" type="var">E'WhileTrue</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">n<sub>1</sub></span> <span class="id" type="var">n<sub>2</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b<sub>1</sub></span> = <span class="id" type="var">true</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c<sub>1</sub></span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n<sub>1</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">st'</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n<sub>2</sub></span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">S</span> (<span class="id" type="var">n<sub>1</sub></span> + <span class="id" type="var">n<sub>2</sub></span>)<br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c<sub>1</sub> '/' st '\\' st' # n" := (<span class="id" type="var">ceval_count</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">n</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">ceval_count</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ceval_count_complete</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> → <span style='font-size:120%;'>&exist;</span> <span class="id" type="var">n</span>, <span class="id" type="var">c</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Heval</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Heval</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">IHHeval1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">IHHeval2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">IHHeval</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ceval_count_sound</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> # <span class="id" type="var">n</span> → <span class="id" type="var">c</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">n</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_compare_nil_lookup</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> = [] →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">V</span>, <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">V</span> = <span class="id" type="var">pe_lookup</span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">H</span> <span class="id" type="var">V</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">pe_compare_correct</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">V</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">intro</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>0</sub></span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_compare_nil_update</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_compare</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> = [] →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span>, <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st<sub>1</sub></span> = <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st<sub>2</sub></span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">pe_st<sub>1</sub></span> <span class="id" type="var">pe_st<sub>2</sub></span> <span class="id" type="var">H</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">V</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> !<span class="id" type="var">pe_update_correct</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">pe_compare_nil_lookup</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">V</span>:=<span class="id" type="var">V</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Reserved Notation</span> "c' '/' pe_st' '/' c'' '/' st '\\' st'' '#' n"<br/>
&nbsp;&nbsp;(<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">pe_st'</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">c''</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39,<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39, <span class="id" type="var">st''</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/><hr class='doublespaceincode'/>
<span class="id" type="var">Close</span> <span class="id" type="keyword">Scope</span> <span class="id" type="var">bexp_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">pe_ceval_count</span> (<span class="id" type="var">c'</span>:<span class="id" type="var">com</span>) (<span class="id" type="var">pe_st'</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">c''</span>:<span class="id" type="var">com</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">st''</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">pe_ceval_count_intro</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st'</span> <span class="id" type="var">n'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c''</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">n'</span> ≤ <span class="id" type="var">n</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c' '/' pe_st' '/' c'' '/' st '\\' st'' '#' n" :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">pe_ceval_count</span> <span class="id" type="var">c'</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c''</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Hint</span> <span class="id" type="var">Constructors</span> <span class="id" type="var">pe_ceval_count</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">pe_ceval_count_le</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c'</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c''</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span> <span class="id" type="var">n'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">n'</span> ≤ <span class="id" type="var">n</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n'</span> →<br/>
&nbsp;&nbsp;<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c'</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c''</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span> <span class="id" type="var">n'</span> <span class="id" type="var">Hle</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">try</span> <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">omega</span>. <span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_com_complete</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">c''</span>, <span class="id" type="var">c</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n</span>) →<br/>
&nbsp;&nbsp;(<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">c''</span> <span class="id" type="var">Hpe</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hpe</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span> <span class="id" type="var">Heval</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>, → <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> *; <span class="id" type="var">solve_by_invert</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]);<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssStatic&nbsp;*)</span> <span class="id" type="var">econstructor</span>. <span class="id" type="var">econstructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_add</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E'Skip</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssDynamic&nbsp;*)</span> <span class="id" type="var">econstructor</span>. <span class="id" type="var">econstructor</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_remove</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E'Skip</span>. <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_Seq&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ? ? <span class="id" type="var">Hskip</span> ?]. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_If&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E'IfTrue&nbsp;*)</span> <span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfFalse&nbsp;*)</span> <span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>. <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_compare_update</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="var">eassumption</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ? ? <span class="id" type="var">Hskip</span> ?]. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_While&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileFalse&nbsp;*)</span> <span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ? ? <span class="id" type="var">Hskip</span> ?]. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_compare_update</span>, &lt;- <span class="id" type="var">assign_removes</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">omega</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileFixedLoop&nbsp;*)</span> <span class="id" type="var">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> (<span class="id" type="var">S</span> (<span class="id" type="var">n<sub>1</sub></span> + <span class="id" type="var">n<sub>2</sub></span>)). <span class="id" type="tactic">intros</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> - <span class="id" type="var">H</span> <span class="id" type="var">H<sub>0</sub></span> <span class="id" type="var">IHHpe1</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">using</span> <span class="id" type="var">lt_wf_ind</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E'WhileFalse&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_bexp_correct</span>, <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>7</sub></span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>7</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E'WhileTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ? ? <span class="id" type="var">Hskip</span> ?]. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">pe_compare_nil_update</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H<sub>0</sub></span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>7</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>7</sub></span>; [| <span class="id" type="tactic">omega</span>]. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>7</sub></span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileFixed&nbsp;*)</span> <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">n</span> <span class="id" type="keyword">using</span> <span class="id" type="var">lt_wf_ind</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E'WhileFalse&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_bexp_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>8</sub></span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E'WhileTrue&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_bexp_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>5</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ? ? <span class="id" type="var">Hskip</span> ?]. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">pe_compare_nil_update</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H<sub>1</sub></span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>8</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H<sub>2</sub></span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>8</sub></span>; [| <span class="id" type="tactic">omega</span>]. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>8</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>; [ <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_WhileTrue</span>; <span class="id" type="tactic">eauto</span> | <span class="id" type="var">eassumption</span> | <span class="id" type="tactic">omega</span>].<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_com_sound</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">c''</span>, <span class="id" type="var">c</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">c''</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st''</span> # <span class="id" type="var">n</span>) →<br/>
&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">st''</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">c''</span> <span class="id" type="var">Hpe</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hpe</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span> <span class="id" type="var">n</span> [<span class="id" type="var">st'</span> <span class="id" type="var">n'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">Heval'</span> <span class="id" type="var">Hle</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; []; <span class="id" type="tactic">subst</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval'</span>; []; <span class="id" type="tactic">subst</span>); <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssStatic&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_add</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_AssDynamic&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_update_update_remove</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">pe_aexp_correct</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_Seq&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Seq</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_IfTrue&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_IfFalse&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_If&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>7</sub></span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>7</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_deterministic</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>8</sub></span>; [| <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>]. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe1</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfFalse&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_deterministic</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>8</sub></span>; [| <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>]. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_compare_update</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileFalse&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileTrue&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_WhileTrue</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe1</span>. <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_While&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>9</sub></span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>9</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>10</sub></span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">H<sub>10</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_deterministic</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>11</sub></span>; [| <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>]. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_compare_update</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_WhileTrue</span>. <span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe1</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_IfFalse&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">ceval_count_sound</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_deterministic</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H<sub>9</sub></span>; [| <span class="id" type="tactic">apply</span> <span class="id" type="var">eval_assign</span>]. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- <span class="id" type="var">assign_removes</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;c<sub>2</sub>''&nbsp;=&nbsp;SKIP&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval'</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> → <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;c<sub>2</sub>''&nbsp;=&nbsp;WHILE&nbsp;b<sub>1</sub>&nbsp;DO&nbsp;c<sub>1</sub>&nbsp;END&nbsp;*)</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileFixedEnd&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">ceval_count_sound</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Heval'</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileFixedLoop&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">loop_never_stops</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;PE_WhileFixed&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> - <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="var">IHHpe1</span> <span class="id" type="var">IHHpe2</span> <span class="id" type="var">Heval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b<sub>1</sub></span> <span class="id" type="var">DO</span> <span class="id" type="var">c<sub>1</sub>'</span>;; <span class="id" type="var">c<sub>2</sub>'</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">c'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Heval</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqc'</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heqc'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileFalse&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileFalse</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">IHHeval2'</span> := <span class="id" type="var">IHHeval2</span> (<span class="id" type="var">refl_equal</span> <span class="id" type="var">_</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ceval_count_complete</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHHeval2'</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">IHHeval2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">IHHeval1</span> <span class="id" type="var">IHHeval2</span> <span class="id" type="var">IHHeval2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval1</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_WhileTrue</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_bexp_correct</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">IHHpe2</span>. <span class="id" type="var">econstructor</span>. <span class="id" type="var">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> &lt;- (<span class="id" type="var">pe_compare_nil_update</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">H<sub>1</sub></span>). <span class="id" type="var">eassumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Corollary</span> <span class="id" type="var">pe_com_correct</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span>, <span class="id" type="var">c</span> / <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">c'</span> / <span class="id" type="var">pe_st'</span> / <span class="id" type="var">SKIP</span> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> \\ <span class="id" type="var">st''</span>) ↔<br/>
&nbsp;&nbsp;(<span style='font-size:120%;'>&exist;</span> <span class="id" type="var">st'</span>, <span class="id" type="var">c'</span> / <span class="id" type="var">st</span> \\ <span class="id" type="var">st'</span> ∧ <span class="id" type="var">pe_update</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span> = <span class="id" type="var">st''</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">c'</span> <span class="id" type="var">H</span> <span class="id" type="var">st</span> <span class="id" type="var">st''</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span> <span class="id" type="tactic">intros</span> <span class="id" type="var">Heval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ceval_count_complete</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heval</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">n</span> <span class="id" type="var">Heval'</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">pe_com_complete</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st</span>:=<span class="id" type="var">st</span>) (<span class="id" type="var">st''</span>:=<span class="id" type="var">st''</span>) (<span class="id" type="var">n</span>:=<span class="id" type="var">n</span>) <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span> <span class="id" type="keyword">as</span> [? ? ? <span class="id" type="var">Hskip</span> ?]. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hskip</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span> <span class="id" type="tactic">intros</span> [<span class="id" type="var">st'</span> [<span class="id" type="var">Heval</span> <span class="id" type="var">Heq</span>]]. <span class="id" type="tactic">subst</span> <span class="id" type="var">st''</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">pe_com_sound</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">econstructor</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Heval</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E'Skip</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">le_n</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Loop</span>.<br/>
</div>

<div class="doc">
<a name="lab582"></a><h1 class="section">Partial Evaluation of Flowchart Programs</h1>

<div class="paragraph"> </div>

 Instead of partially evaluating <span class="inlinecode"><span class="id" type="var">WHILE</span></span> loops directly, the
    standard approach to partially evaluating imperative programs is
    to convert them into _flowcharts_.  In other words, it turns out
    that adding labels and jumps to our language makes it much easier
    to partially evaluate.  The result of partially evaluating a
    flowchart is a residual flowchart.  If we are lucky, the jumps in
    the residual flowchart can be converted back to <span class="inlinecode"><span class="id" type="var">WHILE</span></span> loops, but
    that is not possible in general; we do not pursue it here. 
<div class="paragraph"> </div>

<a name="lab583"></a><h2 class="section">Basic blocks</h2>

<div class="paragraph"> </div>

 A flowchart is made of _basic blocks_, which we represent with the
    inductive type <span class="inlinecode"><span class="id" type="var">block</span></span>.  A basic block is a sequence of
    assignments (the constructor <span class="inlinecode"><span class="id" type="var">Assign</span></span>), concluding with a
    conditional jump (the constructor <span class="inlinecode"><span class="id" type="var">If</span></span>) or an unconditional jump
    (the constructor <span class="inlinecode"><span class="id" type="var">Goto</span></span>).  The destinations of the jumps are
    specified by _labels_, which can be of any type.  Therefore, we
    parameterize the <span class="inlinecode"><span class="id" type="var">block</span></span> type by the type of labels. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <span class="id" type="var">block</span> (<span class="id" type="var">Label</span>:<span class="id" type="keyword">Type</span>) : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">Goto</span> : <span class="id" type="var">Label</span> → <span class="id" type="var">block</span> <span class="id" type="var">Label</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">If</span> : <span class="id" type="var">bexp</span> → <span class="id" type="var">Label</span> → <span class="id" type="var">Label</span> → <span class="id" type="var">block</span> <span class="id" type="var">Label</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Assign</span> : <span class="id" type="var">string</span> → <span class="id" type="var">aexp</span> → <span class="id" type="var">block</span> <span class="id" type="var">Label</span> → <span class="id" type="var">block</span> <span class="id" type="var">Label</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="var">Arguments</span> <span class="id" type="var">Goto</span> {<span class="id" type="var">Label</span>} <span class="id" type="var">_</span>.<br/>
<span class="id" type="var">Arguments</span> <span class="id" type="var">If</span>   {<span class="id" type="var">Label</span>} <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>.<br/>
<span class="id" type="var">Arguments</span> <span class="id" type="var">Assign</span> {<span class="id" type="var">Label</span>} <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>.<br/>
</div>

<div class="doc">
We use the "even or odd" program, expressed above in Imp, as our
    running example.  Converting this program into a flowchart turns
    out to require 4 labels, so we define the following type. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <span class="id" type="var">parity_label</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">entry</span> : <span class="id" type="var">parity_label</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">loop</span>  : <span class="id" type="var">parity_label</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">body</span>  : <span class="id" type="var">parity_label</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">done</span>  : <span class="id" type="var">parity_label</span>.<br/>
</div>

<div class="doc">
The following <span class="inlinecode"><span class="id" type="var">block</span></span> is the basic block found at the <span class="inlinecode"><span class="id" type="var">body</span></span> label
    of the example program. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">parity_body</span> : <span class="id" type="var">block</span> <span class="id" type="var">parity_label</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Assign</span> <span class="id" type="var">Y</span> (<span class="id" type="var">Y</span> - 1)<br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Assign</span> <span class="id" type="var">X</span> (1 - <span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Goto</span> <span class="id" type="var">loop</span>)).<br/>
</div>

<div class="doc">
To evaluate a basic block, given an initial state, is to compute
    the final state and the label to jump to next.  Because basic
    blocks do not _contain_ loops or other control structures,
    evaluation of basic blocks is a total function &mdash; we don't need to
    worry about non-termination. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">keval</span> {<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">k</span> : <span class="id" type="var">block</span> <span class="id" type="var">L</span>) : <span class="id" type="var">state</span> * <span class="id" type="var">L</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">k</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Goto</span> <span class="id" type="var">l</span> ⇒ (<span class="id" type="var">st</span>, <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">If</span> <span class="id" type="var">b</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> ⇒ (<span class="id" type="var">st</span>, <span class="id" type="keyword">if</span> <span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b</span> <span class="id" type="keyword">then</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="keyword">else</span> <span class="id" type="var">l<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">Assign</span> <span class="id" type="var">i</span> <span class="id" type="var">a</span> <span class="id" type="var">k</span> ⇒ <span class="id" type="var">keval</span> (<span class="id" type="var">t_update</span> <span class="id" type="var">st</span> <span class="id" type="var">i</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a</span>)) <span class="id" type="var">k</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">keval_example</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">keval</span> { <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 0 } <span class="id" type="var">parity_body</span><br/>
&nbsp;&nbsp;= ({ <span class="id" type="var">Y</span> <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 0 ; <span class="id" type="var">X</span> <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 1 }, <span class="id" type="var">loop</span>).<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab584"></a><h2 class="section">Flowchart programs</h2>

<div class="paragraph"> </div>

 A flowchart program is simply a lookup function that maps labels
    to basic blocks.  Actually, some labels are _halting states_ and
    do not map to any basic block.  So, more precisely, a flowchart
    <span class="inlinecode"><span class="id" type="var">program</span></span> whose labels are of type <span class="inlinecode"><span class="id" type="var">L</span></span> is a function from <span class="inlinecode"><span class="id" type="var">L</span></span> to
    <span class="inlinecode"><span class="id" type="var">option</span></span> <span class="inlinecode">(<span class="id" type="var">block</span></span> <span class="inlinecode"><span class="id" type="var">L</span>)</span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <span class="id" type="var">program</span> (<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>) : <span class="id" type="keyword">Type</span> := <span class="id" type="var">L</span> → <span class="id" type="var">option</span> (<span class="id" type="var">block</span> <span class="id" type="var">L</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">parity</span> : <span class="id" type="var">program</span> <span class="id" type="var">parity_label</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">l</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">l</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">entry</span> ⇒ <span class="id" type="var">Some</span> (<span class="id" type="var">Assign</span> <span class="id" type="var">X</span> 0 (<span class="id" type="var">Goto</span> <span class="id" type="var">loop</span>))<br/>
&nbsp;&nbsp;| <span class="id" type="var">loop</span> ⇒ <span class="id" type="var">Some</span> (<span class="id" type="var">If</span> (1 ≤ <span class="id" type="var">Y</span>) <span class="id" type="var">body</span> <span class="id" type="var">done</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">body</span> ⇒ <span class="id" type="var">Some</span> <span class="id" type="var">parity_body</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">done</span> ⇒ <span class="id" type="var">None</span> <span class="comment">(*&nbsp;halt&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Unlike a basic block, a program may not terminate, so we model the
    evaluation of programs by an inductive relation <span class="inlinecode"><span class="id" type="var">peval</span></span> rather
    than a recursive function. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <span class="id" type="var">peval</span> {<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">p</span> : <span class="id" type="var">program</span> <span class="id" type="var">L</span>)<br/>
&nbsp;&nbsp;: <span class="id" type="var">state</span> → <span class="id" type="var">L</span> → <span class="id" type="var">state</span> → <span class="id" type="var">L</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_None</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">p</span> <span class="id" type="var">l</span> = <span class="id" type="var">None</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">peval</span> <span class="id" type="var">p</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Some</span>: <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span> <span class="id" type="var">k</span> <span class="id" type="var">st'</span> <span class="id" type="var">l'</span> <span class="id" type="var">st''</span> <span class="id" type="var">l''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">p</span> <span class="id" type="var">l</span> = <span class="id" type="var">Some</span> <span class="id" type="var">k</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">keval</span> <span class="id" type="var">st</span> <span class="id" type="var">k</span> = (<span class="id" type="var">st'</span>, <span class="id" type="var">l'</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">peval</span> <span class="id" type="var">p</span> <span class="id" type="var">st'</span> <span class="id" type="var">l'</span> <span class="id" type="var">st''</span> <span class="id" type="var">l''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">peval</span> <span class="id" type="var">p</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span> <span class="id" type="var">st''</span> <span class="id" type="var">l''</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">parity_eval</span>: <span class="id" type="var">peval</span> <span class="id" type="var">parity</span> { <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 0 } <span class="id" type="var">entry</span>  { <span style="font-size: 80%;"><span style="letter-spacing:-.1em;">-</span><span style="letter-spacing:-.1em;">-</span>&gt;</span> 0 } <span class="id" type="var">done</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">erewrite</span> <span class="id" type="tactic">f_equal</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">f</span> := <span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> ⇒ <span class="id" type="var">peval</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span> <span class="id" type="var">st</span> <span class="id" type="var">_</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Some</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Some</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_None</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">i</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">t_update_same</span>; <span class="id" type="tactic">auto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab585"></a><h2 class="section">Partial Evaluation of Basic Blocks and Flowchart Programs</h2>

<div class="paragraph"> </div>

 Partial evaluation changes the label type in a systematic way: if
    the label type used to be <span class="inlinecode"><span class="id" type="var">L</span></span>, it becomes <span class="inlinecode"><span class="id" type="var">pe_state</span></span> <span class="inlinecode">*</span> <span class="inlinecode"><span class="id" type="var">L</span></span>.  So the
    same label in the original program may be unfolded, or blown up,
    into multiple labels by being paired with different partial
    states.  For example, the label <span class="inlinecode"><span class="id" type="var">loop</span></span> in the <span class="inlinecode"><span class="id" type="var">parity</span></span> program
    will become two labels: <span class="inlinecode">([(<span class="id" type="var">X</span>,0)],</span> <span class="inlinecode"><span class="id" type="var">loop</span>)</span> and <span class="inlinecode">([(<span class="id" type="var">X</span>,1)],</span> <span class="inlinecode"><span class="id" type="var">loop</span>)</span>.
    This change of label type is reflected in the types of <span class="inlinecode"><span class="id" type="var">pe_block</span></span>
    and <span class="inlinecode"><span class="id" type="var">pe_program</span></span> defined presently. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">pe_block</span> {<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">k</span> : <span class="id" type="var">block</span> <span class="id" type="var">L</span>)<br/>
&nbsp;&nbsp;: <span class="id" type="var">block</span> (<span class="id" type="var">pe_state</span> * <span class="id" type="var">L</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">k</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Goto</span> <span class="id" type="var">l</span> ⇒ <span class="id" type="var">Goto</span> (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">If</span> <span class="id" type="var">b</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BTrue</span>  ⇒ <span class="id" type="var">Goto</span> (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> ⇒ <span class="id" type="var">Goto</span> (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">b'</span>     ⇒ <span class="id" type="var">If</span> <span class="id" type="var">b'</span> (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l<sub>1</sub></span>) (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">Assign</span> <span class="id" type="var">i</span> <span class="id" type="var">a</span> <span class="id" type="var">k</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span> ⇒ <span class="id" type="var">pe_block</span> (<span class="id" type="var">pe_add</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">i</span> <span class="id" type="var">n</span>) <span class="id" type="var">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">a'</span> ⇒ <span class="id" type="var">Assign</span> <span class="id" type="var">i</span> <span class="id" type="var">a'</span> (<span class="id" type="var">pe_block</span> (<span class="id" type="var">pe_remove</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">i</span>) <span class="id" type="var">k</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">pe_block_example</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_block</span> [(<span class="id" type="var">X</span>,0)] <span class="id" type="var">parity_body</span><br/>
&nbsp;&nbsp;= <span class="id" type="var">Assign</span> <span class="id" type="var">Y</span> (<span class="id" type="var">Y</span> - 1) (<span class="id" type="var">Goto</span> ([(<span class="id" type="var">X</span>,1)], <span class="id" type="var">loop</span>)).<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_block_correct</span>: <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>) <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">k</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span> (<span class="id" type="var">l'</span>:<span class="id" type="var">L</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">keval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_block</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">k</span>) = (<span class="id" type="var">st'</span>, (<span class="id" type="var">pe_st'</span>, <span class="id" type="var">l'</span>)) →<br/>
&nbsp;&nbsp;<span class="id" type="var">keval</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">k</span> = (<span class="id" type="var">pe_update</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span>, <span class="id" type="var">l'</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">pe_st</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">k</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">l</span> | <span class="id" type="var">b</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span> | <span class="id" type="var">i</span> <span class="id" type="var">a</span> <span class="id" type="var">k</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Goto&nbsp;*)</span> <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;If&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">keval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_block</span> <span class="id" type="var">pe_st</span> (<span class="id" type="var">If</span> <span class="id" type="var">b</span> <span class="id" type="var">l<sub>1</sub></span> <span class="id" type="var">l<sub>2</sub></span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">with</span> (<span class="id" type="var">keval</span> <span class="id" type="var">st</span> (<span class="id" type="var">If</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span>) (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l<sub>1</sub></span>) (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l<sub>2</sub></span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">in</span> <span class="id" type="var">H</span> <span class="id" type="tactic">by</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span>); <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_bexp_correct</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">beval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_bexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">b</span>)); <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Assign&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> *. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_aexp_correct</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">pe_aexp</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">a</span>); <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_update_update_add</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHk</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">solve</span> [<span class="id" type="tactic">rewrite</span> <span class="id" type="var">pe_update_update_remove</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">IHk</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>].<br/>
<span class="id" type="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pe_program</span> {<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">p</span> : <span class="id" type="var">program</span> <span class="id" type="var">L</span>)<br/>
&nbsp;&nbsp;: <span class="id" type="var">program</span> (<span class="id" type="var">pe_state</span> * <span class="id" type="var">L</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">pe_l</span> ⇒ <span class="id" type="keyword">match</span> <span class="id" type="var">pe_l</span> <span class="id" type="keyword">with</span> | (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">option_map</span> (<span class="id" type="var">pe_block</span> <span class="id" type="var">pe_st</span>) (<span class="id" type="var">p</span> <span class="id" type="var">l</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">pe_peval</span> {<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>} (<span class="id" type="var">p</span> : <span class="id" type="var">program</span> <span class="id" type="var">L</span>)<br/>
&nbsp;&nbsp;(<span class="id" type="var">st</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">pe_st</span>:<span class="id" type="var">pe_state</span>) (<span class="id" type="var">l</span>:<span class="id" type="var">L</span>) (<span class="id" type="var">st'o</span>:<span class="id" type="var">state</span>) (<span class="id" type="var">l'</span>:<span class="id" type="var">L</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">pe_peval_intro</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">peval</span> (<span class="id" type="var">pe_program</span> <span class="id" type="var">p</span>) <span class="id" type="var">st</span> (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l</span>) <span class="id" type="var">st'</span> (<span class="id" type="var">pe_st'</span>, <span class="id" type="var">l'</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_update</span> <span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span> = <span class="id" type="var">st'o</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pe_peval</span> <span class="id" type="var">p</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span> <span class="id" type="var">st'o</span> <span class="id" type="var">l'</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pe_program_correct</span>:<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">L</span>:<span class="id" type="keyword">Type</span>) (<span class="id" type="var">p</span> : <span class="id" type="var">program</span> <span class="id" type="var">L</span>) <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span> <span class="id" type="var">st'o</span> <span class="id" type="var">l'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">peval</span> <span class="id" type="var">p</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="var">l</span> <span class="id" type="var">st'o</span> <span class="id" type="var">l'</span> ↔<br/>
&nbsp;&nbsp;<span class="id" type="var">pe_peval</span> <span class="id" type="var">p</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">l</span> <span class="id" type="var">st'o</span> <span class="id" type="var">l'</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span> <span class="id" type="tactic">intros</span> <span class="id" type="var">Heval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_update</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">sto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">pe_st</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Heval</span> <span class="id" type="keyword">as</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="id" type="var">sto</span> <span class="id" type="var">l</span> <span class="id" type="var">Hlookup</span> | <span class="id" type="var">sto</span> <span class="id" type="var">l</span> <span class="id" type="var">k</span> <span class="id" type="var">st'o</span> <span class="id" type="var">l'</span> <span class="id" type="var">st''o</span> <span class="id" type="var">l''</span> <span class="id" type="var">Hlookup</span> <span class="id" type="var">Hkeval</span> <span class="id" type="var">Heval</span> ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">Heqsto</span>; <span class="id" type="tactic">subst</span> <span class="id" type="var">sto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_None&nbsp;*)</span> <span class="id" type="tactic">eapply</span> <span class="id" type="var">pe_peval_intro</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_None</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hlookup</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_Some&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">keval</span> <span class="id" type="var">st</span> (<span class="id" type="var">pe_block</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">k</span>)) <span class="id" type="keyword">as</span> <span class="id" type="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">x</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">st'</span> [<span class="id" type="var">pe_st'</span> <span class="id" type="var">l'_</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Heqx</span>. <span class="id" type="var">erewrite</span> <span class="id" type="var">pe_block_correct</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hkeval</span> <span class="id" type="tactic">by</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">Heqx</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hkeval</span>. <span class="id" type="tactic">subst</span> <span class="id" type="var">st'o</span> <span class="id" type="var">l'_</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">Hkeval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">edestruct</span> <span class="id" type="var">IHHeval</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">subst</span> <span class="id" type="var">st''o</span>. <span class="id" type="tactic">clear</span> <span class="id" type="var">IHHeval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">pe_peval_intro</span>; [| <span class="id" type="tactic">reflexivity</span>]. <span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Some</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hlookup</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span> <span class="id" type="tactic">intros</span> [<span class="id" type="var">st'</span> <span class="id" type="var">pe_st'</span> <span class="id" type="var">Heval</span> <span class="id" type="var">Heqst'o</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_st</span>, <span class="id" type="var">l</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">pe_st_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">pe_st'</span>, <span class="id" type="var">l'</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">pe_st'_l'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">pe_st</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Heval</span> <span class="id" type="keyword">as</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="id" type="var">st</span> [<span class="id" type="var">pe_st_</span> <span class="id" type="var">l_</span>] <span class="id" type="var">Hlookup</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">st</span> [<span class="id" type="var">pe_st_</span> <span class="id" type="var">l_</span>] <span class="id" type="var">pe_k</span> <span class="id" type="var">st'</span> [<span class="id" type="var">pe_st'_</span> <span class="id" type="var">l'_</span>] <span class="id" type="var">st''</span> [<span class="id" type="var">pe_st''</span> <span class="id" type="var">l''</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Hlookup</span> <span class="id" type="var">Hkeval</span> <span class="id" type="var">Heval</span> ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">l</span> <span class="id" type="var">pe_st</span> <span class="id" type="var">Heqpe_st_l</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqpe_st_l</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqpe_st'_l'</span>; <span class="id" type="tactic">repeat</span> <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_None&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">E_None</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hlookup</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">p</span> <span class="id" type="var">l'</span>); [ <span class="id" type="var">solve</span> [ <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hlookup</span> ] | <span class="id" type="tactic">reflexivity</span> ].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_Some&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hlookup</span>. <span class="id" type="var">remember</span> (<span class="id" type="var">p</span> <span class="id" type="var">l</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">k</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">k</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">k</span>|]; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hlookup</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <span class="id" type="var">E_Some</span>; <span class="id" type="tactic">eauto</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">pe_block_correct</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">Hkeval</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

</div>



</div>

</body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>SearchTree: Binary Search Trees</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/vfa.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://coq-zh.github.io/SF-zh/'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 3: 函数式算法验证</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>目录</a></li>
   <li class='section_name'><a href='coqindex.html'>索引</a></li>
   <li class='section_name'><a href='deps.html'>路线</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">SearchTree<span class="subtitle">Binary Search Trees</span></h1>

<div class="code">
</div>

<div class="doc">

<div class="paragraph"> </div>

 Binary search trees are an efficient data structure for
   lookup tables, that is, mappings from keys to values.
   The <span class="inlinecode"><span class="id" title="var">total_map</span></span> type from Maps.v is an <i>inefficient</i>
   implementation: if you add N items to your total_map,
   then looking them up takes N comparisons in the worst case,
   and N/2 comparisons in the average case.

<div class="paragraph"> </div>

   In contrast, if your <span class="inlinecode"><span class="id" title="var">key</span></span> type is a total order -- that is,
   if it has a less-than comparison that's transitive and
   antisymmetric <span class="inlinecode"></span> <span class="inlinecode"><span class="id" title="var">a</span>&lt;<span class="id" title="var">b</span></span> <span class="inlinecode">↔</span>  <span class="inlinecode">~(<span class="id" title="var">b</span>&lt;<span class="id" title="var">a</span>)</span> <span class="inlinecode"></span> -- then one can implement
   binary search trees (BSTs).   We will assume you know how BSTs
   work; you can learn this from:
<ul class="doclist">
<li> Section 3.2 of  <i>Algorithms, Fourth Edition</i>,
       by Sedgewick and Wayne, Addison Wesley 2011;  or

</li>
<li> Chapter 12 of <i>Introduction to Algorithms, 3rd Edition</i>,
       by Cormen, Leiserson, and Rivest, MIT Press 2009.

</li>
</ul>

<div class="paragraph"> </div>

   Our focus here is to <i>prove the correctness of an implementation</i>
   of binary search trees. 
</div>
<div class="code">

<br/>
<span class="id" title="var">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Strings.String.html#"><span class="id" title="library">Strings.String</span></a>.<br/>
<span class="id" title="var">From</span> <span class="id" title="var">VFA</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="Perm.html#"><span class="id" title="library">Perm</span></a>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Logic.FunctionalExtensionality.html#"><span class="id" title="library">FunctionalExtensionality</span></a>.<br/>
</div>

<div class="doc">
<a name="lab60"></a><h1 class="section">Total and Partial Maps</h1>

<div class="paragraph"> </div>

 Recall the <span class="inlinecode"><span class="id" title="var">Maps</span></span> chapter of Volume 1 (Logical Foundations),
    describing functions from identifiers to some arbitrary type <span class="inlinecode"><span class="id" title="var">A</span></span>.
    VFA's <span class="inlinecode"><span class="id" title="var">Maps</span></span> module is almost exactly the same, except that it
    implements functions from <span class="inlinecode"><span class="id" title="var">nat</span></span> to some arbitrary type <span class="inlinecode"><span class="id" title="var">A</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="var">From</span> <span class="id" title="var">VFA</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="library">Maps</span>.<br/>
</div>

<div class="doc">
<a name="lab61"></a><h1 class="section">Sections</h1>

<div class="paragraph"> </div>

 We will use Coq's <span class="inlinecode"><span class="id" title="keyword">Section</span></span> feature to structure this development,
     so first a brief introduction to Sections.  We'll use the example
     of lookup tables implemented by lists. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Module</span> <a name="SectionExample1"><span class="id" title="module">SectionExample1</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="SectionExample1.mymap"><span class="id" title="definition">mymap</span></a> (<span class="id" title="var">V</span>: <span class="id" title="keyword">Type</span>) := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="SectionExample1.empty"><span class="id" title="definition">empty</span></a> (<span class="id" title="var">V</span>: <span class="id" title="keyword">Type</span>) : <a class="idref" href="SearchTree.html#SectionExample1.mymap"><span class="id" title="definition">mymap</span></a> <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="SectionExample1.lookup"><span class="id" title="definition">lookup</span></a> (<span class="id" title="var">V</span>: <span class="id" title="keyword">Type</span>) (<span class="id" title="var">default</span>: <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">x</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) (<span class="id" title="var">m</span>: <a class="idref" href="SearchTree.html#SectionExample1.mymap"><span class="id" title="definition">mymap</span></a> <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a>) : <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#m"><span class="id" title="variable">m</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">a</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><span class="id" title="var">al</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a> <span class="id" title="var">a</span> <span class="id" title="keyword">then</span> <span class="id" title="var">v</span> <span class="id" title="keyword">else</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a> <a class="idref" href="SearchTree.html#default"><span class="id" title="variable">default</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">al</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <a class="idref" href="SearchTree.html#default"><span class="id" title="variable">default</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="SectionExample1.lookup_empty"><span class="id" title="lemma">lookup_empty</span></a> (<span class="id" title="var">V</span>: <span class="id" title="keyword">Type</span>) (<span class="id" title="var">default</span>: <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">x</span>, <a class="idref" href="SearchTree.html#SectionExample1.lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a> <a class="idref" href="SearchTree.html#default"><span class="id" title="variable">default</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> (<a class="idref" href="SearchTree.html#SectionExample1.empty"><span class="id" title="definition">empty</span></a> <a class="idref" href="SearchTree.html#V"><span class="id" title="variable">V</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#default"><span class="id" title="variable">default</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">reflexivity</span>. <span class="id" title="keyword">Qed</span>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="SearchTree.html#SectionExample1"><span class="id" title="module">SectionExample1</span></a>.<br/>
</div>

<div class="doc">
It sure is tedious to repeat the <span class="inlinecode"><span class="id" title="var">V</span></span> and <span class="inlinecode"><span class="id" title="var">default</span></span> parameters
     in every definition and every theorem.  The <span class="inlinecode"><span class="id" title="keyword">Section</span></span> feature
     allows us to declare them as parameters to every definition
     and theorem in the entire section: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Module</span> <a name="SectionExample2"><span class="id" title="module">SectionExample2</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Section</span> <a name="SectionExample2.MAPS"><span class="id" title="section">MAPS</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Variable</span> <a name="SectionExample2.MAPS.V"><span class="id" title="variable">V</span></a> : <span class="id" title="keyword">Type</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Variable</span> <a name="SectionExample2.MAPS.default"><span class="id" title="variable">default</span></a>: <a class="idref" href="SearchTree.html#SectionExample2.MAPS.V"><span class="id" title="variable">V</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="SectionExample2.mymap"><span class="id" title="definition">mymap</span></a>  := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#SectionExample2.MAPS.V"><span class="id" title="variable">V</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="SectionExample2.empty"><span class="id" title="definition">empty</span></a> : <a class="idref" href="SearchTree.html#SectionExample2.mymap"><span class="id" title="definition">mymap</span></a> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="SectionExample2.lookup"><span class="id" title="definition">lookup</span></a> (<span class="id" title="var">x</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) (<span class="id" title="var">m</span>: <a class="idref" href="SearchTree.html#SectionExample2.mymap"><span class="id" title="definition">mymap</span></a>) : <a class="idref" href="SearchTree.html#SectionExample2.MAPS.V"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#m"><span class="id" title="variable">m</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">a</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><span class="id" title="var">al</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a> <span class="id" title="var">a</span> <span class="id" title="keyword">then</span> <span class="id" title="var">v</span> <span class="id" title="keyword">else</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">al</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <a class="idref" href="SearchTree.html#SectionExample2.MAPS.default"><span class="id" title="variable">default</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="SectionExample2.lookup_empty"><span class="id" title="lemma">lookup_empty</span></a>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">x</span>, <a class="idref" href="SearchTree.html#SectionExample2.lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="SearchTree.html#SectionExample2.empty"><span class="id" title="definition">empty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#SectionExample2.MAPS.default"><span class="id" title="variable">default</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">reflexivity</span>. <span class="id" title="keyword">Qed</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">End</span> <a class="idref" href="SearchTree.html#SectionExample2.MAPS"><span class="id" title="section">MAPS</span></a>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="SearchTree.html#SectionExample2"><span class="id" title="module">SectionExample2</span></a>.<br/>
</div>

<div class="doc">
At the close of the section, this produces exactly the same
     result:  the functions that "need" to be parametrized by
     <span class="inlinecode"><span class="id" title="var">V</span></span> or <span class="inlinecode"><span class="id" title="var">default</span></span> are given extra parameters.  We can test
     this claim, as follows: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Goal</span> <a class="idref" href="SearchTree.html#empty"><span class="id" title="definition">SectionExample1.empty</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#empty"><span class="id" title="definition">SectionExample2.empty</span></a>.<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">reflexivity</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Goal</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">SectionExample1.lookup</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">SectionExample2.lookup</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">SectionExample1.lookup</span></a>, <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">SectionExample2.lookup</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="tactic">reflexivity</span>. <span class="comment">(*&nbsp;doesn't&nbsp;do&nbsp;anything.&nbsp;*)</span><br/>
</div>

<div class="doc">
Well, not exactly the same; but certainly equivalent.
   Functions <span class="inlinecode"><span class="id" title="var">f</span></span> and <span class="inlinecode"><span class="id" title="var">g</span></span> are "extensionally equal" if, for every
   argument <span class="inlinecode"><span class="id" title="var">x</span></span>, <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">g</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span>.  The Axiom of Extensionality
   says that if two functions are "extensionally equal" then they
   are <i>equal</i>.  The <span class="inlinecode"><span class="id" title="tactic">extensionality</span></span> tactic is just a convenient
   way of applying the axiom of extensionality. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="tactic">extensionality</span> <span class="id" title="var">V</span>; <span class="id" title="tactic">extensionality</span> <span class="id" title="var">default</span>; <span class="id" title="tactic">extensionality</span> <span class="id" title="var">x</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">extensionality</span> <span class="id" title="var">m</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">m</span> <span class="id" title="keyword">as</span> [| [? ?] ]; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a><span class="id" title="var">n</span>); <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab62"></a><h1 class="section">Program for Binary Search Trees</h1>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Section</span> <a name="TREES"><span class="id" title="section">TREES</span></a>.<br/>
<span class="id" title="keyword">Variable</span> <a name="TREES.V"><span class="id" title="variable">V</span></a> : <span class="id" title="keyword">Type</span>.<br/>
<span class="id" title="keyword">Variable</span> <a name="TREES.default"><span class="id" title="variable">default</span></a>: <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="key"><span class="id" title="definition">key</span></a> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a name="tree"><span class="id" title="inductive">tree</span></a> : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;| <a name="E"><span class="id" title="constructor">E</span></a> : <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a><br/>
&nbsp;| <a name="T"><span class="id" title="constructor">T</span></a>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="empty_tree"><span class="id" title="definition">empty_tree</span></a> : <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> := <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a name="lookup"><span class="id" title="definition">lookup</span></a> (<span class="id" title="var">x</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">tl</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">tr</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> <span class="id" title="var">k</span> <span class="id" title="keyword">then</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">k</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">tr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a name="insert"><span class="id" title="definition">insert</span></a> (<span class="id" title="var">x</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span>: <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">s</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> :=<br/>
&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#s"><span class="id" title="variable">s</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;| <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a><br/>
&nbsp;| <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">a</span> <span class="id" title="var">y</span> <span class="id" title="var">v'</span> <span class="id" title="var">b</span> ⇒ <span class="id" title="keyword">if</span>  <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> <span class="id" title="var">y</span> <span class="id" title="keyword">then</span> <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <span class="id" title="var">a</span>) <span class="id" title="var">y</span> <span class="id" title="var">v'</span> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">y</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">a</span> <span class="id" title="var">y</span> <span class="id" title="var">v'</span> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <span class="id" title="var">b</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">a</span> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <span class="id" title="var">b</span><br/>
&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a name="elements'"><span class="id" title="definition">elements'</span></a> (<span class="id" title="var">s</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">base</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>)) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#s"><span class="id" title="variable">s</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;| <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="SearchTree.html#base"><span class="id" title="variable">base</span></a><br/>
&nbsp;| <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">a</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">b</span> ⇒ <a class="idref" href="SearchTree.html#elements'"><span class="id" title="definition">elements'</span></a> <span class="id" title="var">a</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">k</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a> <a class="idref" href="SearchTree.html#elements'"><span class="id" title="definition">elements'</span></a> <span class="id" title="var">b</span> <a class="idref" href="SearchTree.html#base"><span class="id" title="variable">base</span></a>)<br/>
&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="elements"><span class="id" title="definition">elements</span></a> (<span class="id" title="var">s</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) := <a class="idref" href="SearchTree.html#elements'"><span class="id" title="definition">elements'</span></a> <a class="idref" href="SearchTree.html#s"><span class="id" title="variable">s</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>.<br/>
</div>

<div class="doc">
<a name="lab63"></a><h1 class="section">Search Tree Examples</h1>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Section</span> <a name="TREES.EXAMPLES"><span class="id" title="section">EXAMPLES</span></a>.<br/>
<span class="id" title="keyword">Variables</span> <a name="TREES.EXAMPLES.v2"><span class="id" title="variable">v<sub>2</sub></span></a> <a name="TREES.EXAMPLES.v4"><span class="id" title="variable">v<sub>4</sub></span></a> <a name="TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> : <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>.<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> <a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> 5 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> 2 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v2"><span class="id" title="variable">v<sub>2</sub></span></a> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> 4 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> <a class="idref" href="SearchTree.html#empty_tree"><span class="id" title="definition">empty_tree</span></a>)).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;T&nbsp;(T&nbsp;E&nbsp;2&nbsp;v<sub>2</sub>&nbsp;E)&nbsp;4&nbsp;v<sub>5</sub>&nbsp;(T&nbsp;E&nbsp;5&nbsp;v<sub>5</sub>&nbsp;E)&nbsp;*)</span><br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> 5 (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 2 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v2"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 4 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 5 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>)).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;v<sub>5</sub>&nbsp;*)</span><br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> 3 (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 2 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v2"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 4 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 5 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>)).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;default&nbsp;*)</span><br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> <a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 2 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v2"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 4 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 5 <a class="idref" href="SearchTree.html#TREES.EXAMPLES.v5"><span class="id" title="variable">v<sub>5</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>)).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="inlinecode">(2,</span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>);</span> <span class="inlinecode">(4,</span> <span class="inlinecode"><span class="id" title="var">v<sub>5</sub></span>);</span> <span class="inlinecode">(5,</span> <span class="inlinecode"><span class="id" title="var">v<sub>5</sub></span>)</span>&nbsp;*)</span><br/>
<span class="id" title="keyword">End</span> <a class="idref" href="SearchTree.html#TREES.EXAMPLES"><span class="id" title="section">EXAMPLES</span></a>.<br/>
</div>

<div class="doc">
<a name="lab64"></a><h1 class="section">What Should We Prove About Search trees?</h1>

<div class="paragraph"> </div>

 Search trees are meant to be an implementation of maps.
   That is, they have an <span class="inlinecode"><span class="id" title="var">insert</span></span> function that corresponds to the
   <span class="inlinecode"><span class="id" title="var">update</span></span> function of a map, and a <span class="inlinecode"><span class="id" title="var">lookup</span></span> function that
   corresponds to applying the map to an argument.  To prove the
   correctness of a search-tree algorithm, we can prove:
<ul class="doclist">
<li> Any search tree corresponds to some map, using a function or
         relation that we demonstrate.

</li>
<li> The lookup function gives the same result as applying the map

</li>
<li> The insert function returns a corresponding map.

</li>
<li> Maps have the properties we actually wanted.  It would do no
     good to prove that searchtrees correspond to some abstract
     type X, if X didn't have useful properties!

</li>
</ul>

<div class="paragraph"> </div>

  What properties do we want searchtrees to have?  If I insert
  the binding <span class="inlinecode">(<span class="id" title="var">k</span>,<span class="id" title="var">v</span>)</span> into a searchtree <span class="inlinecode"><span class="id" title="var">t</span></span>, then look up <span class="inlinecode"><span class="id" title="var">k</span></span>, I
  should get <span class="inlinecode"><span class="id" title="var">v</span></span>. If I look up <span class="inlinecode"><span class="id" title="var">k'</span></span> in <span class="inlinecode"><span class="id" title="var">insert</span></span> <span class="inlinecode">(<span class="id" title="var">k</span>,<span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">t</span></span>, where <span class="inlinecode"><span class="id" title="var">k'</span>≠<span class="id" title="var">k</span></span>,
  then I should get the same result as <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">k</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.  There are several
  more properties. Fortunately, all these properties are already proved
  about <span class="inlinecode"><span class="id" title="var">total_map</span></span> in the <span class="inlinecode"><span class="id" title="var">Maps</span></span> module: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Check</span> <span class="id" title="axiom">t_update_eq</span>. <span class="comment">(*&nbsp;&nbsp;:&nbsp;forall&nbsp;(A&nbsp;:&nbsp;Type)&nbsp;(m&nbsp;:&nbsp;total_map&nbsp;A)&nbsp;(x&nbsp;:&nbsp;id)&nbsp;(v&nbsp;:&nbsp;A),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_update&nbsp;m&nbsp;x&nbsp;v&nbsp;x&nbsp;=&nbsp;v&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <span class="id" title="axiom">t_update_neq</span>. <span class="comment">(*&nbsp;:&nbsp;forall&nbsp;(X&nbsp;:&nbsp;Type)&nbsp;(v&nbsp;:&nbsp;X)&nbsp;(x<sub>1</sub>&nbsp;x<sub>2</sub>&nbsp;:&nbsp;id)&nbsp;(m&nbsp;:&nbsp;total_map&nbsp;X),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<sub>1</sub>&nbsp;&lt;&gt;&nbsp;x<sub>2</sub>&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;t_update&nbsp;m&nbsp;x<sub>1</sub>&nbsp;v&nbsp;x<sub>2</sub>&nbsp;=&nbsp;m&nbsp;x<sub>2</sub>&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <span class="id" title="axiom">t_update_shadow</span>. <span class="comment">(*&nbsp;:&nbsp;forall&nbsp;(A&nbsp;:&nbsp;Type)&nbsp;(m&nbsp;:&nbsp;total_map&nbsp;A)&nbsp;(v<sub>1</sub>&nbsp;v<sub>2</sub>&nbsp;:&nbsp;A)&nbsp;(x&nbsp;:&nbsp;id),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_update&nbsp;(t_update&nbsp;m&nbsp;x&nbsp;v<sub>1</sub>)&nbsp;x&nbsp;v<sub>2</sub>&nbsp;=&nbsp;t_update&nbsp;m&nbsp;x&nbsp;v<sub>2</sub>&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <span class="id" title="axiom">t_update_same</span>. <span class="comment">(*&nbsp;:&nbsp;forall&nbsp;(X&nbsp;:&nbsp;Type)&nbsp;(x&nbsp;:&nbsp;id)&nbsp;(m&nbsp;:&nbsp;total_map&nbsp;X),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_update&nbsp;m&nbsp;x&nbsp;(m&nbsp;x)&nbsp;=&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <span class="id" title="axiom">t_update_permute</span>. <span class="comment">(*&nbsp;forall&nbsp;(X&nbsp;:&nbsp;Type)&nbsp;(v<sub>1</sub>&nbsp;v<sub>2</sub>&nbsp;:&nbsp;X)&nbsp;(x<sub>1</sub>&nbsp;x<sub>2</sub>&nbsp;:&nbsp;id)&nbsp;(m&nbsp;:&nbsp;total_map&nbsp;X),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x<sub>2</sub>&nbsp;&lt;&gt;&nbsp;x<sub>1</sub>&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_update&nbsp;(t_update&nbsp;m&nbsp;x<sub>2</sub>&nbsp;v<sub>2</sub>)&nbsp;x<sub>1</sub>&nbsp;v<sub>1</sub>&nbsp;=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_update&nbsp;(t_update&nbsp;m&nbsp;x<sub>1</sub>&nbsp;v<sub>1</sub>)&nbsp;x<sub>2</sub>&nbsp;v<sub>2</sub>&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" title="keyword">Check</span> <span class="id" title="axiom">t_apply_empty</span>. <span class="comment">(*&nbsp;:&nbsp;forall&nbsp;(A&nbsp;:&nbsp;Type)&nbsp;(x&nbsp;:&nbsp;id)&nbsp;(v&nbsp;:&nbsp;A),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t_empty&nbsp;v&nbsp;x&nbsp;=&nbsp;v&nbsp;*)</span><br/>
</div>

<div class="doc">
So, if we like those properties that <span class="inlinecode"><span class="id" title="var">total_map</span></span> is proved to have,
   and we can prove that searchtrees behave like maps, then we don't
   have to reprove each individual property about searchtrees.

<div class="paragraph"> </div>

   More generally:  a job worth doing is worth doing well.
   It does no good to prove the "correctness" of a program, if you
   prove that it satisfies a wrong or useless specification. 
<div class="paragraph"> </div>

<a name="lab65"></a><h1 class="section">Efficiency of Search Trees</h1>

<div class="paragraph"> </div>

 We use binary search trees because they are efficient.  That is,
     if there are <span class="inlinecode"><span class="id" title="var">N</span></span> elements in a (reasonably well balanced) BST,
     each insertion or lookup takes about logN time.

<div class="paragraph"> </div>

     What could go wrong?

<div class="paragraph"> </div>

     1.  The search tree might not be balanced.  In that case, each
           insertion or lookup will take as much as linear time.

<div class="paragraph"> </div>

<ul class="doclist">
<li> SOLUTION: use an algorithm, such as "red-black trees",

</li>
</ul>
	   that ensures the trees stay balanced.  We'll do that in
           Chapter <a href="RedBlack.html"><span class="inlineref">RedBlack</span></a>.

<div class="paragraph"> </div>

     2.  Our keys are natural numbers, and Coq's <span class="inlinecode"><span class="id" title="var">nat</span></span> type takes
           linear time <i>per comparison</i>.  That is, computing (j &lt;? k)
           takes time proportional to the <i>value</i> of <span class="inlinecode"><span class="id" title="var">k</span>-<span class="id" title="var">j</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> SOLUTION: represent keys by a data type that has a more

</li>
</ul>
           efficient comparison operator.  We just use <span class="inlinecode"><span class="id" title="var">nat</span></span> in this
           chapter because it's something you're already familiar with.

<div class="paragraph"> </div>

     3.  There's no notion of "run time" in Coq.  That is, we can't
          say what it means that a Coq function "takes N steps to
          evaluate."  Therefore, we can't prove that binary search
          trees are efficient.

<div class="paragraph"> </div>

<ul class="doclist">
<li> SOLUTION 1: Don't prove (in Coq) that they're efficient;

</li>
</ul>
          just prove that they are correct.  Prove things about their
          efficiency the old-fashioned way, on pencil and paper.

<div class="paragraph"> </div>

<ul class="doclist">
<li> SOLUTION 2: Prove in Coq some facts about the height of

</li>
</ul>
          the trees, which have direct bearing on their efficiency.
          We'll explore that in later chapters.

<div class="paragraph"> </div>

      4.  Our functions in Coq aren't real implementations; they are
          just pretend models of real implementations.  What if there
          are bugs in the correspondence between the Coq function and
          the real implementation?

<div class="paragraph"> </div>

<ul class="doclist">
<li> SOLUTION: Use Coq's <span class="inlinecode"><span class="id" title="var">extraction</span></span> feature to derive the
	    real implementation (in Ocaml or Haskell) automatically
	    from the Coq function.  Or, use Coq's <span class="inlinecode"><span class="id" title="keyword">vm_compute</span></span> or
	    <span class="inlinecode"><span class="id" title="var">native_compute</span></span> feature to compile and run the programs
	    efficiently inside Coq.  We'll explore <span class="inlinecode"><span class="id" title="var">extraction</span></span> in a
	    later chapter. 
</li>
</ul>

<div class="paragraph"> </div>

<a name="lab66"></a><h1 class="section">Proof of Correctness</h1>

<div class="paragraph"> </div>

 We claim that a <span class="inlinecode"><span class="id" title="var">tree</span></span> "corresponds" to a <span class="inlinecode"><span class="id" title="var">total_map</span></span>.
     So we must exhibit an "abstraction relation"
     <span class="inlinecode"><span class="id" title="var">Abs</span>:</span> <span class="inlinecode"><span class="id" title="var">tree</span></span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" title="var">total_map</span></span> <span class="inlinecode"><span class="id" title="var">V</span></span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" title="keyword">Prop</span></span>.

<div class="paragraph"> </div>

    The idea is that <span class="inlinecode"><span class="id" title="var">Abs</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">m</span></span> says that tree <span class="inlinecode"><span class="id" title="var">t</span></span>
    is a representation of map <span class="inlinecode"><span class="id" title="var">m</span></span>; or that map <span class="inlinecode"><span class="id" title="var">m</span></span>
    is an abstraction of tree <span class="inlinecode"><span class="id" title="var">t</span></span>.  How should we
    define this abstraction relation?

<div class="paragraph"> </div>

    The empty tree is easy:   <span class="inlinecode"><span class="id" title="var">Abs</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">default</span>)</span>.

<div class="paragraph"> </div>

    Now, what about this tree?: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="example_tree"><span class="id" title="definition">example_tree</span></a> (<span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span> : <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 2 <a class="idref" href="SearchTree.html#v<sub>2</sub>"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 4 <a class="idref" href="SearchTree.html#v<sub>4</sub>"><span class="id" title="variable">v<sub>4</sub></span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 5 <a class="idref" href="SearchTree.html#v<sub>5</sub>"><span class="id" title="variable">v<sub>5</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>).<br/>
</div>

<div class="doc">
<a name="lab67"></a><h4 class="section">练习：2 星, standard (example_map)</h4>

</div>
<div class="code">
<span class="comment">(*&nbsp;Fill&nbsp;in&nbsp;the&nbsp;definition&nbsp;of&nbsp;example_map&nbsp;with&nbsp;a&nbsp;total_map&nbsp;that<br/>
&nbsp;&nbsp;you&nbsp;think&nbsp;example_tree&nbsp;should&nbsp;correspond&nbsp;to.&nbsp;&nbsp;Use<br/>
&nbsp;&nbsp;<span class="inlinecode"><span class="id" title="var">t_update</span></span>&nbsp;and&nbsp;<span class="inlinecode">(<span class="id" title="var">t_empty</span></span> <span class="inlinecode"><span class="id" title="var">default</span>)</span>.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="example_map"><span class="id" title="definition">example_map</span></a> (<span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>: <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) : <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;将本行替换成&nbsp;":=&nbsp;_你的_定义_&nbsp;."&nbsp;*)</span>. <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 To build the <span class="inlinecode"><span class="id" title="var">Abs</span></span> relation, we'll use these two auxiliary
     functions that construct maps: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="combine"><span class="id" title="definition">combine</span></a> {<span class="id" title="var">A</span>} (<span class="id" title="var">pivot</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">m<sub>1</sub></span> <span class="id" title="var">m<sub>2</sub></span>: <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#A"><span class="id" title="variable">A</span></a>) : <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#A"><span class="id" title="variable">A</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="SearchTree.html#pivot"><span class="id" title="variable">pivot</span></a>  <span class="id" title="keyword">then</span> <a class="idref" href="SearchTree.html#m<sub>1</sub>"><span class="id" title="variable">m<sub>1</sub></span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">else</span> <a class="idref" href="SearchTree.html#m<sub>2</sub>"><span class="id" title="variable">m<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#x"><span class="id" title="variable">x</span></a>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">combine</span></span> <span class="inlinecode"><span class="id" title="var">pivot</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span> <span class="inlinecode"><span class="id" title="var">b</span></span> uses the map <span class="inlinecode"><span class="id" title="var">a</span></span> on any input less than
   <span class="inlinecode"><span class="id" title="var">pivot</span></span>, and uses map <span class="inlinecode"><span class="id" title="var">b</span></span> on any input <span class="inlinecode"></span> <span class="inlinecode">≥</span> <span class="inlinecode"><span class="id" title="var">pivot</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <a name="Abs"><span class="id" title="inductive">Abs</span></a>:  <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a name="Abs_E"><span class="id" title="constructor">Abs_E</span></a>: <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>)<br/>
| <a name="Abs_T"><span class="id" title="constructor">Abs_T</span></a>: <span class="id" title="keyword">∀</span> <span class="id" title="var">a</span> <span class="id" title="var">b</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="SearchTree.html#a"><span class="id" title="variable">a</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="SearchTree.html#b"><span class="id" title="variable">b</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#r"><span class="id" title="variable">r</span></a>)  (<span class="id" title="definition">t_update</span> (<a class="idref" href="SearchTree.html#combine"><span class="id" title="definition">combine</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#a"><span class="id" title="variable">a</span></a> <a class="idref" href="SearchTree.html#b"><span class="id" title="variable">b</span></a>) <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a>).<br/>
</div>

<div class="doc">
<a name="lab68"></a><h4 class="section">练习：3 星, standard (check_example_map)</h4>
 Prove that your <span class="inlinecode"><span class="id" title="var">example_map</span></span> is the right one.
     If it isn't, go back and fix your definition of <span class="inlinecode"><span class="id" title="var">example_map</span></span>.
     You will probably need the <span class="inlinecode"><span class="id" title="var">bdestruct</span></span> tactic, and <span class="inlinecode"><span class="id" title="tactic">omega</span></span>. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Lemma</span> <a name="check_example_map"><span class="id" title="lemma">check_example_map</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>, <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> (<a class="idref" href="SearchTree.html#example_tree"><span class="id" title="definition">example_tree</span></a> <a class="idref" href="SearchTree.html#v<sub>2</sub>"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#v<sub>4</sub>"><span class="id" title="variable">v<sub>4</sub></span></a> <a class="idref" href="SearchTree.html#v<sub>5</sub>"><span class="id" title="variable">v<sub>5</sub></span></a>) (<a class="idref" href="SearchTree.html#example_map"><span class="id" title="axiom">example_map</span></a> <a class="idref" href="SearchTree.html#v<sub>2</sub>"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#v<sub>4</sub>"><span class="id" title="variable">v<sub>4</sub></span></a> <a class="idref" href="SearchTree.html#v<sub>5</sub>"><span class="id" title="variable">v<sub>5</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#example_tree"><span class="id" title="definition">example_tree</span></a>.<br/>
<span class="id" title="tactic">evar</span> (<span class="id" title="var">m</span>: <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>).<br/>
<span class="id" title="tactic">replace</span> (<a class="idref" href="SearchTree.html#example_map"><span class="id" title="axiom">example_map</span></a> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>) <span class="id" title="keyword">with</span> <span class="id" title="var">m</span>; <span class="id" title="tactic">subst</span> <span class="id" title="var">m</span>.<br/>
<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">constructor</span>.<br/>
<span class="id" title="tactic">extensionality</span> <span class="id" title="var">x</span>.<br/>
<span class="comment">(*&nbsp;HINT:<br/>
&nbsp;&nbsp;First,&nbsp;&nbsp;&nbsp;&nbsp;<span class="inlinecode"><span class="id" title="tactic">unfold</span></span> <span class="inlinecode"><span class="id" title="var">example_map</span>,</span> <span class="inlinecode"><span class="id" title="var">t_update</span>,</span> <span class="inlinecode"><span class="id" title="var">combine</span>,</span> <span class="inlinecode"><span class="id" title="var">t_empty</span>,</span> <span class="inlinecode"><span class="id" title="var">eqb_id</span>.</span><br/>
&nbsp;&nbsp;Then,&nbsp;repeat&nbsp;the&nbsp;following&nbsp;procedure:&nbsp;&nbsp;If&nbsp;you&nbsp;see&nbsp;something&nbsp;like<br/>
&nbsp;&nbsp;<span class="inlinecode"><span class="id" title="keyword">if</span></span> <span class="inlinecode">4</span> <span class="inlinecode">=?</span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="keyword">then</span></span> <span class="inlinecode">...</span> <span class="inlinecode"><span class="id" title="keyword">else</span></span> <span class="inlinecode">...</span>,&nbsp;&nbsp;&nbsp;&nbsp;use&nbsp;the&nbsp;tactic&nbsp;<span class="inlinecode"><span class="id" title="var">bdestruct</span></span> <span class="inlinecode">(4</span> <span class="inlinecode">=?</span> <span class="inlinecode"><span class="id" title="var">x</span>)</span>.<br/>
&nbsp;&nbsp;If&nbsp;the&nbsp;arithmetic&nbsp;facts&nbsp;above&nbsp;the&nbsp;line&nbsp;can't&nbsp;all&nbsp;be&nbsp;true,&nbsp;use&nbsp;<span class="inlinecode"><span class="id" title="tactic">omega</span></span>.<br/>
&nbsp;&nbsp;If&nbsp;you're&nbsp;too&nbsp;lazy&nbsp;to&nbsp;check&nbsp;for&nbsp;yourself&nbsp;whether&nbsp;they&nbsp;are&nbsp;true,<br/>
&nbsp;&nbsp;&nbsp;use&nbsp;<span class="inlinecode"><span class="id" title="var">bdestruct</span></span> <span class="inlinecode">(4</span> <span class="inlinecode">=?</span> <span class="inlinecode"><span class="id" title="var">x</span>);</span> <span class="inlinecode"><span class="id" title="tactic">try</span></span> <span class="inlinecode"><span class="id" title="tactic">omega</span></span>.<br/>
*)</span><br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 You can ignore this lemma, unless it fails. 
</div>
<div class="code">
<span class="id" title="keyword">Lemma</span> <a name="check_too_clever"><span class="id" title="lemma">check_too_clever</span></a>: <span class="id" title="keyword">∀</span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>: <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>, <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#True"><span class="id" title="inductive">True</span></a>.<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">evar</span> (<span class="id" title="var">m</span>: <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>).<br/>
<span class="id" title="tactic">assert</span> (<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> (<a class="idref" href="SearchTree.html#example_tree"><span class="id" title="definition">example_tree</span></a> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>) <span class="id" title="var">m</span>).<br/>
<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">constructor</span>.<br/>
(<span class="id" title="tactic">change</span> <span class="id" title="var">m</span> <span class="id" title="keyword">with</span> (<a class="idref" href="SearchTree.html#example_map"><span class="id" title="axiom">example_map</span></a> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>) <span class="id" title="tactic">in</span> <span class="id" title="var">H</span> || <span class="id" title="tactic">auto</span>);<br/>
<span class="comment">(*&nbsp;auto;&nbsp;*)</span><br/>
<span class="id" title="tactic">fail</span> "Did you use copy-and-paste, from your check_example_map proof,
       into your example_map definition?  If so, very clever.
       Please try it again with an example_map definition that
       you make up from first principles.  Or, to skip that,
       uncomment the (* auto; *) above.".<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Theorem</span> <a name="empty_tree_relate"><span class="id" title="lemma">empty_tree_relate</span></a>: <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">constructor</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab69"></a><h4 class="section">练习：3 星, standard (lookup_relate)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="lookup_relate"><span class="id" title="lemma">lookup_relate</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a>  <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab70"></a><h4 class="section">练习：4 星, standard (insert_relate)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="insert_relate"><span class="id" title="lemma">insert_relate</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) (<span class="id" title="definition">t_update</span> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab71"></a><h1 class="section">Correctness Proof of the <span class="inlinecode"><span class="id" title="var">elements</span></span> Function</h1>

<div class="paragraph"> </div>

 How should we specify what <span class="inlinecode"><span class="id" title="var">elements</span></span> is supposed to do?
     Well, <span class="inlinecode"><span class="id" title="var">elements</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> returns a list of pairs
     <span class="inlinecode">(<span class="id" title="var">k<sub>1</sub></span>,<span class="id" title="var">v<sub>1</sub></span>);(<span class="id" title="var">k<sub>2</sub></span>;<span class="id" title="var">v<sub>2</sub></span>);...;(<span class="id" title="var">kn</span>,<span class="id" title="var">vn</span>)</span> that ought to correspond to
     the total_map, <span class="inlinecode"><span class="id" title="var">t_update</span></span> <span class="inlinecode">...</span> <span class="inlinecode">(<span class="id" title="var">t_update</span></span> <span class="inlinecode">(<span class="id" title="var">t_update</span></span> <span class="inlinecode">(<span class="id" title="var">t_empty</span></span> <span class="inlinecode"><span class="id" title="var">default</span>)</span>
                     <span class="inlinecode">(<span class="id" title="var">Id</span></span> <span class="inlinecode"><span class="id" title="var">k<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span>)</span> <span class="inlinecode">(<span class="id" title="var">Id</span></span> <span class="inlinecode"><span class="id" title="var">k<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span> <span class="inlinecode">...</span> <span class="inlinecode">(<span class="id" title="var">Id</span></span> <span class="inlinecode"><span class="id" title="var">kn</span>)</span> <span class="inlinecode"><span class="id" title="var">vn</span></span>.

<div class="paragraph"> </div>

    We can formalize this quite easily.  
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="list2map"><span class="id" title="definition">list2map</span></a> (<span class="id" title="var">el</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>)) : <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#el"><span class="id" title="variable">el</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a><br/>
&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">i</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#0a8150c3c4df34d205c5ed9a427e2ed<sub>5</sub>"><span class="id" title="notation">::</span></a><span class="id" title="var">el'</span> ⇒ <span class="id" title="definition">t_update</span> (<a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> <span class="id" title="var">el'</span>) <span class="id" title="var">i</span> <span class="id" title="var">v</span><br/>
&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a name="lab72"></a><h4 class="section">练习：3 星, standard (elements_relate_informal)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="elements_relate"><span class="id" title="lemma">elements_relate</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,  <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
</div>

<div class="doc">
Don't prove this yet.  Instead, explain in your own words, with
   examples, why this must be true.  It's OK if your explanation is
   not a formal proof; it's even OK if your explanation is subtly
   wrong!  Just make it convincing. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;YOUR&nbsp;EXPLANATION&nbsp;HERE&nbsp;*)</span><br/>
<span class="id" title="keyword">Abort</span>.<br/>
<span class="comment">(*&nbsp;请勿修改下面这一行：&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a name="manual_grade_for_elements_relate_informal"><span class="id" title="definition">manual_grade_for_elements_relate_informal</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Strings.String.html#string"><span class="id" title="inductive">string</span></a>) := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Instead of doing a <i>formal</i> proof that <span class="inlinecode"><span class="id" title="var">elements_relate</span></span> is true,
    prove that it's false!  That is, as long as type <span class="inlinecode"><span class="id" title="var">V</span></span> contains at
    least two distinct values. 
<div class="paragraph"> </div>

<a name="lab73"></a><h4 class="section">练习：4 星, standard (not_elements_relate)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="not_elements_relate"><span class="id" title="lemma">not_elements_relate</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">v</span>, <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#32263a1c8b01baecdff9deb038955bc<sub>9</sub>"><span class="id" title="notation">≠</span></a> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">¬</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,  <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">)</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">intro</span>.<br/>
<span class="id" title="tactic">pose</span> (<span class="id" title="var">bogus</span> := <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 3 <span class="id" title="var">v</span> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 2 <span class="id" title="var">v</span> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>).<br/>
<span class="id" title="tactic">pose</span> (<span class="id" title="var">m</span> := <span class="id" title="definition">t_update</span> (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>) 2 <span class="id" title="var">v</span>).<br/>
<span class="id" title="tactic">pose</span> (<span class="id" title="var">m'</span> := <span class="id" title="definition">t_update</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="SearchTree.html#combine"><span class="id" title="definition">combine</span></a> 2<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="definition">t_update</span> (<a class="idref" href="SearchTree.html#combine"><span class="id" title="definition">combine</span></a> 3 (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>) (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>)) 3 <span class="id" title="var">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>)) 2 <span class="id" title="var">v</span>).<br/>
<span class="id" title="tactic">assert</span> (<span class="id" title="var">Paradox</span>: <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <span class="id" title="var">bogus</span>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">m</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d82a7d96d3659d805ffe732283716822"><span class="id" title="notation">∧</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <span class="id" title="var">bogus</span>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#32263a1c8b01baecdff9deb038955bc<sub>9</sub>"><span class="id" title="notation">≠</span></a> <span class="id" title="var">m</span>).<br/>
<span class="id" title="tactic">split</span>.<br/>
</div>

<div class="doc">
To prove the first subgoal, prove that <span class="inlinecode"><span class="id" title="var">m</span>=<span class="id" title="var">m'</span></span> (by <span class="inlinecode"><span class="id" title="tactic">extensionality</span></span>) and
      then use <span class="inlinecode"><span class="id" title="var">H</span></span>.

<div class="paragraph"> </div>

     To prove the second subgoal, do an <span class="inlinecode"><span class="id" title="tactic">intro</span></span> so that you can assume
      <span class="inlinecode"><span class="id" title="var">update_list</span></span> <span class="inlinecode">(<span class="id" title="var">t_empty</span></span> <span class="inlinecode"><span class="id" title="var">default</span>)</span> <span class="inlinecode">(<span class="id" title="var">elements</span></span> <span class="inlinecode"><span class="id" title="var">bogus</span>)</span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">m</span></span>, then show that
      <span class="inlinecode"><span class="id" title="var">update_list</span></span> <span class="inlinecode">(<span class="id" title="var">t_empty</span></span> <span class="inlinecode"><span class="id" title="var">default</span>)</span> <span class="inlinecode">(<span class="id" title="var">elements</span></span> <span class="inlinecode"><span class="id" title="var">bogus</span>)</span> <span class="inlinecode">(<span class="id" title="var">Id</span></span> <span class="inlinecode">3)</span> <span class="inlinecode">≠</span> <span class="inlinecode"><span class="id" title="var">m</span></span> <span class="inlinecode">(<span class="id" title="var">Id</span></span> <span class="inlinecode">3)</span>.
      That's a contradiction.

<div class="paragraph"> </div>

      To prove the third subgoal, just destruct <span class="inlinecode"><span class="id" title="var">Paradox</span></span> and use the
      contradiction.

<div class="paragraph"> </div>

      In all 3 goals, when you need to unfold local definitions such
      as <span class="inlinecode"><span class="id" title="var">bogus</span></span> you can use <span class="inlinecode"><span class="id" title="tactic">unfold</span></span> <span class="inlinecode"><span class="id" title="var">bogus</span></span> or <span class="inlinecode"><span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">bogus</span></span>.  
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 What went wrong?  Clearly, <span class="inlinecode"><span class="id" title="var">elements_relate</span></span> is true; you just
    explained why.  And clearly, it's not true, because
    <span class="inlinecode"><span class="id" title="var">not_elements_relate</span></span> is provable in Coq.  The problem is that the
    tree <span class="inlinecode">(<span class="id" title="var">T</span></span> <span class="inlinecode">(<span class="id" title="var">T</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">3</span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode">2</span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> is bogus: it's not a well-formed
    binary search tree, because there's a 3 in the left subtree of the
    2 node, and 3 is not less than 2.

<div class="paragraph"> </div>

    If you wrote a good answer to the <span class="inlinecode"><span class="id" title="var">elements_relate_informal</span></span>
    exercise, (that is, an answer that is only subtly wrong), then the
    subtlety is that you assumed that the search tree is well formed.
    That's a reasonable assumption; but we will have to prove that all
    the trees we operate on will be well formed.  
<div class="paragraph"> </div>

<a name="lab74"></a><h1 class="section">Representation Invariants</h1>

<div class="paragraph"> </div>

 A <span class="inlinecode"><span class="id" title="var">tree</span></span> has the <span class="inlinecode"><span class="id" title="var">SearchTree</span></span> property if, at any node with key
     <span class="inlinecode"><span class="id" title="var">k</span></span>, all the keys in the left subtree are less than <span class="inlinecode"><span class="id" title="var">k</span></span>, and all
     the keys in the right subtree are greater than <span class="inlinecode"><span class="id" title="var">k</span></span>.  It's not
     completely obvious how to formalize that!  Here's one way: it's
     correct, but not very practical. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="forall_nodes"><span class="id" title="definition">forall_nodes</span></a> (<span class="id" title="var">t</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">P</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><span class="id" title="keyword">Prop</span>) : <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;| <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#True"><span class="id" title="inductive">True</span></a><br/>
&nbsp;| <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> ⇒ <a class="idref" href="SearchTree.html#P"><span class="id" title="variable">P</span></a> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d82a7d96d3659d805ffe732283716822"><span class="id" title="notation">∧</span></a> <a class="idref" href="SearchTree.html#forall_nodes"><span class="id" title="definition">forall_nodes</span></a> <span class="id" title="var">l</span> <a class="idref" href="SearchTree.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d82a7d96d3659d805ffe732283716822"><span class="id" title="notation">∧</span></a> <a class="idref" href="SearchTree.html#forall_nodes"><span class="id" title="definition">forall_nodes</span></a> <span class="id" title="var">r</span> <a class="idref" href="SearchTree.html#P"><span class="id" title="variable">P</span></a><br/>
&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a name="SearchTreeX"><span class="id" title="definition">SearchTreeX</span></a> (<span class="id" title="var">t</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) :=<br/>
&nbsp;<a class="idref" href="SearchTree.html#forall_nodes"><span class="id" title="definition">forall_nodes</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a><br/>
&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#forall_nodes"><span class="id" title="definition">forall_nodes</span></a> <a class="idref" href="SearchTree.html#l"><span class="id" title="variable">l</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">j</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="SearchTree.html#j"><span class="id" title="variable">j</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#989c98e7ddd65d5bf37c334ff2076de<sub>8</sub>"><span class="id" title="notation">&lt;</span></a><a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d82a7d96d3659d805ffe732283716822"><span class="id" title="notation">∧</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#forall_nodes"><span class="id" title="definition">forall_nodes</span></a> <a class="idref" href="SearchTree.html#r"><span class="id" title="variable">r</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">j</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="SearchTree.html#j"><span class="id" title="variable">j</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#19ab5cfd7e4f60fa14f22b576013bd<sub>96</sub>"><span class="id" title="notation">&gt;</span></a><a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>)).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a name="example_SearchTree_good"><span class="id" title="lemma">example_SearchTree_good</span></a>:<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>4</sub></span> <span class="id" title="var">v<sub>5</sub></span>, <a class="idref" href="SearchTree.html#SearchTreeX"><span class="id" title="definition">SearchTreeX</span></a> (<a class="idref" href="SearchTree.html#example_tree"><span class="id" title="definition">example_tree</span></a> <a class="idref" href="SearchTree.html#v<sub>2</sub>"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#v<sub>4</sub>"><span class="id" title="variable">v<sub>4</sub></span></a> <a class="idref" href="SearchTree.html#v<sub>5</sub>"><span class="id" title="variable">v<sub>5</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">hnf</span>. <span class="id" title="tactic">simpl</span>.<br/>
<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a name="example_SearchTree_bad"><span class="id" title="lemma">example_SearchTree_bad</span></a>:<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">v</span>, <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">¬</span></a><a class="idref" href="SearchTree.html#SearchTreeX"><span class="id" title="definition">SearchTreeX</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 3 <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 2 <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">intro</span>.<br/>
<span class="id" title="tactic">hnf</span> <span class="id" title="tactic">in</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">do</span> 3 <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">omega</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Theorem</span> <a name="elements_relate_second_attempt"><span class="id" title="lemma">elements_relate_second_attempt</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTreeX"><span class="id" title="definition">SearchTreeX</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
</div>

<div class="doc">
This is probably provable.  But the <span class="inlinecode"><span class="id" title="var">SearchTreeX</span></span> property is
   quite unwieldy, with its two Fixpoints nested inside a Fixpoint.
   Instead of using <span class="inlinecode"><span class="id" title="var">SearchTreeX</span></span>, let's reformulate the searchtree
   property as an inductive proposition without any nested
   induction. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Abort</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a name="SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> : <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a name="ST_E"><span class="id" title="constructor">ST_E</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">lo</span> <span class="id" title="var">hi</span>, <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#9b077c369e19739ef880736ba34623ff"><span class="id" title="notation">≤</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a><br/>
| <a name="ST_T"><span class="id" title="constructor">ST_T</span></a>: <span class="id" title="keyword">∀</span> <span class="id" title="var">lo</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> <span class="id" title="var">hi</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="SearchTree.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>) <a class="idref" href="SearchTree.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#r"><span class="id" title="variable">r</span></a>) <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a name="SearchTree"><span class="id" title="inductive">SearchTree</span></a>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a name="ST_intro"><span class="id" title="constructor">ST_intro</span></a>: <span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">hi</span>, <a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> 0 <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a name="SearchTree'_le"><span class="id" title="lemma">SearchTree'_le</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">lo</span> <span class="id" title="var">t</span> <span class="id" title="var">hi</span>, @<a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#9b077c369e19739ef880736ba34623ff"><span class="id" title="notation">≤</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">induction</span> 1; <span class="id" title="tactic">omega</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Before we prove that <span class="inlinecode"><span class="id" title="var">elements</span></span> is correct, let's consider a simpler version. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Fixpoint</span> <a name="slow_elements"><span class="id" title="definition">slow_elements</span></a> (<span class="id" title="var">s</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="SearchTree.html#s"><span class="id" title="variable">s</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;| <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a><br/>
&nbsp;| <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">a</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">b</span> ⇒ <a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a> <span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><span class="id" title="var">k</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#64ee52ab9627fca8d637e2f1207a2990"><span class="id" title="notation">]</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a> <span class="id" title="var">b</span><br/>
&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
This one is easier to understand than the <span class="inlinecode"><span class="id" title="var">elements</span></span> function,
    because it doesn't carry the <span class="inlinecode"><span class="id" title="var">base</span></span> list around in its recursion.
    Unfortunately, its running time is NlogN, because at each of
    the <span class="inlinecode"><span class="id" title="var">T</span></span> nodes it does a linear-time list-concatentation.  The
    original <span class="inlinecode"><span class="id" title="var">elements</span></span> function takes linear time overall; that's
    much more efficient.

<div class="paragraph"> </div>

   To prove correctness of <span class="inlinecode"><span class="id" title="var">elements</span></span>, it's actually easier to first
   prove that it's equivalent to <span class="inlinecode"><span class="id" title="var">slow_elements</span></span>, then prove the
   correctness of <span class="inlinecode"><span class="id" title="var">slow_elements</span></span>.  We don't care that <span class="inlinecode"><span class="id" title="var">slow_elements</span></span>
   is a bit slow, because we're never going to really run it; it's just
   there to support the proof. 
<div class="paragraph"> </div>

<a name="lab75"></a><h4 class="section">练习：3 星, standard, optional (elements_slow_elements)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="elements_slow_elements"><span class="id" title="lemma">elements_slow_elements</span></a>: <a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">extensionality</span> <span class="id" title="var">s</span>.<br/>
<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a>.<br/>
<span class="id" title="tactic">assert</span> (<span class="id" title="keyword">∀</span> <span class="id" title="var">base</span>, <a class="idref" href="SearchTree.html#elements'"><span class="id" title="definition">elements'</span></a> <span class="id" title="var">s</span> <a class="idref" href="SearchTree.html#base"><span class="id" title="variable">base</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a> <span class="id" title="var">s</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a> <a class="idref" href="SearchTree.html#base"><span class="id" title="variable">base</span></a>).<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab76"></a><h4 class="section">练习：3 星, standard, optional (slow_elements_range)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Lemma</span> <a name="slow_elements_range"><span class="id" title="lemma">slow_elements_range</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">lo</span> <span class="id" title="var">t</span> <span class="id" title="var">hi</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree'"><span class="id" title="inductive">SearchTree'</span></a> <a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#In"><span class="id" title="definition">In</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> (<a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#lo"><span class="id" title="variable">lo</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#a37ed901e2f16b7d06c569763fc8034f"><span class="id" title="notation">≤</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#a37ed901e2f16b7d06c569763fc8034f"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="SearchTree.html#hi"><span class="id" title="variable">hi</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab77"></a><h2 class="section">Auxiliary Lemmas About <span class="inlinecode"><span class="id" title="var">In</span></span> and <span class="inlinecode"><span class="id" title="var">list2map</span></span></h2>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Lemma</span> <a name="In_decidable"><span class="id" title="lemma">In_decidable</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">al</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>)) (<span class="id" title="var">i</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#7a45dffb109c3069e5c675be68643e<sub>60</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">∃</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#In"><span class="id" title="definition">In</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#7a45dffb109c3069e5c675be68643e<sub>60</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#7a45dffb109c3069e5c675be68643e<sub>60</sub>"><span class="id" title="notation">∨</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#7a45dffb109c3069e5c675be68643e<sub>60</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">¬</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">∃</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#In"><span class="id" title="definition">In</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#7a45dffb109c3069e5c675be68643e<sub>60</sub>"><span class="id" title="notation">)</span></a>.<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">induction</span> <span class="id" title="var">al</span> <span class="id" title="keyword">as</span> [ | [<span class="id" title="var">k</span> <span class="id" title="var">v</span>]].<br/>
<span class="id" title="tactic">right</span>; <span class="id" title="tactic">intros</span> [<span class="id" title="var">w</span> <span class="id" title="var">H</span>]; <span class="id" title="var">inv</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">destruct</span> <span class="id" title="var">IHal</span> <span class="id" title="keyword">as</span> [[<span class="id" title="var">w</span> <span class="id" title="var">H</span>] | <span class="id" title="var">H</span>].<br/>
<span class="id" title="tactic">left</span>; <span class="id" title="tactic">∃</span> <span class="id" title="var">w</span>; <span class="id" title="tactic">right</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">k</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a> <span class="id" title="var">i</span>).<br/>
<span class="id" title="tactic">subst</span> <span class="id" title="var">k</span>.<br/>
<span class="id" title="tactic">left</span>; <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="tactic">∃</span> <span class="id" title="var">v</span>; <span class="id" title="tactic">left</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">right</span>. <span class="id" title="tactic">intros</span> [<span class="id" title="var">w</span> <span class="id" title="var">H<sub>1</sub></span>].<br/>
<span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>1</sub></span>. <span class="id" title="var">inv</span> <span class="id" title="var">H<sub>1</sub></span>. <span class="id" title="tactic">omega</span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Lemma</span> <a name="list2map_app_left"><span class="id" title="lemma">list2map_app_left</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">al</span> <span class="id" title="var">bl</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>)) (<span class="id" title="var">i</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>) <span class="id" title="var">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#In"><span class="id" title="definition">In</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a><a class="idref" href="SearchTree.html#bl"><span class="id" title="variable">bl</span></a>) <a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a> <a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a>.<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="var">revert</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">induction</span> <span class="id" title="var">al</span> <span class="id" title="keyword">as</span> [| [<span class="id" title="var">j</span> <span class="id" title="var">w</span>] <span class="id" title="var">al</span>]; <span class="id" title="tactic">intro</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="var">inv</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span>. <span class="id" title="var">inv</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="definition">t_update</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">i</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a><span class="id" title="var">i</span>); [ | <span class="id" title="tactic">omega</span>].<br/>
<span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="definition">t_update</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">j</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a><span class="id" title="var">i</span>); <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Lemma</span> <a name="list2map_app_right"><span class="id" title="lemma">list2map_app_right</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">al</span> <span class="id" title="var">bl</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>)) (<span class="id" title="var">i</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">~(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">∃</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#In"><span class="id" title="definition">In</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#5d35a99a6abff1d64bf70538feb70e<sub>36</sub>"><span class="id" title="notation">++</span></a><a class="idref" href="SearchTree.html#bl"><span class="id" title="variable">bl</span></a>) <a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> <a class="idref" href="SearchTree.html#bl"><span class="id" title="variable">bl</span></a> <a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a>.<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="var">revert</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">induction</span> <span class="id" title="var">al</span> <span class="id" title="keyword">as</span> [| [<span class="id" title="var">j</span> <span class="id" title="var">w</span>] <span class="id" title="var">al</span>]; <span class="id" title="tactic">intro</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="definition">t_update</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">j</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a><span class="id" title="var">i</span>).<br/>
<span class="id" title="tactic">subst</span> <span class="id" title="var">j</span>.<br/>
<span class="id" title="var">contradiction</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">∃</span> <span class="id" title="var">w</span>; <span class="id" title="tactic">left</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">IHal</span>.<br/>
<span class="id" title="var">contradict</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">u</span> ?].<br/>
<span class="id" title="tactic">∃</span> <span class="id" title="var">u</span>; <span class="id" title="tactic">right</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" title="keyword">Lemma</span> <a name="list2map_not_in_default"><span class="id" title="lemma">list2map_not_in_default</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">al</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#d19c7eafd0e2d195d10df94b392087b<sub>5</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>)) (<span class="id" title="var">i</span>: <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">~(</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">∃</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#In"><span class="id" title="definition">In</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">,</span></a><a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#44400027531d4bc3f586a1997dc874c<sub>0</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> <a class="idref" href="SearchTree.html#al"><span class="id" title="variable">al</span></a> <a class="idref" href="SearchTree.html#i"><span class="id" title="variable">i</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>.<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">induction</span> <span class="id" title="var">al</span> <span class="id" title="keyword">as</span> [| [<span class="id" title="var">j</span> <span class="id" title="var">w</span>] <span class="id" title="var">al</span>].<br/>
<span class="id" title="tactic">reflexivity</span>.<br/>
<span class="id" title="tactic">simpl</span>.<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="definition">t_update</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">j</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a><span class="id" title="var">i</span>).<br/>
<span class="id" title="tactic">subst</span>.<br/>
<span class="id" title="var">contradiction</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">∃</span> <span class="id" title="var">w</span>; <span class="id" title="tactic">left</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">IHal</span>.<br/>
<span class="id" title="tactic">intros</span> [<span class="id" title="var">v</span> ?].<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">∃</span> <span class="id" title="var">v</span>; <span class="id" title="tactic">right</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab78"></a><h4 class="section">练习：3 星, standard, optional (elements_relate)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="elements_relate"><span class="id" title="lemma">elements_relate</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">rewrite</span> <a class="idref" href="SearchTree.html#elements_slow_elements"><span class="id" title="axiom">elements_slow_elements</span></a>.<br/>
<span class="id" title="tactic">intros</span> <span class="id" title="tactic">until</span> 1. <span class="id" title="var">inv</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="var">revert</span> <span class="id" title="var">cts</span>; <span class="id" title="tactic">induction</span> <span class="id" title="var">H<sub>0</sub></span>; <span class="id" title="tactic">intros</span>.<br/>
× <span class="comment">(*&nbsp;ST_E&nbsp;case&nbsp;*)</span><br/>
<span class="id" title="var">inv</span> <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="tactic">reflexivity</span>.<br/>
× <span class="comment">(*&nbsp;ST_T&nbsp;case&nbsp;*)</span><br/>
<span class="id" title="var">inv</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHSearchTree'1</span> <span class="id" title="var">_</span> <span class="id" title="var">H<sub>5</sub></span>). <span class="id" title="tactic">clear</span> <span class="id" title="var">H<sub>5</sub></span>.<br/>
<span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHSearchTree'2</span> <span class="id" title="var">_</span> <span class="id" title="var">H<sub>6</sub></span>). <span class="id" title="tactic">clear</span> <span class="id" title="var">H<sub>6</sub></span>.<br/>
<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a>; <span class="id" title="tactic">fold</span> <a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a>.<br/>
<span class="id" title="tactic">subst</span>.<br/>
<span class="id" title="tactic">extensionality</span> <span class="id" title="var">i</span>.<br/>
<span class="id" title="tactic">destruct</span> (<a class="idref" href="SearchTree.html#In_decidable"><span class="id" title="lemma">In_decidable</span></a> (<a class="idref" href="SearchTree.html#slow_elements"><span class="id" title="definition">slow_elements</span></a> <span class="id" title="var">l</span>) <span class="id" title="var">i</span>)  <span class="id" title="keyword">as</span> [[<span class="id" title="var">w</span> <span class="id" title="var">H</span>] | <span class="id" title="var">Hleft</span>].<br/>
<span class="id" title="tactic">rewrite</span> <a class="idref" href="SearchTree.html#list2map_app_left"><span class="id" title="lemma">list2map_app_left</span></a> <span class="id" title="keyword">with</span> (<span class="id" title="var">v</span>:=<span class="id" title="var">w</span>); <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">pose</span> <span class="id" title="var">proof</span> (<a class="idref" href="SearchTree.html#slow_elements_range"><span class="id" title="axiom">slow_elements_range</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">H0_</span> <span class="id" title="var">H</span>).<br/>
<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#combine"><span class="id" title="definition">combine</span></a>, <span class="id" title="definition">t_update</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">k</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a><span class="id" title="var">i</span>); [ <span class="id" title="tactic">omega</span> | ].<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">i</span><a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a><span class="id" title="var">k</span>); [ | <span class="id" title="tactic">omega</span>].<br/>
<span class="id" title="tactic">auto</span>.<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab79"></a><h1 class="section">Preservation of Representation Invariant</h1>

<div class="paragraph"> </div>

 How do we know that all the trees we will encounter (particularly,
  that the <span class="inlinecode"><span class="id" title="var">elements</span></span> function will encounter), have the <span class="inlinecode"><span class="id" title="var">SearchTree</span></span>
  property?  Well, the empty tree is a <span class="inlinecode"><span class="id" title="var">SearchTree</span></span>; and if you insert
  into a tree that's a <span class="inlinecode"><span class="id" title="var">SearchTree</span></span>, then the result is a
  <span class="inlinecode"><span class="id" title="var">SearchTree</span></span>; and these are the only ways that you're supposed to
  build trees.  So we need to prove those two theorems. 
<div class="paragraph"> </div>

<a name="lab80"></a><h4 class="section">练习：1 星, standard (empty_tree_SearchTree)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="empty_tree_SearchTree"><span class="id" title="lemma">empty_tree_SearchTree</span></a>:  <a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#empty_tree"><span class="id" title="definition">empty_tree</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">clear</span> <span class="id" title="var">default</span>. <span class="comment">(*&nbsp;This&nbsp;is&nbsp;here&nbsp;to&nbsp;avoid&nbsp;a&nbsp;nasty&nbsp;interaction&nbsp;between&nbsp;Admitted<br/>
&nbsp;&nbsp;&nbsp;and&nbsp;Section/Variable.&nbsp;&nbsp;It's&nbsp;also&nbsp;a&nbsp;hint&nbsp;that&nbsp;the&nbsp;<span class="inlinecode"><span class="id" title="var">default</span></span>&nbsp;value<br/>
&nbsp;&nbsp;&nbsp;is&nbsp;not&nbsp;needed&nbsp;in&nbsp;this&nbsp;theorem.&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab81"></a><h4 class="section">练习：3 星, standard (insert_SearchTree)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="insert_SearchTree"><span class="id" title="lemma">insert_SearchTree</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">clear</span> <span class="id" title="var">default</span>. <span class="comment">(*&nbsp;This&nbsp;is&nbsp;here&nbsp;to&nbsp;avoid&nbsp;a&nbsp;nasty&nbsp;interaction&nbsp;between&nbsp;Admitted&nbsp;and&nbsp;Section/Variable&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab82"></a><h1 class="section">We Got Lucky</h1>

<div class="paragraph"> </div>

 Recall the statement of <span class="inlinecode"><span class="id" title="var">lookup_relate</span></span>: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Check</span> <a class="idref" href="SearchTree.html#lookup_relate"><span class="id" title="axiom">lookup_relate</span></a>.<br/>
<span class="comment">(*&nbsp;&nbsp;forall&nbsp;(k&nbsp;:&nbsp;key)&nbsp;(t&nbsp;:&nbsp;tree)&nbsp;(cts&nbsp;:&nbsp;total_map&nbsp;V),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abs&nbsp;t&nbsp;cts&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;lookup&nbsp;k&nbsp;t&nbsp;=&nbsp;cts&nbsp;(Id&nbsp;k)&nbsp;&nbsp;*)</span><br/>
</div>

<div class="doc">
In general, to prove that a function satisfies the abstraction relation,
   one also needs to use the representation invariant.  That was certainly
   the case with <span class="inlinecode"><span class="id" title="var">elements_relate</span></span>: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Check</span> <a class="idref" href="SearchTree.html#elements_relate"><span class="id" title="axiom">elements_relate</span></a>.<br/>
<span class="comment">(*&nbsp;&nbsp;:&nbsp;forall&nbsp;(t&nbsp;:&nbsp;tree)&nbsp;(cts&nbsp;:&nbsp;total_map&nbsp;V),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SearchTree&nbsp;t&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;Abs&nbsp;t&nbsp;cts&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;elements_property&nbsp;t&nbsp;cts&nbsp;&nbsp;&nbsp;*)</span><br/>
</div>

<div class="doc">
To put that another way, the general form of <span class="inlinecode"><span class="id" title="var">lookup_relate</span></span> should be: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Lemma</span> <a name="lookup_relate'"><span class="id" title="lemma">lookup_relate'</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">k</span> : <a class="idref" href="SearchTree.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">cts</span> : <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>.<br/>
</div>

<div class="doc">
That is certainly provable, since it's a weaker statement than what we proved: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">apply</span> <a class="idref" href="SearchTree.html#lookup_relate"><span class="id" title="axiom">lookup_relate</span></a>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Theorem</span> <a name="insert_relate'"><span class="id" title="lemma">insert_relate'</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> (<a class="idref" href="SearchTree.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) (<span class="id" title="definition">t_update</span> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a>).<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">apply</span> <a class="idref" href="SearchTree.html#insert_relate"><span class="id" title="axiom">insert_relate</span></a>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The question is, why did we not need the representation invariant in
   the proof of <span class="inlinecode"><span class="id" title="var">lookup_relate</span></span>?  The answer is that our particular Abs
   relation is much more clever than necessary:  
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Print</span> <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a>.<br/>
<span class="comment">(*&nbsp;Inductive&nbsp;Abs&nbsp;:&nbsp;tree&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;total_map&nbsp;V&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;Prop&nbsp;:=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Abs_E&nbsp;:&nbsp;Abs&nbsp;E&nbsp;(t_empty&nbsp;default)<br/>
&nbsp;&nbsp;|&nbsp;Abs_T&nbsp;:&nbsp;forall&nbsp;(a&nbsp;b:&nbsp;total_map&nbsp;V)&nbsp;(l:&nbsp;tree)&nbsp;(k:&nbsp;key)&nbsp;(v:&nbsp;V)&nbsp;(r:&nbsp;tree),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abs&nbsp;l&nbsp;a&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abs&nbsp;r&nbsp;b&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Abs&nbsp;(T&nbsp;l&nbsp;k&nbsp;v&nbsp;r)&nbsp;(t_update&nbsp;(combine&nbsp;k&nbsp;a&nbsp;b)&nbsp;(Id&nbsp;k)&nbsp;v)<br/>
*)</span><br/>
</div>

<div class="doc">
Because the <span class="inlinecode"><span class="id" title="var">combine</span></span> function is chosen very carefully, it turns out
  that this abstraction relation even works on bogus trees! 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Remark</span> <a name="abstraction_of_bogus_tree"><span class="id" title="lemma">abstraction_of_bogus_tree</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">v<sub>3</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 3 <a class="idref" href="SearchTree.html#v<sub>3</sub>"><span class="id" title="variable">v<sub>3</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 2 <a class="idref" href="SearchTree.html#v<sub>2</sub>"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) (<span class="id" title="definition">t_update</span> (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>) 2 <a class="idref" href="SearchTree.html#v<sub>2</sub>"><span class="id" title="variable">v<sub>2</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">evar</span> (<span class="id" title="var">m</span>: <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>).<br/>
<span class="id" title="tactic">replace</span>  (<span class="id" title="definition">t_update</span> (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>) 2 <span class="id" title="var">v<sub>2</sub></span>) <span class="id" title="keyword">with</span> <span class="id" title="var">m</span>; <span class="id" title="tactic">subst</span> <span class="id" title="var">m</span>.<br/>
<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">constructor</span>.<br/>
<span class="id" title="tactic">extensionality</span> <span class="id" title="var">x</span>.<br/>
<span class="id" title="tactic">unfold</span> <span class="id" title="definition">t_update</span>, <a class="idref" href="SearchTree.html#combine"><span class="id" title="definition">combine</span></a>, <span class="id" title="definition">t_empty</span>.<br/>
<span class="id" title="var">bdestruct</span> (2 <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a> <span class="id" title="var">x</span>).<br/>
<span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">x</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> 2).<br/>
<span class="id" title="var">bdestruct</span> (3 <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#97a8d8c92e88d1d68fb55a13a4fcfc6d"><span class="id" title="notation">=?</span></a> <span class="id" title="var">x</span>).<br/>
<span class="comment">(*&nbsp;LOOK&nbsp;HERE!&nbsp;*)</span><br/>
<span class="id" title="tactic">omega</span>.<br/>
<span class="id" title="var">bdestruct</span> (<span class="id" title="var">x</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Arith.PeanoNat.html#558f8b76d149cdb311ec341fe9014aa<sub>8</sub>"><span class="id" title="notation">&lt;?</span></a> 3).<br/>
<span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Step through the proof to <span class="inlinecode"><span class="id" title="var">LOOK</span></span> <span class="inlinecode"><span class="id" title="var">HERE</span></span>, and notice what's going on.
   Just when it seems that <span class="inlinecode">(<span class="id" title="var">T</span></span> <span class="inlinecode">(<span class="id" title="var">T</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">3</span> <span class="inlinecode"><span class="id" title="var">v<sub>3</sub></span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode">2</span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> is about to produce <span class="inlinecode"><span class="id" title="var">v<sub>3</sub></span></span>
  while <span class="inlinecode">(<span class="id" title="var">t_update</span></span> <span class="inlinecode">(<span class="id" title="var">t_empty</span></span> <span class="inlinecode"><span class="id" title="var">default</span>)</span> <span class="inlinecode">(<span class="id" title="var">Id</span></span> <span class="inlinecode">2)</span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span> is about to produce <span class="inlinecode"><span class="id" title="var">default</span></span>,
  <span class="inlinecode"><span class="id" title="tactic">omega</span></span> finds a contradiction.  What's happening is that <span class="inlinecode"><span class="id" title="var">combine</span></span> <span class="inlinecode">2</span>
  is careful to ignore any keys &gt;= 2 in the left-hand subtree.

<div class="paragraph"> </div>

  For that reason, <span class="inlinecode"><span class="id" title="var">Abs</span></span> matches the <i>actual</i> behavior of <span class="inlinecode"><span class="id" title="var">lookup</span></span>,
  even on bogus trees.  But that's a really strong condition!  We should
  not have to care about the behavior of <span class="inlinecode"><span class="id" title="var">lookup</span></span> (and <span class="inlinecode"><span class="id" title="var">insert</span></span>) on
  bogus trees.  We should not need to prove anything about it, either.

<div class="paragraph"> </div>

  Sure, it's convenient in this case that the abstraction relation is able to
  cope with ill-formed trees.  But in general, when proving correctness of
  abstract-data-type (ADT) implementations, it may be a lot of extra
  effort to make the abstraction relation as heavy-duty as that.
  It's often much easier for the abstraction relation to assume that the
  representation is well formed.  Thus, the general statement of our
  correctness theorems will be more like <span class="inlinecode"><span class="id" title="var">lookup_relate'</span></span> than like
  <span class="inlinecode"><span class="id" title="var">lookup_relate</span></span>.  
<div class="paragraph"> </div>

<a name="lab83"></a><h1 class="section">Every Well-Formed Tree Does Actually Relate to an Abstraction</h1>

<div class="paragraph"> </div>

 We're not quite done yet.  We would like to know that
    <i>every tree that satisfies the representation invariant, means something</i>.

<div class="paragraph"> </div>

   So as a general sanity check, we need the following theorem: 
<div class="paragraph"> </div>

<a name="lab84"></a><h4 class="section">练习：2 星, standard (can_relate)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Lemma</span> <a name="can_relate"><span class="id" title="lemma">can_relate</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">t</span>,  <a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">∃</span></a> <span class="id" title="var">cts</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Now, because we happen to have a super-strong abstraction relation, that
   even works on bogus trees, we can prove a super-strong can_relate function: 
<div class="paragraph"> </div>

<a name="lab85"></a><h4 class="section">练习：2 星, standard (unrealistically_strong_can_relate)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Lemma</span> <a name="unrealistically_strong_can_relate"><span class="id" title="lemma">unrealistically_strong_can_relate</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">t</span>,  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">∃</span></a> <span class="id" title="var">cts</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#84eb6d2849dbf3581b1c0c05add5f2d<sub>8</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="SearchTree.html#Abs"><span class="id" title="inductive">Abs</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab86"></a><h1 class="section">It Wasn't Really Luck, Actually</h1>

<div class="paragraph"> </div>

 In the previous section, I said, "we got lucky that the abstraction
    relation that I happened to choose had this super-strong property."

<div class="paragraph"> </div>

    But actually, the first time I tried to prove correctness of search trees,
    I did <i>not</i> get lucky.  I chose a different abstraction relation: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <a name="AbsX"><span class="id" title="definition">AbsX</span></a> (<span class="id" title="var">t</span>: <a class="idref" href="SearchTree.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">m</span>: <span class="id" title="definition">total_map</span> <a class="idref" href="SearchTree.html#TREES.V"><span class="id" title="variable">V</span></a>) : <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#m"><span class="id" title="variable">m</span></a>.<br/>
</div>

<div class="doc">
It's easy to prove that <span class="inlinecode"><span class="id" title="var">elements</span></span> respects this abstraction relation: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Theorem</span> <a name="elements_relateX"><span class="id" title="lemma">elements_relateX</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span>,<br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#AbsX"><span class="id" title="definition">AbsX</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
But it's not so easy to prove that <span class="inlinecode"><span class="id" title="var">lookup</span></span> and <span class="inlinecode"><span class="id" title="var">insert</span></span> respect this
    relation.  For example, the following claim is not true. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Theorem</span> <a name="naive_lookup_relateX"><span class="id" title="lemma">naive_lookup_relateX</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#AbsX"><span class="id" title="definition">AbsX</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a>  <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>.<br/>
<span class="id" title="keyword">Abort</span>. <span class="comment">(*&nbsp;Not&nbsp;true&nbsp;*)</span><br/>
</div>

<div class="doc">
In fact, <span class="inlinecode"><span class="id" title="var">naive_lookup_relateX</span></span> is provably false,
     as long as the type <span class="inlinecode"><span class="id" title="var">V</span></span> contains at least two different values. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Theorem</span> <a name="not_naive_lookup_relateX"><span class="id" title="lemma">not_naive_lookup_relateX</span></a>:<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">v</span>, <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#32263a1c8b01baecdff9deb038955bc<sub>9</sub>"><span class="id" title="notation">≠</span></a> <a class="idref" href="SearchTree.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">¬</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span> , <a class="idref" href="SearchTree.html#AbsX"><span class="id" title="definition">AbsX</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a>  <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">)</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#AbsX"><span class="id" title="definition">AbsX</span></a>.<br/>
<span class="id" title="tactic">intros</span> <span class="id" title="var">v</span> <span class="id" title="var">H</span>.<br/>
<span class="id" title="tactic">intros</span> <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="tactic">pose</span> (<span class="id" title="var">bogus</span> := <a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> (<a class="idref" href="SearchTree.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a> 3 <span class="id" title="var">v</span> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>) 2 <span class="id" title="var">v</span> <a class="idref" href="SearchTree.html#E"><span class="id" title="constructor">E</span></a>).<br/>
<span class="id" title="tactic">pose</span> (<span class="id" title="var">m</span> := <span class="id" title="definition">t_update</span> (<span class="id" title="definition">t_update</span> (<span class="id" title="definition">t_empty</span> <a class="idref" href="SearchTree.html#TREES.default"><span class="id" title="variable">default</span></a>) 2 <span class="id" title="var">v</span>) 3 <span class="id" title="var">v</span>).<br/>
<span class="id" title="tactic">assert</span> (<a class="idref" href="SearchTree.html#list2map"><span class="id" title="definition">list2map</span></a> (<a class="idref" href="SearchTree.html#elements"><span class="id" title="definition">elements</span></a> <span class="id" title="var">bogus</span>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">m</span>).<br/>
&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
<span class="id" title="tactic">assert</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#611abc97cba304de784fa909dbdea1fa"><span class="id" title="notation">¬</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> 3 <span class="id" title="var">bogus</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a> <span class="id" title="var">m</span> 3). {<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <span class="id" title="var">bogus</span>, <span class="id" title="var">m</span>, <span class="id" title="definition">t_update</span>, <span class="id" title="definition">t_empty</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">H</span>.<br/>
}<br/>
</div>

<div class="doc">
Right here you see how it is proved.  <span class="inlinecode"><span class="id" title="var">bogus</span></span> is our old friend,
    the bogus tree that does not satisfy the <span class="inlinecode"><span class="id" title="var">SearchTree</span></span> property.
    <span class="inlinecode"><span class="id" title="var">m</span></span> is the <span class="inlinecode"><span class="id" title="var">total_map</span></span> that corresponds to the elements of <span class="inlinecode"><span class="id" title="var">bogus</span></span>.
    The <span class="inlinecode"><span class="id" title="var">lookup</span></span> function returns <span class="inlinecode"><span class="id" title="var">default</span></span> at key <span class="inlinecode">3</span>,
    but the map <span class="inlinecode"><span class="id" title="var">m</span></span> returns <span class="inlinecode"><span class="id" title="var">v</span></span> at key <span class="inlinecode">3</span>.  And yet, assumption <span class="inlinecode"><span class="id" title="var">H<sub>0</sub></span></span>
    claims that they should return the same thing. 
</div>
<div class="code">
<span class="id" title="tactic">apply</span> <span class="id" title="var">H<sub>2</sub></span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="tactic">apply</span> <span class="id" title="var">H<sub>1</sub></span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab87"></a><h4 class="section">练习：4 星, standard, optional (lookup_relateX)</h4>

</div>
<div class="code">
<span class="id" title="keyword">Theorem</span> <a name="lookup_relateX"><span class="id" title="lemma">lookup_relateX</span></a>:<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">t</span> <span class="id" title="var">cts</span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="SearchTree.html#SearchTree"><span class="id" title="inductive">SearchTree</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#AbsX"><span class="id" title="definition">AbsX</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="SearchTree.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="SearchTree.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c39bf18749e5cc609e83c0a0ba5a372"><span class="id" title="notation">=</span></a>  <a class="idref" href="SearchTree.html#cts"><span class="id" title="variable">cts</span></a> <a class="idref" href="SearchTree.html#k"><span class="id" title="variable">k</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
<span class="id" title="tactic">intros</span>.<br/>
<span class="id" title="tactic">unfold</span> <a class="idref" href="SearchTree.html#AbsX"><span class="id" title="definition">AbsX</span></a> <span class="id" title="tactic">in</span> <span class="id" title="var">H<sub>0</sub></span>. <span class="id" title="tactic">subst</span> <span class="id" title="var">cts</span>.<br/>
<span class="id" title="var">inv</span> <span class="id" title="var">H</span>. <span class="id" title="var">remember</span> 0 <span class="id" title="keyword">as</span> <span class="id" title="var">lo</span> <span class="id" title="tactic">in</span> <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="tactic">clear</span> - <span class="id" title="var">H<sub>0</sub></span>.<br/>
<span class="id" title="tactic">rewrite</span> <a class="idref" href="SearchTree.html#elements_slow_elements"><span class="id" title="axiom">elements_slow_elements</span></a>.<br/>
</div>

<div class="doc">
To prove this, you'll need to use this collection of facts:
   <span class="inlinecode"><span class="id" title="var">In_decidable</span></span>, <span class="inlinecode"><span class="id" title="var">list2map_app_left</span></span>, <span class="inlinecode"><span class="id" title="var">list2map_app_right</span></span>,
   <span class="inlinecode"><span class="id" title="var">list2map_not_in_default</span></span>, <span class="inlinecode"><span class="id" title="var">slow_elements_range</span></span>.  The point is,
   it's not very pretty. 
</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;请在此处解答&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab88"></a><h2 class="section">Coherence With <span class="inlinecode"><span class="id" title="var">elements</span></span> Instead of <span class="inlinecode"><span class="id" title="var">lookup</span></span></h2>
 The first definition of the abstraction relation, <span class="inlinecode"><span class="id" title="var">Abs</span></span>, is "coherent"
     with the <span class="inlinecode"><span class="id" title="var">lookup</span></span> operation, but not very coherent with the <span class="inlinecode"><span class="id" title="var">elements</span></span>
     operation.  That is, <span class="inlinecode"><span class="id" title="var">Abs</span></span> treats all trees, including ill-formed ones,
     much the way <span class="inlinecode"><span class="id" title="var">lookup</span></span> does, so it was easy to prove <span class="inlinecode"><span class="id" title="var">lookup_relate</span></span>.
     But it was harder to prove <span class="inlinecode"><span class="id" title="var">elements_relate</span></span>.

<div class="paragraph"> </div>

    The alternate abstraction relation, <span class="inlinecode"><span class="id" title="var">AbsX</span></span>, is coherent with <span class="inlinecode"><span class="id" title="var">elements</span></span>,
    but not very coherent with <span class="inlinecode"><span class="id" title="var">lookup</span></span>.  So proving <span class="inlinecode"><span class="id" title="var">elements_relateX</span></span> is
    trivial, but proving <span class="inlinecode"><span class="id" title="var">lookup_relate</span></span> is difficult.

<div class="paragraph"> </div>

    This kind of thing comes up frequently.  The important thing to remember
    is that you often have choices in formulating the abstraction relation,
    and the choice you make will affect the simplicity and elegance of your
    proofs.   If you find things getting too difficult, step back and reconsider
    your abstraction relation. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="SearchTree.html#TREES"><span class="id" title="section">TREES</span></a>.<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;2022-02-08&nbsp;06:47:28&nbsp;(UTC+00)&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>